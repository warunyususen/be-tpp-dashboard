<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BE-TPP Admin Dashboard - Smart Air Quality Control">
    <meta name="theme-color" content="#0A0A0F">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BE-TPP">
    <meta name="application-name" content="BE-TPP">
    <meta name="msapplication-TileColor" content="#0A0A0F">
    <meta name="msapplication-config" content="none">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <title>BE-TPP // Admin Dashboard</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- MQTT.js Library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <!-- ECharts Library -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        /* ============================================
           BE-TPP ADMIN DASHBOARD - PHASE 9
           Control Center Polish + v1.9.5
           ============================================ */
        
        :root {
            --neon-cyan: #00F0FF;
            --neon-cyan-glow: rgba(0, 240, 255, 0.5);
            --neon-cyan-subtle: rgba(0, 240, 255, 0.1);
            --neon-magenta: #FF00E5;
            --neon-magenta-glow: rgba(255, 0, 229, 0.5);
            --neon-magenta-subtle: rgba(255, 0, 229, 0.1);
            --neon-yellow: #FFE600;
            --bg-void: #0A0A0F;
            --bg-surface: #12121A;
            --bg-elevated: #1A1A25;
            --text-primary: #F0F0F5;
            --text-secondary: #A0A0B0;
            --text-muted: #606070;
            --border-default: rgba(255, 255, 255, 0.1);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --status-success: #00FF9F;
            --status-warning: #FFB800;
            --status-danger: #FF3366;
            --gradient-primary: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --text-xs: 0.75rem; --text-sm: 0.875rem; --text-base: 1rem; --text-lg: 1.125rem; --text-xl: 1.25rem; --text-2xl: 1.5rem; --text-3xl: 2rem;
            --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem; --space-5: 1.25rem; --space-6: 1.5rem; --space-8: 2rem;
            --header-height: 64px; --sidebar-width: 260px; --sidebar-collapsed: 72px;
            --transition-fast: 150ms ease; --transition-base: 250ms ease;
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px;
        }
        
        [data-theme="light"] {
            --bg-void: #F5F7FA; --bg-surface: #FFFFFF; --bg-elevated: #F8FAFC;
            --text-primary: #1A1A2E; --text-secondary: #4A4A5A; --text-muted: #8A8A9A;
            --border-default: rgba(0, 0, 0, 0.1); --border-subtle: rgba(0, 0, 0, 0.06);
            --neon-cyan: #0891B2; --neon-cyan-glow: rgba(8, 145, 178, 0.3); --neon-cyan-subtle: rgba(8, 145, 178, 0.1);
            --neon-magenta: #C026D3; --neon-magenta-glow: rgba(192, 38, 211, 0.3);
        }
        
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: var(--font-body); font-size: var(--text-base); line-height: 1.6; color: var(--text-primary); background: var(--bg-void); min-height: 100vh; overflow-x: hidden; }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 700; line-height: 1.2; letter-spacing: 0.05em; text-transform: uppercase; }
        
        /* Background Grid */
        .bg-grid { position: fixed; inset: 0; background-image: linear-gradient(rgba(0, 240, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 240, 255, 0.02) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; z-index: 0; }
        
        /* Particle Effects */
        .particles { position: fixed; inset: 0; pointer-events: none; z-index: 1; overflow: hidden; }
        .particle { position: absolute; width: 2px; height: 2px; background: var(--neon-cyan); border-radius: 50%; opacity: 0; animation: particle-float 8s infinite; box-shadow: 0 0 6px var(--neon-cyan), 0 0 12px var(--neon-cyan-glow); }
        .particle:nth-child(even) { background: var(--neon-magenta); box-shadow: 0 0 6px var(--neon-magenta), 0 0 12px var(--neon-magenta-glow); animation-duration: 10s; }
        .particle:nth-child(3n) { width: 3px; height: 3px; animation-duration: 12s; }
        @keyframes particle-float { 0% { opacity: 0; transform: translateY(100vh) translateX(0); } 10% { opacity: 0.8; } 90% { opacity: 0.8; } 100% { opacity: 0; transform: translateY(-100vh) translateX(50px); } }
        .particle:nth-child(1) { left: 5%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 15%; animation-delay: 1s; }
        .particle:nth-child(3) { left: 25%; animation-delay: 2s; }
        .particle:nth-child(4) { left: 35%; animation-delay: 0.5s; }
        .particle:nth-child(5) { left: 45%; animation-delay: 1.5s; }
        .particle:nth-child(6) { left: 55%; animation-delay: 2.5s; }
        .particle:nth-child(7) { left: 65%; animation-delay: 3s; }
        .particle:nth-child(8) { left: 75%; animation-delay: 0.8s; }
        .particle:nth-child(9) { left: 85%; animation-delay: 1.8s; }
        .particle:nth-child(10) { left: 95%; animation-delay: 2.8s; }
        [data-theme="light"] .particles { opacity: 0.4; }
        
        /* Scan Line Effect */
        .scanline { position: fixed; inset: 0; pointer-events: none; z-index: 2; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.03) 2px, rgba(0, 0, 0, 0.03) 4px); }
        .scanline::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 100px; background: linear-gradient(to bottom, transparent, rgba(0, 240, 255, 0.03), transparent); animation: scanline-move 8s linear infinite; }
        @keyframes scanline-move { 0% { transform: translateY(-100px); } 100% { transform: translateY(100vh); } }
        [data-theme="light"] .scanline { opacity: 0.3; }
        
        /* App Layout */
        .app { display: flex; min-height: 100vh; }
        
        /* ============================================
           SIDEBAR
           ============================================ */
        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; background: var(--bg-surface); border-right: 1px solid var(--border-default); display: flex; flex-direction: column; z-index: 100; transition: width var(--transition-base), transform var(--transition-base); }
        .sidebar.collapsed { width: var(--sidebar-collapsed); }
        .sidebar.collapsed .sidebar-logo-text, .sidebar.collapsed .nav-label, .sidebar.collapsed .nav-section-title, .sidebar.collapsed .user-info { opacity: 0; visibility: hidden; width: 0; }
        .sidebar.collapsed .sidebar-header { justify-content: center; padding: var(--space-3); }
        .sidebar.collapsed .sidebar-logo { display: none; }
        .sidebar.collapsed .sidebar-toggle { margin: 0 auto; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: var(--space-3); }
        .sidebar.collapsed .nav-icon { margin-right: 0; }
        
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-4); border-bottom: 1px solid var(--border-subtle); min-height: var(--header-height); }
        .sidebar-logo { display: flex; align-items: center; gap: var(--space-3); text-decoration: none; }
        .sidebar-logo-icon { width: 36px; height: 36px; stroke: var(--neon-cyan); stroke-width: 2; fill: none; filter: drop-shadow(0 0 5px var(--neon-cyan-glow)); }
        .sidebar-logo-text { font-family: var(--font-display); font-size: var(--text-lg); font-weight: 800; letter-spacing: 0.1em; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; white-space: nowrap; transition: opacity var(--transition-base), width var(--transition-base); }
        .sidebar-toggle { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; transition: all var(--transition-fast); flex-shrink: 0; }
        .sidebar-toggle:hover { color: var(--neon-cyan); border-color: var(--neon-cyan); }
        .sidebar-toggle svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; transition: transform var(--transition-base); }
        .sidebar.collapsed .sidebar-toggle svg { transform: rotate(180deg); }
        
        .sidebar-nav { flex: 1; overflow-y: auto; padding: var(--space-4); }
        .nav-section { margin-bottom: var(--space-6); }
        .nav-section-title { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: var(--space-3); padding-left: var(--space-3); white-space: nowrap; transition: opacity var(--transition-base); }
        .nav-list { list-style: none; display: flex; flex-direction: column; gap: var(--space-1); }
        .nav-item { display: flex; align-items: center; padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); color: var(--text-secondary); text-decoration: none; cursor: pointer; transition: all var(--transition-fast); position: relative; }
        .nav-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--neon-cyan); transform: scaleY(0); transition: transform var(--transition-fast); }
        .nav-item:hover { color: var(--text-primary); background: var(--bg-elevated); }
        .nav-item.active { color: var(--neon-cyan); background: var(--neon-cyan-subtle); }
        .nav-item.active::before { transform: scaleY(1); }
        /* B.1: Active feedback */
        .nav-item:active { transform: scale(0.98); transition-duration: 50ms; }
        /* B.4: Focus ring */
        .nav-item:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: -2px; }
        
        .nav-icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; margin-right: var(--space-3); flex-shrink: 0; }
        .nav-label { font-size: var(--text-sm); font-weight: 500; white-space: nowrap; transition: opacity var(--transition-base), width var(--transition-base); }
        
        .sidebar-footer { padding: var(--space-4); border-top: 1px solid var(--border-subtle); }
        .user-card { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--bg-elevated); border-radius: var(--radius-md); cursor: pointer; overflow: hidden; transition: all var(--transition-base); }
        .user-avatar { width: 36px; height: 36px; min-width: 36px; min-height: 36px; background: var(--gradient-primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: var(--text-sm); font-weight: 700; color: var(--bg-void); flex-shrink: 0; aspect-ratio: 1; }
        .user-info { flex: 1; min-width: 0; overflow: hidden; transition: opacity var(--transition-base), width var(--transition-base); }
        .user-name { font-size: var(--text-sm); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: var(--text-xs); color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar.collapsed .user-card { justify-content: center; padding: var(--space-2); gap: 0; }
        .sidebar.collapsed .user-avatar { margin: 0; }
        
        /* ============================================
           MAIN CONTENT
           ============================================ */
        .main { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; transition: margin-left var(--transition-base); }
        .sidebar.collapsed ~ .main { margin-left: var(--sidebar-collapsed); }
        
        .header { position: sticky; top: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 var(--space-6); height: var(--header-height); background: var(--bg-surface); border-bottom: 1px solid var(--border-default); z-index: 50; }
        .header-left { display: flex; align-items: center; gap: var(--space-4); }
        .page-title { font-size: var(--text-lg); position: relative; padding: var(--space-2) var(--space-4); }
        .page-title::before, .page-title::after { content: ''; position: absolute; width: 8px; height: 8px; border-color: var(--neon-cyan); border-style: solid; }
        .page-title::before { top: 0; left: 0; border-width: 2px 0 0 2px; }
        .page-title::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; }
        .header-right { display: flex; align-items: center; gap: var(--space-3); }
        .header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); }
        .header-btn:hover { color: var(--neon-cyan); border-color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan-glow); }
        .header-btn:active { transform: scale(0.95); transition-duration: 50ms; }
        .header-btn:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: 2px; }
        .header-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
        .theme-toggle { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); }
        .theme-toggle:hover { color: var(--neon-yellow); border-color: var(--neon-yellow); }
        .theme-toggle:active { transform: scale(0.95); transition-duration: 50ms; }
        .theme-toggle:focus-visible { outline: 2px solid var(--neon-yellow); outline-offset: 2px; }
        .theme-toggle svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
        .theme-toggle .icon-moon { display: none; }
        [data-theme="light"] .theme-toggle .icon-sun { display: none; }
        [data-theme="light"] .theme-toggle .icon-moon { display: block; }
        
        .content { flex: 1; padding: var(--space-6); position: relative; z-index: 3; }
        .tab-panel { display: none; animation: fadeIn 0.3s ease; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ============================================
           CARDS
           ============================================ */
        .card { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--space-6); position: relative; }
        .card::before, .card::after { content: ''; position: absolute; width: 12px; height: 12px; border-color: var(--neon-cyan); border-style: solid; opacity: 0.5; transition: opacity var(--transition-fast); }
        .card::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; border-radius: var(--radius-lg) 0 0 0; }
        .card::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; border-radius: 0 0 var(--radius-lg) 0; }
        .card:hover::before, .card:hover::after { opacity: 1; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-5); }
        .card-title { font-size: var(--text-base); font-weight: 600; display: flex; align-items: center; gap: var(--space-2); }
        .card-title svg { width: 20px; height: 20px; stroke: var(--neon-cyan); stroke-width: 2; fill: none; }
        
        /* Connection Panel */
        .connection-panel { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-6); position: relative; }
        .connection-panel::before, .connection-panel::after { content: ''; position: absolute; width: 16px; height: 16px; border-color: var(--neon-cyan); border-style: solid; opacity: 0.7; }
        .connection-panel::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
        .connection-panel::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }
        .connection-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--space-4); margin-bottom: var(--space-4); }
        .connection-status { display: flex; align-items: center; gap: var(--space-3); }
        .status-indicator { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--bg-elevated); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: var(--text-xs); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--status-danger); }
        .status-dot.online { background: var(--status-success); box-shadow: 0 0 8px var(--status-success); animation: pulse-dot 2s infinite; }
        .status-dot.connecting { background: var(--status-warning); animation: pulse-dot 0.5s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Phase 7: Internet Status Icon */
        .internet-icon { color: var(--status-danger); transition: color var(--transition-fast); }
        .internet-icon.online { color: var(--status-success); }
        .internet-icon.offline { color: var(--status-danger); }
        .internet-icon.checking { color: var(--status-warning); animation: icon-pulse 1s ease-in-out infinite; }
        @keyframes icon-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        /* Phase 7: Signal Bars */
        .signal-bars { display: flex; align-items: flex-end; gap: 2px; height: 16px; }
        .signal-bar { width: 4px; background: var(--border-default); border-radius: 1px; transition: background var(--transition-fast); }
        .signal-bar[data-level="1"] { height: 25%; }
        .signal-bar[data-level="2"] { height: 50%; }
        .signal-bar[data-level="3"] { height: 75%; }
        .signal-bar[data-level="4"] { height: 100%; }
        .signal-bars.excellent .signal-bar { background: var(--status-success); }
        .signal-bars.good .signal-bar[data-level="1"],
        .signal-bars.good .signal-bar[data-level="2"],
        .signal-bars.good .signal-bar[data-level="3"] { background: var(--status-success); }
        .signal-bars.fair .signal-bar[data-level="1"],
        .signal-bars.fair .signal-bar[data-level="2"] { background: var(--status-warning); }
        .signal-bars.weak .signal-bar[data-level="1"] { background: var(--status-danger); }
        .signal-bars.none .signal-bar { background: var(--border-default); }
        
        /* Phase 7: Reconnect Countdown */
        .reconnect-countdown { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--status-warning); margin-left: var(--space-2); }
        
        /* ============================================
           Phase 12: PWA Install & Offline Styles
           ============================================ */
        
        /* PWA Install Button */
        .pwa-install-btn {
            display: none;
            padding: var(--space-2) var(--space-3);
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-void);
            font-family: var(--font-display);
            font-size: var(--text-xs);
            font-weight: 600;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all var(--transition-fast);
            align-items: center;
            gap: var(--space-2);
        }
        .pwa-install-btn.show { display: flex; }
        .pwa-install-btn:hover { 
            box-shadow: 0 0 20px var(--neon-cyan-glow); 
            transform: translateY(-1px); 
        }
        .pwa-install-btn:active { transform: scale(0.97); }
        .pwa-install-btn svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 2; fill: none; }
        
        /* PWA Offline Banner */
        .pwa-offline-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--space-3) var(--space-4);
            background: linear-gradient(135deg, rgba(255, 51, 102, 0.95), rgba(255, 100, 50, 0.95));
            color: white;
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            text-align: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }
        .pwa-offline-banner.show { display: flex; align-items: center; justify-content: center; gap: var(--space-3); }
        .pwa-offline-banner svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* PWA Update Banner */
        .pwa-update-banner {
            display: none;
            position: fixed;
            top: calc(var(--header-height) + var(--space-4));
            right: var(--space-4);
            padding: var(--space-3) var(--space-4);
            background: var(--bg-surface);
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: var(--text-sm);
            z-index: 9998;
            box-shadow: 0 4px 20px rgba(0, 240, 255, 0.2);
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }
        .pwa-update-banner.show { display: block; }
        .pwa-update-banner-content { display: flex; flex-direction: column; gap: var(--space-2); }
        .pwa-update-banner-title { font-family: var(--font-display); font-size: var(--text-sm); color: var(--neon-cyan); }
        .pwa-update-banner-actions { display: flex; gap: var(--space-2); margin-top: var(--space-2); }
        .pwa-update-banner .btn { padding: var(--space-1) var(--space-3); font-size: var(--text-xs); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* PWA Standalone Mode Adjustments */
        @media (display-mode: standalone) {
            .pwa-install-btn { display: none !important; }
        }
        
        .connection-actions { display: flex; gap: var(--space-2); }
        
        /* Buttons */
        .btn { padding: var(--space-2) var(--space-4); font-family: var(--font-display); font-size: var(--text-xs); font-weight: 600; letter-spacing: 0.05em; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; justify-content: center; gap: var(--space-2); }
        .btn svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 2; fill: none; }
        .btn-primary { background: var(--gradient-primary); border: none; color: var(--bg-void); }
        .btn-primary:hover { box-shadow: 0 0 20px var(--neon-cyan-glow); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-ghost { background: transparent; border: 1px solid var(--border-default); color: var(--text-secondary); }
        .btn-ghost:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
        .btn-ghost:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: var(--status-danger); border: none; color: white; }
        .btn-danger:hover { box-shadow: 0 0 20px rgba(255, 51, 102, 0.4); transform: translateY(-1px); }
        
        /* ============================================
           Phase B.1: Button :active Feedback
           ============================================ */
        .btn:active:not(:disabled) { transform: scale(0.97); transition-duration: 50ms; }
        .btn-primary:active:not(:disabled) { transform: scale(0.97); box-shadow: 0 0 10px var(--neon-cyan-glow); }
        .btn-ghost:active:not(:disabled) { transform: scale(0.97); background: var(--neon-cyan-subtle); }
        .btn-danger:active:not(:disabled) { transform: scale(0.97); box-shadow: 0 0 10px rgba(255, 51, 102, 0.3); }
        
        /* B.4: Focus Ring Accessibility */
        .btn:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: 2px; }
        .btn-danger:focus-visible { outline-color: var(--status-danger); }
        
        .connection-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); }
        .form-group { display: flex; flex-direction: column; gap: var(--space-2); }
        .form-label { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase; }
        .form-input { padding: var(--space-3); font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text-primary); background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-md); outline: none; transition: all var(--transition-fast); }
        .form-input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 0 2px var(--neon-cyan-subtle); }
        .form-input[readonly] { opacity: 0.7; cursor: not-allowed; background: var(--bg-void); }
        
        /* Grid */
        .bento-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-4); }
        .bento-grid .span-2 { grid-column: span 2; }
        .bento-grid .span-4 { grid-column: span 4; }
        @media (max-width: 1200px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } .bento-grid .span-4 { grid-column: span 2; } }
        @media (max-width: 768px) { .bento-grid { grid-template-columns: 1fr; } .bento-grid .span-2, .bento-grid .span-4 { grid-column: span 1; } }
        
        /* Stats */
        .stat-card { display: flex; flex-direction: column; padding: var(--space-5); }
        .stat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3); }
        .stat-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--neon-cyan-subtle); border-radius: var(--radius-md); }
        .stat-icon svg { width: 22px; height: 22px; stroke: var(--neon-cyan); stroke-width: 2; fill: none; }
        .stat-icon.magenta { background: var(--neon-magenta-subtle); }
        .stat-icon.magenta svg { stroke: var(--neon-magenta); }
        .stat-icon.green { background: rgba(0, 255, 159, 0.1); }
        .stat-icon.green svg { stroke: var(--status-success); }
        .stat-icon.yellow { background: rgba(255, 230, 0, 0.1); }
        .stat-icon.yellow svg { stroke: var(--neon-yellow); }
        .stat-badge { padding: 2px 8px; font-family: var(--font-mono); font-size: var(--text-xs); border-radius: var(--radius-sm); text-transform: uppercase; }
        .stat-badge.online { background: rgba(0, 255, 159, 0.2); color: var(--status-success); }
        .stat-badge.offline { background: rgba(255, 51, 102, 0.2); color: var(--status-danger); }
        .stat-badge.auto { background: var(--neon-cyan-subtle); color: var(--neon-cyan); }
        .stat-badge.custom { background: var(--neon-magenta-subtle); color: var(--neon-magenta); }
        /* Phase 9.3: Fan State Badges */
        .stat-badges { display: flex; gap: 4px; flex-wrap: wrap; }
        .stat-badge.fan-state { font-size: 0.65rem; padding: 1px 6px; }
        .stat-badge.fan-state.pressurise { background: rgba(0, 255, 159, 0.2); color: var(--status-success); }
        .stat-badge.fan-state.boost { background: rgba(255, 184, 0, 0.2); color: var(--status-warning); }
        .stat-badge.fan-state.purge { background: rgba(255, 100, 50, 0.2); color: #FF6432; }
        
        /* Phase 6.2: ESP Temp Warning Styles */
        .esp-temp-warn .data-value { color: var(--status-warning); }
        .esp-temp-danger .data-value { color: #FF6B35; animation: pulse-warning 1s infinite; }
        .esp-temp-critical .data-value { color: var(--status-danger); animation: pulse-danger 0.5s infinite; }
        @keyframes pulse-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes pulse-danger { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .stat-value { font-family: var(--font-mono); font-size: var(--text-3xl); font-weight: 700; line-height: 1; margin-bottom: var(--space-2); }
        .stat-value .unit { font-size: var(--text-lg); color: var(--text-muted); margin-left: var(--space-1); }
        .stat-label { font-size: var(--text-sm); color: var(--text-muted); }
        
        /* ============================================
           Phase B.2: Skeleton Loader Animation
           ============================================ */
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Skeleton base class */
        .skeleton {
            background: linear-gradient(90deg, 
                var(--bg-elevated) 0%, 
                var(--bg-surface) 20%, 
                var(--bg-elevated) 40%, 
                var(--bg-elevated) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-sm);
        }
        
        /* Skeleton for stat values */
        .stat-value.loading {
            color: transparent !important;
            background: linear-gradient(90deg, 
                var(--bg-elevated) 0%, 
                var(--bg-surface) 20%, 
                var(--bg-elevated) 40%, 
                var(--bg-elevated) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-sm);
            min-width: 80px;
            min-height: 32px;
        }
        .stat-value.loading .unit { display: none; }
        
        /* Skeleton for stat badges */
        .stat-badge.loading {
            color: transparent !important;
            background: linear-gradient(90deg, 
                var(--bg-elevated) 0%, 
                var(--bg-surface) 20%, 
                var(--bg-elevated) 40%, 
                var(--bg-elevated) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            min-width: 60px;
        }
        
        /* Skeleton for chart containers */
        .chart-container.loading {
            position: relative;
        }
        .chart-container.loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, 
                var(--bg-elevated) 0%, 
                var(--bg-surface) 20%, 
                var(--bg-elevated) 40%, 
                var(--bg-elevated) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-md);
            z-index: 1;
        }
        
        /* ============================================
           Phase B.3: Overview Empty State
           ============================================ */
        .overview-empty-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
            background: var(--bg-surface);
            border: 2px dashed var(--border-default);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
        }
        .overview-empty-state.show {
            display: flex;
        }
        .overview-empty-icon {
            width: 64px;
            height: 64px;
            stroke: var(--text-muted);
            stroke-width: 1.5;
            fill: none;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }
        .overview-empty-title {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .overview-empty-text {
            font-size: var(--text-sm);
            color: var(--text-muted);
            margin-bottom: var(--space-4);
            max-width: 300px;
        }
        .overview-empty-hint {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--neon-cyan);
            padding: var(--space-2) var(--space-3);
            background: var(--neon-cyan-subtle);
            border-radius: var(--radius-sm);
        }
        
        /* Phase 9.3: EMA Value display */
        .ema-value { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); opacity: 0.7; margin-top: 2px; }
        
        /* Sensor Cards */
        .section-header { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-4) 0; color: var(--text-muted); font-family: var(--font-mono); font-size: var(--text-xs); text-transform: uppercase; letter-spacing: 0.1em; }
        .section-header svg { width: 16px; height: 16px; stroke: var(--neon-cyan); stroke-width: 2; fill: none; }
        .section-line { flex: 1; height: 1px; background: linear-gradient(90deg, var(--border-default), transparent); }
        .sensor-timestamp { color: var(--text-muted); font-size: var(--text-xs); }
        /* Phase 9.3: Sensor Age Badge */
        .sensor-age-badge { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: var(--radius-sm); background: var(--bg-elevated); cursor: pointer; margin-left: 8px; font-family: var(--font-mono); font-size: 0.7rem; transition: all var(--transition-fast); position: relative; }
        .sensor-age-badge:hover { background: var(--bg-surface); }
        .sensor-age-badge .age-text { color: var(--text-secondary); }
        .sensor-age-badge .age-status { padding: 1px 4px; border-radius: 2px; font-size: 0.6rem; font-weight: 600; }
        .sensor-age-badge.fresh .age-status { background: rgba(0, 255, 159, 0.2); color: var(--status-success); }
        .sensor-age-badge.aging .age-status { background: rgba(255, 184, 0, 0.2); color: var(--status-warning); }
        .sensor-age-badge.stale .age-status { background: rgba(255, 51, 102, 0.2); color: var(--status-danger); }
        .sensor-age-badge.failsafe .age-status { background: rgba(255, 51, 102, 0.4); color: #FF3366; animation: pulse-danger 1s infinite; }
        @keyframes pulse-danger { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Sensor Age Tooltip */
        .sensor-age-tooltip { position: absolute; top: 100%; right: 0; margin-top: 8px; padding: 10px 12px; background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-md); font-size: 0.75rem; white-space: nowrap; z-index: 100; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .sensor-age-badge.show-tooltip .sensor-age-tooltip { display: block; }
        .sensor-age-tooltip .tooltip-row { display: flex; justify-content: space-between; gap: 16px; padding: 3px 0; }
        .sensor-age-tooltip .tooltip-label { color: var(--text-muted); }
        .sensor-age-tooltip .tooltip-value { color: var(--text-primary); font-family: var(--font-mono); }
        /* Phase 9.3: Heap color coding */
        .heap-good { color: var(--status-success) !important; }
        .heap-warning { color: var(--status-warning) !important; }
        .heap-danger { color: var(--status-danger) !important; }
        .sensor-card { transition: all var(--transition-fast); }
        .sensor-card:hover { border-color: var(--neon-cyan); box-shadow: 0 0 20px var(--neon-cyan-subtle); }
        .sensor-card.good { border-color: var(--status-success); }
        .sensor-card.good::before, .sensor-card.good::after { border-color: var(--status-success); }
        .sensor-card.moderate { border-color: var(--status-warning); }
        .sensor-card.moderate::before, .sensor-card.moderate::after { border-color: var(--status-warning); }
        .sensor-card.unhealthy { border-color: var(--status-danger); }
        .sensor-card.unhealthy::before, .sensor-card.unhealthy::after { border-color: var(--status-danger); }
        
        .sensor-icon { background: rgba(0, 200, 255, 0.1); }
        .sensor-icon svg { stroke: #00C8FF; }
        .sensor-icon.co2 { background: rgba(100, 220, 100, 0.1); }
        .sensor-icon.co2 svg { stroke: #64DC64; }
        .sensor-icon.temp { background: rgba(255, 150, 50, 0.1); }
        .sensor-icon.temp svg { stroke: #FF9632; }
        .sensor-icon.humidity { background: rgba(50, 150, 255, 0.1); }
        .sensor-icon.humidity svg { stroke: #3296FF; }
        .sensor-icon.pm10 { background: rgba(180, 130, 255, 0.1); }
        .sensor-icon.pm10 svg { stroke: #B482FF; }
        .sensor-icon.tvoc { background: rgba(255, 100, 150, 0.1); }
        .sensor-icon.tvoc svg { stroke: #FF6496; }
        .sensor-icon.noise { background: rgba(255, 200, 50, 0.1); }
        .sensor-icon.noise svg { stroke: #FFC832; }
        .sensor-icon.status { background: rgba(0, 240, 255, 0.1); }
        .sensor-icon.status svg { stroke: var(--neon-cyan); }
        
        .quality-badge { padding: 2px 8px; font-family: var(--font-mono); font-size: var(--text-xs); border-radius: var(--radius-sm); text-transform: uppercase; font-weight: 600; }
        .quality-badge.good { background: rgba(0, 255, 159, 0.2); color: var(--status-success); }
        .quality-badge.moderate { background: rgba(255, 184, 0, 0.2); color: var(--status-warning); }
        .quality-badge.unhealthy { background: rgba(255, 51, 102, 0.2); color: var(--status-danger); }
        
        .sensor-bar { height: 4px; background: var(--bg-elevated); border-radius: 2px; margin-top: var(--space-3); overflow: hidden; }
        .sensor-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease, background 0.3s ease; width: 0%; background: var(--status-success); }
        .sensor-bar-fill.moderate { background: var(--status-warning); }
        .sensor-bar-fill.unhealthy { background: var(--status-danger); }
        
        /* Charts */
        .chart-card { padding: var(--space-4); }
        .chart-container { height: 200px; width: 100%; }
        .chart-container.chart-wide { height: 180px; }
        .chart-badge { padding: 2px 8px; font-family: var(--font-mono); font-size: var(--text-xs); background: var(--neon-cyan-subtle); color: var(--neon-cyan); border-radius: var(--radius-sm); }
        .chart-info { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--neon-cyan); }
        @media (max-width: 768px) { .chart-container { height: 180px; } .chart-container.chart-wide { height: 160px; } }
        
        /* Control */
        .control-section { margin-bottom: var(--space-6); }
        .control-section-title { font-size: var(--text-sm); color: var(--text-muted); margin-bottom: var(--space-4); }
        .control-buttons { display: flex; gap: var(--space-3); flex-wrap: wrap; }
        .control-btn { flex: 1; min-width: 100px; padding: var(--space-4); font-family: var(--font-display); font-size: var(--text-sm); font-weight: 600; text-align: center; background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); }
        .control-btn:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); }
        .control-btn.active { border-color: var(--neon-cyan); background: var(--neon-cyan-subtle); color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan-glow); }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* B.1: Active feedback */
        .control-btn:active:not(:disabled) { transform: scale(0.97); transition-duration: 50ms; }
        /* B.4: Focus ring */
        .control-btn:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: 2px; }
        
        .speed-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: var(--space-2); }
        .speed-btn { padding: var(--space-3); font-family: var(--font-mono); font-size: var(--text-sm); font-weight: 600; text-align: center; background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); }
        .speed-btn:hover { border-color: var(--neon-magenta); color: var(--neon-magenta); }
        .speed-btn.active { border-color: var(--neon-magenta); background: var(--neon-magenta-subtle); color: var(--neon-magenta); box-shadow: 0 0 15px var(--neon-magenta-glow); }
        .speed-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* B.1: Active feedback */
        .speed-btn:active:not(:disabled) { transform: scale(0.95); transition-duration: 50ms; box-shadow: 0 0 8px var(--neon-magenta-glow); }
        /* B.4: Focus ring */
        .speed-btn:focus-visible { outline: 2px solid var(--neon-magenta); outline-offset: 2px; }
        
        /* Phase 9: Mode Toggle Switch (iOS-style) */
        .mode-toggle-container { display: flex; align-items: center; justify-content: center; gap: var(--space-4); padding: var(--space-4) 0; }
        .mode-toggle-label { font-family: var(--font-display); font-size: var(--text-sm); font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; transition: color var(--transition-fast); }
        .mode-toggle-label.active { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan-glow); }
        .mode-toggle { position: relative; width: 80px; height: 40px; background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: 20px; cursor: pointer; transition: all var(--transition-base); }
        .mode-toggle:hover { border-color: var(--neon-cyan); }
        .mode-toggle.custom { border-color: var(--neon-magenta); }
        .mode-toggle-knob { position: absolute; top: 4px; left: 4px; width: 28px; height: 28px; background: var(--neon-cyan); border-radius: 50%; transition: all var(--transition-base); box-shadow: 0 0 10px var(--neon-cyan-glow); }
        .mode-toggle.custom .mode-toggle-knob { left: calc(100% - 32px); background: var(--neon-magenta); box-shadow: 0 0 10px var(--neon-magenta-glow); }
        /* B.1: Active feedback */
        .mode-toggle:active { transform: scale(0.97); transition-duration: 50ms; }
        /* B.4: Focus ring */
        .mode-toggle:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: 2px; }
        
        /* Phase 9: Speed Slider */
        .speed-slider-container { margin-top: var(--space-4); padding: var(--space-3) 0; }
        .speed-slider-track { position: relative; height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: visible; }
        .speed-slider-fill { position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta)); border-radius: 4px; transition: width var(--transition-fast); }
        .speed-slider-knob { position: absolute; top: 50%; width: 24px; height: 24px; background: var(--bg-surface); border: 3px solid var(--neon-magenta); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--neon-magenta-glow), 0 2px 8px rgba(0,0,0,0.3); transition: left var(--transition-fast), box-shadow var(--transition-fast); }
        .speed-slider-knob:hover { box-shadow: 0 0 25px var(--neon-magenta-glow), 0 2px 12px rgba(0,0,0,0.4); }
        .speed-slider-value { text-align: center; margin-top: var(--space-3); font-family: var(--font-mono); font-size: var(--text-2xl); font-weight: 700; color: var(--neon-magenta); text-shadow: 0 0 10px var(--neon-magenta-glow); }
        .speed-slider-labels { display: flex; justify-content: space-between; margin-top: var(--space-2); font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-muted); }
        
        /* Phase 9: Quick Actions */
        .quick-actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); }
        .quick-action-btn { display: flex; flex-direction: column; align-items: center; gap: var(--space-2); padding: var(--space-4); background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-lg); cursor: pointer; transition: all var(--transition-fast); }
        .quick-action-btn:hover { border-color: var(--neon-cyan); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0, 240, 255, 0.2); }
        .quick-action-btn.active { border-color: var(--neon-cyan); background: var(--neon-cyan-subtle); }
        .quick-action-btn .qa-icon { font-size: 1.5rem; line-height: 1; }
        .quick-action-btn .qa-label { font-family: var(--font-display); font-size: var(--text-xs); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .quick-action-btn:hover .qa-label { color: var(--neon-cyan); }
        .quick-action-btn.active .qa-label { color: var(--neon-cyan); }
        /* Quick Action specific colors */
        .quick-action-btn.qa-off:hover, .quick-action-btn.qa-off.active { border-color: var(--status-danger); }
        .quick-action-btn.qa-off:hover .qa-label, .quick-action-btn.qa-off.active .qa-label { color: var(--status-danger); }
        .quick-action-btn.qa-sleep:hover, .quick-action-btn.qa-sleep.active { border-color: #9D8DF1; }
        .quick-action-btn.qa-sleep:hover .qa-label, .quick-action-btn.qa-sleep.active .qa-label { color: #9D8DF1; }
        .quick-action-btn.qa-eco:hover, .quick-action-btn.qa-eco.active { border-color: var(--status-success); }
        .quick-action-btn.qa-eco:hover .qa-label, .quick-action-btn.qa-eco.active .qa-label { color: var(--status-success); }
        .quick-action-btn.qa-turbo:hover, .quick-action-btn.qa-turbo.active { border-color: var(--neon-magenta); }
        .quick-action-btn.qa-turbo:hover .qa-label, .quick-action-btn.qa-turbo.active .qa-label { color: var(--neon-magenta); }
        /* B.1: Active feedback for quick actions */
        .quick-action-btn:active:not(:disabled) { transform: scale(0.97) translateY(0); transition-duration: 50ms; }
        /* B.4: Focus ring */
        .quick-action-btn:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: 2px; }
        
        /* Phase 9: System Section */
        .system-actions { display: flex; justify-content: center; padding: var(--space-4) 0; }
        .system-actions .btn-danger { min-width: 200px; justify-content: center; }
        
        /* Phase 9.4: Diagnostic Panel */
        .diag-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); }
        .diag-btn { display: flex; flex-direction: column; align-items: center; gap: var(--space-2); padding: var(--space-4); background: var(--bg-elevated); border: 2px solid var(--border-default); border-radius: var(--radius-lg); cursor: pointer; transition: all var(--transition-fast); }
        .diag-btn:hover { border-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan-glow); }
        .diag-btn:active { transform: scale(0.97); }
        .diag-btn:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: 2px; }
        .diag-btn.danger { border-color: var(--status-danger); }
        .diag-btn.danger:hover { box-shadow: 0 0 15px rgba(255, 51, 102, 0.4); }
        .diag-btn svg { width: 24px; height: 24px; stroke: var(--neon-cyan); stroke-width: 2; fill: none; }
        .diag-btn.danger svg { stroke: var(--status-danger); }
        .diag-btn-label { font-family: var(--font-display); font-size: var(--text-xs); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .diag-btn.danger .diag-btn-label { color: var(--status-danger); }
        .diag-result { margin-top: var(--space-4); padding: var(--space-3); background: var(--bg-elevated); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: space-between; }
        .diag-result-label { font-size: var(--text-sm); color: var(--text-muted); }
        .diag-result-value { font-family: var(--font-mono); font-size: var(--text-sm); color: var(--neon-cyan); }
        .diag-result-value.pending { color: var(--text-muted); }
        .diag-result-value.success { color: var(--status-success); }
        .diag-result-value.error { color: var(--status-danger); }
        
        /* Diagnostic Modal */
        .diag-modal-content { max-height: 60vh; overflow-y: auto; }
        .diag-json { background: var(--bg-void); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--space-4); font-family: var(--font-mono); font-size: var(--text-xs); white-space: pre-wrap; word-break: break-all; max-height: 400px; overflow-y: auto; }
        .diag-json-key { color: var(--neon-cyan); }
        .diag-json-string { color: var(--status-success); }
        .diag-json-number { color: var(--neon-magenta); }
        .diag-json-boolean { color: var(--neon-yellow); }
        .diag-modal-actions { display: flex; gap: var(--space-3); margin-top: var(--space-4); justify-content: flex-end; }
        
        /* Factory Reset Warning */
        .factory-reset-warning { display: flex; align-items: flex-start; gap: var(--space-3); padding: var(--space-4); background: rgba(255, 51, 102, 0.1); border: 1px solid var(--status-danger); border-radius: var(--radius-md); margin-bottom: var(--space-4); }
        .factory-reset-warning svg { width: 24px; height: 24px; stroke: var(--status-danger); stroke-width: 2; fill: none; flex-shrink: 0; }
        .factory-reset-warning-text { font-size: var(--text-sm); color: var(--text-primary); }
        .factory-reset-warning-text strong { color: var(--status-danger); }
        
        @media (max-width: 768px) {
            .quick-actions-grid { grid-template-columns: repeat(2, 1fr); }
            .mode-toggle-container { flex-wrap: wrap; }
        }
        
        /* Data Grid */
        .data-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); }
        .data-item { display: flex; justify-content: space-between; padding: var(--space-3); background: var(--bg-elevated); border-radius: var(--radius-md); }
        .data-label { font-size: var(--text-sm); color: var(--text-muted); }
        .data-value { font-family: var(--font-mono); font-size: var(--text-sm); }
        
        /* Log Viewer */
        .log-viewer { background: var(--bg-void); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--space-4); height: 300px; overflow-y: auto; font-family: var(--font-mono); font-size: var(--text-xs); }
        .log-entry { padding: var(--space-1) 0; border-bottom: 1px solid var(--border-subtle); }
        .log-time { color: var(--text-muted); margin-right: var(--space-2); }
        .log-topic { margin-right: var(--space-2); font-weight: 600; }
        .log-topic.sensors { color: var(--neon-cyan); }
        .log-topic.status { color: var(--status-success); }
        .log-topic.command { color: var(--neon-magenta); }
        .log-topic.error { color: var(--status-danger); }
        .log-topic.system { color: var(--neon-yellow); }
        .log-topic.diag { color: #B482FF; }
        .log-message { color: var(--text-secondary); word-break: break-all; }
        
        /* Toast */
        .toast-container { position: fixed; bottom: var(--space-6); right: var(--space-6); display: flex; flex-direction: column; gap: var(--space-3); z-index: 1000; }
        .toast { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-4); background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-md); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease; max-width: 350px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 3px solid var(--status-success); }
        .toast.warning { border-left: 3px solid var(--status-warning); }
        .toast.error { border-left: 3px solid var(--status-danger); }
        .toast.info { border-left: 3px solid var(--neon-cyan); }
        .toast-icon { width: 20px; height: 20px; stroke-width: 2; fill: none; flex-shrink: 0; }
        .toast.success .toast-icon { stroke: var(--status-success); }
        .toast.warning .toast-icon { stroke: var(--status-warning); }
        .toast.error .toast-icon { stroke: var(--status-danger); }
        .toast.info .toast-icon { stroke: var(--neon-cyan); }
        .toast-content { flex: 1; }
        .toast-title { font-size: var(--text-sm); font-weight: 600; }
        .toast-message { font-size: var(--text-xs); color: var(--text-muted); }
        .toast-close { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: var(--text-muted); cursor: pointer; }
        .toast-close svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; }
        
        /* ============================================
           Phase 11.4: WARNING SYSTEM STYLES
           ============================================ */
        
        /* Sound Toggle Button */
        .sound-toggle { position: relative; }
        .sound-toggle .icon-sound-on,
        .sound-toggle .icon-sound-off { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; transition: opacity var(--transition-fast); }
        .sound-toggle .icon-sound-off { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; }
        .sound-toggle.muted .icon-sound-on { opacity: 0; }
        .sound-toggle.muted .icon-sound-off { opacity: 1; }
        .sound-toggle.muted { color: var(--status-danger); border-color: var(--status-danger); }
        /* Sound indicator dot - positioned at bottom-right to avoid overlap */
        .sound-toggle::after { 
            content: ''; 
            position: absolute; 
            bottom: -2px; 
            right: -2px; 
            width: 8px; 
            height: 8px; 
            background: var(--status-success); 
            border-radius: 50%; 
            opacity: 0; 
            transition: opacity var(--transition-fast);
            border: 2px solid var(--bg-surface);
            box-sizing: content-box;
        }
        .sound-toggle:not(.muted)::after { opacity: 1; }
        
        /* Warning Summary Panel */
        .warning-summary { display: flex; gap: var(--space-3); margin-left: auto; }
        .warning-summary-item { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--bg-elevated); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: var(--text-sm); }
        .warning-summary-item.danger { border: 1px solid var(--status-danger); color: var(--status-danger); }
        .warning-summary-item.warning { border: 1px solid var(--status-warning); color: var(--status-warning); }
        .warning-summary-item.hidden { display: none; }
        .warning-summary-count { font-weight: 700; min-width: 20px; text-align: center; }
        .warning-summary-label { font-size: var(--text-xs); opacity: 0.8; }
        .warning-summary-icon { width: 16px; height: 16px; }
        .warning-summary-icon svg { width: 100%; height: 100%; stroke: currentColor; stroke-width: 2; fill: none; }
        
        /* Warning Log Viewer */
        .warning-log-section { margin-top: var(--space-4); }
        .warning-log-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-3) var(--space-4); background: var(--bg-elevated); border-radius: var(--radius-md) var(--radius-md) 0 0; border: 1px solid var(--border-default); border-bottom: none; }
        .warning-log-title { display: flex; align-items: center; gap: var(--space-2); font-family: var(--font-display); font-size: var(--text-sm); font-weight: 600; color: var(--status-warning); }
        .warning-log-title svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; }
        .warning-log-viewer { max-height: 300px; overflow-y: auto; background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: 0 0 var(--radius-md) var(--radius-md); font-family: var(--font-mono); font-size: var(--text-xs); }
        .warning-log-empty { padding: var(--space-6); text-align: center; color: var(--text-muted); }
        .warning-log-entry { display: grid; grid-template-columns: 70px 100px 80px 80px 1fr; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-bottom: 1px solid var(--border-subtle); align-items: center; transition: background var(--transition-fast); }
        .warning-log-entry:hover { background: var(--bg-elevated); }
        .warning-log-entry:last-child { border-bottom: none; }
        .warning-log-entry.danger { background: rgba(255, 51, 102, 0.05); }
        .warning-log-entry.danger:hover { background: rgba(255, 51, 102, 0.1); }
        .warning-log-time { color: var(--text-muted); }
        .warning-log-device { color: var(--neon-cyan); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .warning-log-type { color: var(--text-secondary); }
        .warning-log-value { font-weight: 600; }
        .warning-log-level { display: inline-flex; align-items: center; gap: var(--space-1); padding: 2px 6px; border-radius: var(--radius-sm); font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .warning-log-level.warning { background: rgba(255, 184, 0, 0.15); color: var(--status-warning); }
        .warning-log-level.danger { background: rgba(255, 51, 102, 0.15); color: var(--status-danger); }
        
        /* Responsive Warning Log */
        @media (max-width: 768px) {
            .warning-log-entry { grid-template-columns: 60px 1fr auto; }
            .warning-log-type, .warning-log-value { display: none; }
            .warning-summary { flex-wrap: wrap; justify-content: flex-end; }
        }
        
        /* ============================================
           MOBILE RESPONSIVE - FIX #1 & #2
           ============================================ */
        .mobile-menu-btn { display: none; width: 40px; height: 40px; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); }
        .mobile-menu-btn:hover { color: var(--neon-cyan); border-color: var(--neon-cyan); }
        .mobile-menu-btn:active { transform: scale(0.95); transition-duration: 50ms; }
        .mobile-menu-btn:focus-visible { outline: 2px solid var(--neon-cyan); outline-offset: 2px; }
        .mobile-menu-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 99; }
        
        @media (max-width: 1024px) {
            .mobile-menu-btn { display: flex; }
            
            /* FIX #2: Hide toggle button on mobile */
            .sidebar-toggle { display: none; }
            
            .sidebar { transform: translateX(-100%); width: var(--sidebar-width); }
            .sidebar.open { transform: translateX(0); }
            .sidebar.collapsed { width: var(--sidebar-width); transform: translateX(-100%); }
            .sidebar.collapsed.open { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            
            /* FIX #1: Main content full width on mobile */
            .main { margin-left: 0 !important; width: 100%; }
            .sidebar.collapsed ~ .main { margin-left: 0 !important; }
            
            /* Reset collapsed styles on mobile */
            .sidebar.collapsed .sidebar-logo-text,
            .sidebar.collapsed .nav-label,
            .sidebar.collapsed .nav-section-title,
            .sidebar.collapsed .user-info { opacity: 1; visibility: visible; width: auto; }
            .sidebar.collapsed .sidebar-header { justify-content: space-between; padding: var(--space-4); }
            .sidebar.collapsed .sidebar-logo { display: flex; }
            .sidebar.collapsed .nav-item { justify-content: flex-start; padding: var(--space-3) var(--space-4); }
            .sidebar.collapsed .nav-icon { margin-right: var(--space-3); }
            .sidebar.collapsed .user-card { justify-content: flex-start; padding: var(--space-3); gap: var(--space-3); }
        }
        
        @media (max-width: 768px) {
            .header { padding: 0 var(--space-4); }
            .content { padding: var(--space-4); }
            .connection-form { grid-template-columns: 1fr; }
            .speed-grid { grid-template-columns: repeat(3, 1fr); }
            .data-grid { grid-template-columns: 1fr; }
            .page-title::before, .page-title::after { display: none; }
            
            /* Fix 3: Device Switcher - compact on tablet */
            .device-switcher { margin-left: var(--space-2); }
            .device-switcher-btn { 
                min-width: 140px; 
                max-width: 180px; 
                min-height: 44px; /* A.2: Touch target */
                padding: var(--space-2) var(--space-3);
            }
            .device-switcher-serial { font-size: 11px; } /* A.4: min 11px */
            .device-switcher-name { font-size: 10px; } /* A.4: min 10px */
            
            /* Fix 4: Page title - smaller on tablet */
            .page-title { 
                font-size: var(--text-base); 
                padding: var(--space-1) var(--space-2);
                white-space: nowrap;
            }
            
            /* Fix 5: Header buttons - touch target 44px */
            .header-btn, .theme-toggle { 
                min-width: 44px; /* A.2: Touch target */
                min-height: 44px;
                width: 44px; 
                height: 44px; 
            }
            .header-btn svg, .theme-toggle svg { 
                width: 20px; 
                height: 20px; 
            }
            
            /* Fix 6: Hamburger - touch target 44px */
            .mobile-menu-btn { 
                min-width: 44px; /* A.2: Touch target */
                min-height: 44px;
                width: 44px; 
                height: 44px; 
                flex-shrink: 0;
            }
            .mobile-menu-btn svg { 
                width: 20px; 
                height: 20px; 
            }
            
            /* Active Device Bar - compact */
            .active-device-bar {
                padding: var(--space-2) var(--space-3);
                gap: var(--space-2);
            }
            .adb-icon { width: 16px; height: 16px; }
            .adb-action { font-size: 11px; } /* A.4: min 11px */
            .adb-serial { font-size: var(--text-xs); }
            .adb-nickname { font-size: var(--text-xs); }
            .adb-detail { font-size: 11px; } /* A.4: min 11px */
            .adb-status { font-size: 11px; } /* A.4: min 11px */
            
            /* A.3: Input font-size 16px for iOS */
            .form-input,
            .config-form-input,
            .devices-search-input {
                font-size: 16px;
            }
        }
        
        /* Extra small screens - phone */
        @media (max-width: 480px) {
            /* Header layout - tighter */
            .header { 
                padding: 0 var(--space-2); 
                gap: var(--space-2);
            }
            .header-left { 
                gap: var(--space-2); 
                flex: 1;
                min-width: 0;
                justify-content: flex-start;
            }
            .header-right { 
                gap: var(--space-1); 
                flex-shrink: 0;
            }
            
            /* Phase 11.4 Fix: Page title - visible on mobile (no device switcher) */
            .page-title { 
                font-size: var(--text-sm); 
                padding: var(--space-1) var(--space-2);
                max-width: none;
                flex-shrink: 0;
                display: block;
            }
            
            /* Phase 11.4 Fix: Hide Device Switcher on mobile - use Monitor tab instead */
            .device-switcher { 
                display: none !important;
            }
            
            /* Fix 5: Header buttons - minimal */
            .header-btn, .theme-toggle { 
                width: 32px; 
                height: 32px;
                border: none;
                background: transparent;
            }
            .header-btn svg, .theme-toggle svg { 
                width: 16px; 
                height: 16px; 
            }
            
            /* Fix 6: Hamburger - consistent */
            .mobile-menu-btn { 
                width: 32px; 
                height: 32px;
                flex-shrink: 0;
                border: none;
            }
            .mobile-menu-btn svg { 
                width: 16px; 
                height: 16px; 
            }
            
            /* Device Switcher Menu - full width modal */
            .device-switcher-menu {
                position: fixed;
                left: var(--space-3);
                right: var(--space-3);
                top: 60px;
                max-height: 70vh;
                border-radius: var(--radius-md);
                border: 1px solid var(--neon-cyan);
            }
            
            /* Active Device Bar - stacked layout */
            .active-device-bar {
                flex-direction: column;
                align-items: flex-start;
                padding: var(--space-2) var(--space-3);
                gap: var(--space-1);
            }
            .adb-separator { display: none; }
            .adb-status { 
                margin-left: 0; 
                margin-top: var(--space-1);
            }
            
            /* ============================================
               Phase A: Mobile Critical Fixes (480px)
               ============================================ */
            
            /* A.2: Touch Target - minimum 44px for interactive elements */
            .header-btn, .theme-toggle, .mobile-menu-btn {
                min-width: 44px;
                min-height: 44px;
                width: 44px;
                height: 44px;
            }
            .header-btn svg, .theme-toggle svg, .mobile-menu-btn svg {
                width: 20px;
                height: 20px;
            }
            
            /* A.2: Device Switcher touch target */
            .device-switcher-btn {
                min-height: 44px;
                padding: var(--space-2) var(--space-3);
            }
            
            /* A.3: Input font-size 16px - prevent iOS auto-zoom */
            .form-input,
            .config-form-input,
            .speed-map-input,
            .devices-search-input,
            .device-form-input,
            input[type="text"],
            input[type="number"],
            input[type="password"],
            select,
            textarea {
                font-size: 16px !important;
            }
            
            /* A.4: Minimum text size 11px (was 9px) */
            .device-switcher-serial { font-size: 11px; }
            .device-switcher-name { font-size: 10px; }
            .adb-action { font-size: 10px; }
            .adb-detail { font-size: 10px; }
            .adb-status { font-size: 10px; }
            
            /* A.5: Safe Area for notch devices (iPhone X+) */
            .header {
                padding-left: max(var(--space-2), env(safe-area-inset-left));
                padding-right: max(var(--space-2), env(safe-area-inset-right));
            }
            .sidebar {
                padding-bottom: env(safe-area-inset-bottom);
            }
            .content {
                padding-bottom: max(var(--space-4), env(safe-area-inset-bottom));
            }
        }
        
        /* ============================================
           Phase A.1: iPhone SE Specific (375px)
           ============================================ */
        @media (max-width: 375px) {
            /* A.6: Header compact - reduce height */
            :root {
                --header-height: 56px;
            }
            
            .header {
                padding: 0 var(--space-2);
                gap: var(--space-1);
            }
            
            .header-left {
                gap: var(--space-1);
            }
            
            .header-right {
                gap: 2px;
            }
            
            /* A.6: Smaller touch targets but still accessible (44px min) */
            .header-btn, .theme-toggle, .mobile-menu-btn {
                min-width: 44px;
                min-height: 44px;
                width: 44px;
                height: 44px;
                padding: 0;
            }
            
            /* A.7: Page title - SHOW on small screens (device switcher hidden) */
            .page-title {
                display: block;
                font-size: 11px;
                padding: var(--space-1);
            }
            
            /* A.7: Device Switcher - HIDE on very small screens */
            .device-switcher {
                display: none !important;
            }
            
            /* A.7: Content padding tighter */
            .content {
                padding: var(--space-3);
            }
            
            /* A.7: Bento cards spacing */
            .bento-grid {
                gap: var(--space-3);
            }
            .bento-card {
                padding: var(--space-3);
            }
            .card-header {
                margin-bottom: var(--space-2);
                gap: var(--space-2);
            }
            
            /* A.4: Minimum text sizes */
            .card-title {
                font-size: var(--text-xs);
            }
            .stat-value {
                font-size: var(--text-xl);
            }
            .stat-label {
                font-size: 10px;
            }
            
            /* A.7: Speed buttons - 3 column grid */
            .speed-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--space-2);
            }
            .speed-btn {
                padding: var(--space-2);
                min-height: 44px;
                font-size: var(--text-sm);
            }
            
            /* A.7: Control buttons */
            .control-btn {
                min-width: 80px;
                padding: var(--space-3);
                min-height: 44px;
            }
            
            /* A.7: Quick actions - smaller */
            .quick-actions {
                gap: var(--space-2);
            }
            .quick-action-btn {
                padding: var(--space-2);
                min-height: 44px;
            }
            .quick-action-label {
                font-size: 9px;
            }
            
            /* A.7: Form inputs - full width */
            .connection-form .form-group {
                grid-column: span 1;
            }
            .form-input {
                width: 100%;
            }
            
            /* A.7: Active Device Bar - ultra compact */
            .active-device-bar {
                padding: var(--space-2);
                gap: 2px;
            }
            .adb-icon {
                width: 14px;
                height: 14px;
            }
            .adb-serial {
                font-size: 11px;
            }
            .adb-nickname {
                font-size: 10px;
            }
            
            /* A.7: Charts - shorter on small screens */
            .chart-container {
                height: 150px;
            }
            .chart-container.chart-wide {
                height: 140px;
            }
            
            /* A.7: Device Switcher Menu - better for 375px */
            .device-switcher-menu {
                left: var(--space-2);
                right: var(--space-2);
                top: 52px;
            }
            .device-switcher-item {
                padding: var(--space-3);
                min-height: 48px;
            }
            
            /* A.7: Modal - full width */
            .modal {
                width: calc(100% - var(--space-4));
                max-width: none;
                margin: var(--space-2);
            }
            
            /* A.7: Config sections - tighter */
            .config-section {
                padding: var(--space-3);
            }
            .config-section-header {
                gap: var(--space-2);
                margin-bottom: var(--space-3);
            }
            .config-section-icon {
                width: 28px;
                height: 28px;
            }
            .config-form {
                gap: var(--space-3);
            }
            
            /* A.7: Speed map inputs */
            .speed-map-grid {
                gap: var(--space-2);
            }
            .speed-map-item {
                min-width: 45px;
            }
            .speed-map-input {
                width: 50px;
                padding: var(--space-2);
            }
            
            /* A.7: Devices tab */
            .devices-header {
                gap: var(--space-2);
            }
            .devices-stats {
                padding: var(--space-2);
                gap: var(--space-2);
            }
            .devices-stat {
                font-size: 11px;
            }
            
            /* A.7: Logs - compact */
            .log-entry {
                padding: var(--space-2);
                font-size: 11px;
            }
            
            /* A.5: Safe area bottom for content */
            .tab-content {
                padding-bottom: max(var(--space-4), env(safe-area-inset-bottom));
            }
        }
        
        /* ============================================
           Phase C.1: Landscape Mode
           Use JS-controlled class instead of media query
           To prevent bug when rotating back to Portrait
           ============================================ */
        
        /* Landscape Mode - Compact Layout */
        body.landscape-mode .header {
            height: 48px;
            min-height: 48px;
            padding: 0 var(--space-3);
        }
        
        body.landscape-mode .main {
            padding-top: 0;
        }
        
        body.landscape-mode .sidebar-header {
            min-height: 48px;
            padding: var(--space-2) var(--space-3);
        }
        
        body.landscape-mode .header-btn,
        body.landscape-mode .theme-toggle,
        body.landscape-mode .mobile-menu-btn {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
        }
        
        body.landscape-mode .header-btn svg,
        body.landscape-mode .theme-toggle svg,
        body.landscape-mode .mobile-menu-btn svg {
            width: 16px;
            height: 16px;
        }
        
        body.landscape-mode .device-switcher-btn {
            min-height: 36px;
            padding: var(--space-1) var(--space-2);
        }
        
        body.landscape-mode .page-title {
            font-size: var(--text-sm);
            padding: var(--space-1) var(--space-2);
        }
        
        body.landscape-mode .content {
            padding: var(--space-3);
        }
        
        body.landscape-mode .connection-panel {
            padding: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        body.landscape-mode .bento-card,
        body.landscape-mode .card {
            padding: var(--space-3);
        }
        
        body.landscape-mode .chart-container {
            height: 120px !important;
        }
        
        body.landscape-mode .chart-container.chart-wide {
            height: 100px !important;
        }
        
        body.landscape-mode .bento-grid {
            gap: var(--space-3);
        }
        
        /* Landscape: Active Device Bar compact */
        body.landscape-mode .active-device-bar {
            padding: var(--space-2) var(--space-3);
            gap: var(--space-2);
        }
        
        body.landscape-mode .adb-icon {
            width: 14px;
            height: 14px;
        }
        
        /* Landscape: Control Panel compact */
        body.landscape-mode .mode-toggle-container {
            gap: var(--space-2);
        }
        
        body.landscape-mode .mode-toggle-btn {
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-xs);
        }
        
        body.landscape-mode .speed-grid {
            gap: var(--space-2);
        }
        
        body.landscape-mode .speed-btn {
            padding: var(--space-2);
            font-size: var(--text-xs);
        }
        
        /* Landscape: Hide decorative elements for performance */
        body.landscape-mode .particles,
        body.landscape-mode .scanline {
            display: none !important;
        }
        
        /* Landscape: Reduce card corner decorations */
        body.landscape-mode .card::before,
        body.landscape-mode .card::after {
            width: 8px;
            height: 8px;
        }
        
        /* Landscape: Toast position adjustment */
        body.landscape-mode .toast-container {
            bottom: var(--space-3);
            right: var(--space-3);
        }
        
        body.landscape-mode .toast {
            padding: var(--space-2) var(--space-3);
            max-width: 280px;
        }
        
        /* Landscape: Log viewer compact */
        body.landscape-mode .log-viewer {
            height: 200px;
        }
        
        /* Landscape: Config form compact */
        body.landscape-mode .config-section {
            padding: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        /* Landscape: Device list compact */
        body.landscape-mode .devices-list {
            max-height: 250px;
        }
        
        /* ============================================
           Force Repaint Animation
           Used to force browser recalculate styles
           ============================================ */
        @keyframes forceRepaint {
            from { opacity: 0.99; }
            to { opacity: 1; }
        }
        
        .force-repaint * {
            animation: forceRepaint 0.01s !important;
        }
        
        /* No Transition - Disable animation during theme toggle */
        .no-transition,
        .no-transition * {
            transition: none !important;
            animation: none !important;
        }
        
        /* ============================================
           Portrait Mode Reset (Force override)
           Use :not(.landscape-mode) to reset
           Must use !important to override landscape styles
           ============================================ */
        
        /* Header Reset */
        body:not(.landscape-mode) .header {
            height: var(--header-height) !important;
            min-height: var(--header-height) !important;
        }
        
        /* Buttons Reset */
        body:not(.landscape-mode) .header-btn,
        body:not(.landscape-mode) .theme-toggle,
        body:not(.landscape-mode) .mobile-menu-btn {
            width: 44px !important;
            height: 44px !important;
            min-width: 44px !important;
            min-height: 44px !important;
        }
        
        /* Content Reset */
        body:not(.landscape-mode) .content {
            padding: var(--space-6) !important;
        }
        
        /* Cards Reset */
        body:not(.landscape-mode) .card,
        body:not(.landscape-mode) .bento-card {
            padding: var(--space-6) !important;
        }
        
        /* Stat Card Reset (uses default padding different from .card) */
        body:not(.landscape-mode) .stat-card {
            padding: var(--space-5) !important;
        }
        
        /* Bento Grid Reset */
        body:not(.landscape-mode) .bento-grid {
            gap: var(--space-4) !important;
        }
        
        /* Chart Container Reset - Desktop */
        body:not(.landscape-mode) .chart-container {
            height: 200px !important;
        }
        
        body:not(.landscape-mode) .chart-container.chart-wide {
            height: 180px !important;
        }
        
        /* Portrait: Respect 768px breakpoint */
        @media (max-width: 768px) {
            body:not(.landscape-mode) .content {
                padding: var(--space-4) !important;
            }
            body:not(.landscape-mode) .chart-container {
                height: 180px !important;
            }
            body:not(.landscape-mode) .chart-container.chart-wide {
                height: 160px !important;
            }
        }
        
        /* Portrait: Respect 375px breakpoint */
        @media (max-width: 375px) {
            body:not(.landscape-mode) .content {
                padding: var(--space-3) !important;
            }
            body:not(.landscape-mode) .card,
            body:not(.landscape-mode) .bento-card,
            body:not(.landscape-mode) .stat-card {
                padding: var(--space-3) !important;
            }
            body:not(.landscape-mode) .bento-grid {
                gap: var(--space-3) !important;
            }
            body:not(.landscape-mode) .chart-container {
                height: 150px !important;
            }
            body:not(.landscape-mode) .chart-container.chart-wide {
                height: 140px !important;
            }
        }
        
        /* ============================================
           CSS-ONLY PORTRAIT FORCE RESET
           Use orientation: portrait media query
           Browser detects automatically without JS
           ============================================ */
        @media (orientation: portrait) {
            /* Force reset everything when Portrait */
            .header {
                height: var(--header-height) !important;
                min-height: var(--header-height) !important;
            }
            
            .header-btn,
            .theme-toggle,
            .mobile-menu-btn {
                width: 44px !important;
                height: 44px !important;
                min-width: 44px !important;
                min-height: 44px !important;
            }
            
            .content {
                padding: var(--space-6) !important;
            }
            
            .card,
            .bento-card {
                padding: var(--space-6) !important;
            }
            
            .stat-card {
                padding: var(--space-5) !important;
            }
            
            .bento-grid {
                gap: var(--space-4) !important;
            }
            
            .chart-container {
                height: 200px !important;
            }
            
            .chart-container.chart-wide {
                height: 180px !important;
            }
        }
        
        /* Portrait + Mobile breakpoints */
        @media (orientation: portrait) and (max-width: 768px) {
            .content {
                padding: var(--space-4) !important;
            }
            .chart-container {
                height: 180px !important;
            }
            .chart-container.chart-wide {
                height: 160px !important;
            }
        }
        
        @media (orientation: portrait) and (max-width: 375px) {
            .content {
                padding: var(--space-3) !important;
            }
            .card,
            .bento-card,
            .stat-card {
                padding: var(--space-3) !important;
            }
            .bento-grid {
                gap: var(--space-3) !important;
            }
            .chart-container {
                height: 150px !important;
            }
            .chart-container.chart-wide {
                height: 140px !important;
            }
        }
        
        /* ============================================
           Phase C.2: Custom Scrollbar Styling
           ============================================ */
        /* Webkit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-elevated);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
            border: 2px solid var(--bg-elevated);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-cyan);
            box-shadow: 0 0 8px var(--neon-cyan-glow);
        }
        
        ::-webkit-scrollbar-corner {
            background: var(--bg-elevated);
        }
        
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-default) var(--bg-elevated);
        }
        
        /* Sidebar scrollbar - thinner */
        .sidebar-nav::-webkit-scrollbar {
            width: 4px;
        }
        
        .sidebar-nav::-webkit-scrollbar-thumb {
            border: none;
        }
        
        /* Log viewer scrollbar */
        .log-viewer::-webkit-scrollbar-thumb:hover {
            background: var(--neon-yellow);
            box-shadow: 0 0 8px rgba(255, 230, 0, 0.3);
        }
        
        /* Device table scrollbar */
        .device-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--neon-magenta);
            box-shadow: 0 0 8px var(--neon-magenta-glow);
        }
        
        /* ============================================
           Phase C.3: Animation Polish
           ============================================ */
        
        /* Card hover lift effect */
        .card {
            transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        /* Stat card subtle glow on hover - keep original border color */
        .stat-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 0 15px rgba(0, 240, 255, 0.1);
        }
        
        /* Tab panel smooth transition */
        .tab-panel {
            animation: fadeSlideIn 0.3s ease-out;
        }
        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Toast slide in from right - enhanced */
        .toast {
            animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes toastSlideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Connection status pulse when connecting */
        .status-dot.connecting {
            animation: connectingPulse 1s ease-in-out infinite;
        }
        @keyframes connectingPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }
        
        /* Device switcher menu slide */
        .device-switcher-menu.open {
            animation: menuSlideDown 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes menuSlideDown {
            from {
                opacity: 0;
                transform: translateY(-8px) scaleY(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scaleY(1);
            }
        }
        
        /* Bento grid items stagger animation on load */
        .bento-grid > * {
            animation: gridItemFadeIn 0.4s ease-out backwards;
        }
        .bento-grid > *:nth-child(1) { animation-delay: 0.05s; }
        .bento-grid > *:nth-child(2) { animation-delay: 0.1s; }
        .bento-grid > *:nth-child(3) { animation-delay: 0.15s; }
        .bento-grid > *:nth-child(4) { animation-delay: 0.2s; }
        .bento-grid > *:nth-child(5) { animation-delay: 0.25s; }
        .bento-grid > *:nth-child(6) { animation-delay: 0.3s; }
        .bento-grid > *:nth-child(7) { animation-delay: 0.35s; }
        .bento-grid > *:nth-child(8) { animation-delay: 0.4s; }
        
        @keyframes gridItemFadeIn {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Nav item hover slide indicator */
        .nav-item::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%) scaleX(0);
            width: 3px;
            height: 60%;
            background: var(--neon-cyan);
            border-radius: 2px;
            transition: transform var(--transition-fast);
            transform-origin: right;
        }
        .nav-item:hover::after {
            transform: translateY(-50%) scaleX(1);
        }
        .nav-item.active::after {
            transform: translateY(-50%) scaleX(1);
            background: var(--neon-cyan);
            box-shadow: 0 0 8px var(--neon-cyan-glow);
        }
        
        /* Speed button ripple-like effect */
        .speed-btn {
            position: relative;
            overflow: hidden;
        }
        .speed-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, var(--neon-magenta-subtle) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        .speed-btn:hover::after {
            opacity: 1;
        }
        
        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .particles, .scanline {
                display: none;
            }
        }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--space-6); max-width: 400px; width: 90%; }
        .modal-title { font-size: var(--text-lg); margin-bottom: var(--space-3); }
        .modal-text { color: var(--text-secondary); margin-bottom: var(--space-6); }
        .modal-actions { display: flex; gap: var(--space-3); justify-content: flex-end; }
        
        /* ============================================
           Phase 10.5: Device Config & OTA Styles
           ============================================ */
        .config-grid { display: flex; flex-direction: column; gap: var(--space-6); }
        .config-section { background: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--space-5); position: relative; }
        .config-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); border-radius: var(--radius-lg) var(--radius-lg) 0 0; opacity: 0.6; }
        .config-section-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-5); }
        .config-section-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--neon-cyan-subtle); border-radius: var(--radius-md); }
        .config-section-icon svg { width: 18px; height: 18px; stroke: var(--neon-cyan); stroke-width: 2; fill: none; }
        .config-section-title { font-family: var(--font-display); font-size: var(--text-base); font-weight: 600; letter-spacing: 0.05em; }
        
        /* Config Form Grid */
        .config-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-5); }
        .config-form-row { display: flex; flex-wrap: wrap; gap: var(--space-4); margin-bottom: var(--space-4); }
        .config-form-group { display: flex; flex-direction: column; gap: var(--space-2); }
        .config-form-group.full-width { grid-column: 1 / -1; }
        .config-form-label { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .config-form-input { padding: var(--space-3); font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text-primary); background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-md); outline: none; transition: all var(--transition-fast); min-width: 80px; }
        .config-form-input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 0 2px var(--neon-cyan-subtle); }
        .config-form-input.small { width: 80px; }
        .config-form-input.medium { width: 120px; }
        .config-form-input.url { width: 100%; min-width: 200px; }
        
        /* Speed Map Inputs */
        .speed-map-grid { display: flex; flex-wrap: wrap; gap: var(--space-2); align-items: center; }
        .speed-map-item { display: flex; flex-direction: column; align-items: center; gap: var(--space-1); }
        .speed-map-label { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-muted); }
        .speed-map-input { width: 60px; padding: var(--space-2); text-align: center; font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text-primary); background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: var(--radius-md); }
        .speed-map-input:focus { border-color: var(--neon-cyan); box-shadow: 0 0 0 2px var(--neon-cyan-subtle); }
        
        /* Checkbox Toggle */
        .config-checkbox { display: flex; align-items: center; gap: var(--space-3); cursor: pointer; }
        .config-checkbox input { display: none; }
        .config-checkbox-toggle { width: 44px; height: 24px; background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: 12px; position: relative; transition: all var(--transition-fast); }
        .config-checkbox-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: var(--text-muted); border-radius: 50%; transition: all var(--transition-fast); }
        .config-checkbox input:checked + .config-checkbox-toggle { background: var(--neon-cyan-subtle); border-color: var(--neon-cyan); }
        .config-checkbox input:checked + .config-checkbox-toggle::after { left: 22px; background: var(--neon-cyan); }
        .config-checkbox-label { font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text-secondary); }
        
        /* Config Actions */
        .config-actions { display: flex; flex-wrap: wrap; gap: var(--space-3); align-items: center; padding-top: var(--space-4); border-top: 1px solid var(--border-subtle); }
        .config-warning { display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-xs); color: var(--status-warning); margin-left: auto; }
        .config-warning svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 2; fill: none; }
        
        /* Firmware Info */
        .firmware-info { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3) var(--space-4); background: var(--bg-elevated); border-radius: var(--radius-md); margin-bottom: var(--space-4); }
        .firmware-label { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-muted); }
        .firmware-value { font-family: var(--font-mono); font-size: var(--text-sm); color: var(--neon-cyan); font-weight: 600; }
        
        /* Config Backup Buttons */
        .config-backup-actions { display: flex; flex-wrap: wrap; gap: var(--space-3); }
        
        /* Button Variants */
        .btn-warning { background: var(--status-warning); border: none; color: var(--bg-void); }
        .btn-warning:hover { box-shadow: 0 0 15px rgba(255, 184, 0, 0.4); }
        .btn-success { background: var(--status-success); border: none; color: var(--bg-void); }
        .btn-success:hover { box-shadow: 0 0 15px rgba(0, 255, 159, 0.4); }
        
        /* Hidden file input */
        .hidden-input { display: none; }
        
        /* Spin animation for loading buttons */
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .config-form { grid-template-columns: 1fr; }
            .speed-map-grid { justify-content: center; }
            .config-actions { flex-direction: column; align-items: stretch; }
            .config-warning { margin-left: 0; justify-content: center; margin-top: var(--space-2); }
        }
        
        /* ============================================
           Phase 11.1: Device Registry & Nickname System
           ============================================ */
        
        /* Device Count Badge in Sidebar */
        .device-count-badge { 
            margin-left: auto; 
            padding: 2px 8px; 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            background: var(--neon-cyan-subtle); 
            color: var(--neon-cyan); 
            border-radius: 10px; 
            font-weight: 600;
        }
        .sidebar.collapsed .device-count-badge { display: none; }
        
        /* Devices Tab Header */
        .devices-header { 
            display: flex; 
            flex-wrap: wrap;
            align-items: center; 
            gap: var(--space-4); 
            margin-bottom: var(--space-5); 
        }
        .devices-search { 
            flex: 1; 
            min-width: 200px;
            position: relative; 
        }
        .devices-search-input { 
            width: 100%; 
            padding: var(--space-3) var(--space-4) var(--space-3) 40px; 
            font-family: var(--font-mono); 
            font-size: var(--text-sm); 
            color: var(--text-primary); 
            background: var(--bg-elevated); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-md); 
            outline: none; 
            transition: all var(--transition-fast); 
        }
        .devices-search-input:focus { 
            border-color: var(--neon-cyan); 
            box-shadow: 0 0 0 2px var(--neon-cyan-subtle); 
        }
        .devices-search-icon { 
            position: absolute; 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 18px; 
            height: 18px; 
            stroke: var(--text-muted); 
            stroke-width: 2; 
            fill: none; 
        }
        .devices-actions { 
            display: flex; 
            gap: var(--space-2); 
            flex-wrap: wrap;
        }
        
        /* Device Stats Bar */
        .devices-stats { 
            display: flex; 
            gap: var(--space-4); 
            padding: var(--space-3) var(--space-4); 
            background: var(--bg-elevated); 
            border-radius: var(--radius-md); 
            margin-bottom: var(--space-4); 
            flex-wrap: wrap;
        }
        .devices-stat { 
            display: flex; 
            align-items: center; 
            gap: var(--space-2); 
            font-family: var(--font-mono); 
            font-size: var(--text-sm); 
        }
        .devices-stat-value { 
            font-weight: 600; 
            color: var(--neon-cyan); 
        }
        .devices-stat-label { 
            color: var(--text-muted); 
        }
        .devices-stat.online .devices-stat-value { color: var(--status-success); }
        .devices-stat.offline .devices-stat-value { color: var(--status-danger); }
        
        /* Device Table */
        .device-table-container { 
            background: var(--bg-surface); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-lg); 
            overflow: hidden; 
        }
        .device-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        .device-table th { 
            padding: var(--space-3) var(--space-4); 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--text-muted); 
            background: var(--bg-elevated); 
            border-bottom: 1px solid var(--border-default); 
            text-align: left; 
            cursor: pointer;
            transition: color var(--transition-fast);
            white-space: nowrap;
        }
        .device-table th:hover { color: var(--neon-cyan); }
        .device-table th.sorted { color: var(--neon-cyan); }
        .device-table th .sort-icon { 
            display: inline-block; 
            margin-left: 4px; 
            opacity: 0.5; 
        }
        .device-table th.sorted .sort-icon { opacity: 1; }
        .device-table td { 
            padding: var(--space-3) var(--space-4); 
            font-size: var(--text-sm); 
            border-bottom: 1px solid var(--border-subtle); 
            vertical-align: middle;
        }
        .device-table tr:last-child td { border-bottom: none; }
        .device-table tr:hover { background: var(--bg-elevated); }
        .device-table tr.selected { background: var(--neon-cyan-subtle); }
        
        /* Device Table Cells */
        .device-serial { 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            color: var(--text-secondary); 
        }
        .device-nickname { 
            font-weight: 500; 
            color: var(--text-primary); 
        }
        .device-nickname.empty { 
            color: var(--text-muted); 
            font-style: italic; 
        }
        .device-client { 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            color: var(--text-muted); 
        }
        .device-client-count { 
            display: inline-block;
            padding: 1px 6px; 
            font-size: 0.65rem; 
            background: var(--neon-magenta-subtle); 
            color: var(--neon-magenta); 
            border-radius: 8px; 
            margin-left: 4px;
        }
        .device-status-dot { 
            display: inline-block; 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            margin-right: 6px; 
        }
        .device-status-cell {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .device-status-dot.online { 
            background: var(--status-success); 
            box-shadow: 0 0 6px var(--status-success); 
        }
        .device-status-dot.offline { background: var(--status-danger); }
        .device-status-dot.unknown { background: var(--text-muted); }
        .device-lastseen { 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            color: var(--text-muted); 
        }
        .device-actions-cell { 
            display: flex; 
            gap: var(--space-2); 
        }
        .device-action-btn { 
            width: 28px; 
            height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: transparent; 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-sm); 
            color: var(--text-muted); 
            cursor: pointer; 
            transition: all var(--transition-fast); 
        }
        .device-action-btn:hover { 
            border-color: var(--neon-cyan); 
            color: var(--neon-cyan); 
        }
        .device-action-btn.delete:hover { 
            border-color: var(--status-danger); 
            color: var(--status-danger); 
        }
        .device-action-btn svg { 
            width: 14px; 
            height: 14px; 
            stroke: currentColor; 
            stroke-width: 2; 
            fill: none; 
        }
        
        /* Empty State */
        .device-empty { 
            padding: var(--space-8); 
            text-align: center; 
            color: var(--text-muted); 
        }
        .device-empty-icon { 
            width: 48px; 
            height: 48px; 
            margin: 0 auto var(--space-4); 
            stroke: var(--text-muted); 
            stroke-width: 1.5; 
            fill: none; 
            opacity: 0.5; 
        }
        .device-empty-text { 
            font-size: var(--text-sm); 
            margin-bottom: var(--space-4); 
        }
        
        /* Device Edit Modal */
        .device-modal { 
            max-width: 500px; 
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .device-modal-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: var(--space-5); 
            padding-bottom: var(--space-4); 
            border-bottom: 1px solid var(--border-subtle); 
        }
        .device-modal-title { 
            font-size: var(--text-lg); 
            display: flex; 
            align-items: center; 
            gap: var(--space-2); 
        }
        .device-modal-close { 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            cursor: pointer; 
            transition: color var(--transition-fast); 
        }
        .device-modal-close:hover { color: var(--text-primary); }
        .device-modal-close svg { 
            width: 20px; 
            height: 20px; 
            stroke: currentColor; 
            stroke-width: 2; 
            fill: none; 
        }
        
        /* Device Form Sections */
        .device-form-section { 
            margin-bottom: var(--space-5); 
            padding: var(--space-4); 
            background: var(--bg-elevated); 
            border-radius: var(--radius-md);
            /* Phase 11.4 UI Polish: Cyan border for QP Serial section */
            border-left: 3px solid var(--neon-cyan);
        }
        .device-form-section-title { 
            font-family: var(--font-display); 
            font-size: var(--text-xs); 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: var(--neon-cyan); 
            margin-bottom: var(--space-3); 
            display: flex; 
            align-items: center; 
            gap: var(--space-2); 
        }
        .device-form-section-title svg { 
            width: 14px; 
            height: 14px; 
            stroke: currentColor; 
            stroke-width: 2; 
            fill: none; 
        }
        .device-form-section.client { 
            border-left: 3px solid var(--neon-magenta); 
        }
        .device-form-section.client .device-form-section-title { 
            color: var(--neon-magenta); 
        }
        
        .device-form-group { 
            margin-bottom: var(--space-3); 
        }
        .device-form-group:last-child { margin-bottom: 0; }
        .device-form-label { 
            display: block; 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            color: var(--text-muted); 
            text-transform: uppercase; 
            margin-bottom: var(--space-2); 
        }
        .device-form-input { 
            width: 100%; 
            padding: var(--space-3); 
            font-family: var(--font-mono); 
            font-size: var(--text-sm); 
            color: var(--text-primary); 
            background: var(--bg-surface); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-md); 
            outline: none; 
            transition: all var(--transition-fast); 
        }
        .device-form-input:focus { 
            border-color: var(--neon-cyan); 
            box-shadow: 0 0 0 2px var(--neon-cyan-subtle); 
        }
        .device-form-input[readonly] { 
            background: var(--bg-void); 
            opacity: 0.7; 
        }
        .device-form-input.textarea { 
            min-height: 60px; 
            resize: vertical; 
        }
        .device-form-select { 
            width: 100%; 
            padding: var(--space-3); 
            font-family: var(--font-mono); 
            font-size: var(--text-sm); 
            color: var(--text-primary); 
            background: var(--bg-surface); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-md); 
            outline: none; 
            cursor: pointer; 
        }
        
        /* Client ID List in Edit Modal */
        .device-client-list { 
            margin-top: var(--space-3); 
        }
        .device-client-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: var(--space-2) var(--space-3); 
            background: var(--bg-surface); 
            border-radius: var(--radius-sm); 
            margin-bottom: var(--space-2); 
        }
        .device-client-item:last-child { margin-bottom: 0; }
        .device-client-info { flex: 1; }
        .device-client-id { 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            color: var(--text-secondary); 
        }
        .device-client-name { 
            font-size: var(--text-sm); 
            color: var(--text-primary); 
        }
        
        /* Device Modal Actions */
        .device-modal-actions { 
            display: flex; 
            gap: var(--space-3); 
            justify-content: space-between; 
            padding-top: var(--space-4); 
            border-top: 1px solid var(--border-subtle); 
        }
        .device-modal-actions-left { display: flex; gap: var(--space-2); }
        .device-modal-actions-right { display: flex; gap: var(--space-2); }
        
        /* Confirm Delete Modal */
        .confirm-modal { max-width: 450px; }
        .confirm-modal-icon { 
            width: 48px; 
            height: 48px; 
            margin: 0 auto var(--space-4); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: rgba(255, 51, 102, 0.1); 
            border-radius: 50%; 
        }
        .confirm-modal-icon svg { 
            width: 24px; 
            height: 24px; 
            stroke: var(--status-danger); 
            stroke-width: 2; 
            fill: none; 
        }
        .confirm-modal-title { 
            text-align: center; 
            font-size: var(--text-lg); 
            margin-bottom: var(--space-3); 
        }
        .confirm-modal-text { 
            text-align: center; 
            color: var(--text-secondary); 
            margin-bottom: var(--space-4); 
        }
        .confirm-modal-details { 
            background: var(--bg-elevated); 
            border-radius: var(--radius-md); 
            padding: var(--space-4); 
            margin-bottom: var(--space-4); 
        }
        .confirm-modal-detail { 
            display: flex; 
            justify-content: space-between; 
            padding: var(--space-2) 0; 
            border-bottom: 1px solid var(--border-subtle); 
        }
        .confirm-modal-detail:last-child { border-bottom: none; }
        .confirm-modal-label { 
            font-size: var(--text-sm); 
            color: var(--text-muted); 
        }
        .confirm-modal-value { 
            font-family: var(--font-mono); 
            font-size: var(--text-sm); 
        }
        .confirm-modal-clients { 
            margin-top: var(--space-3); 
            padding: var(--space-3); 
            background: rgba(255, 51, 102, 0.1); 
            border-radius: var(--radius-sm); 
        }
        .confirm-modal-clients-title { 
            font-size: var(--text-xs); 
            color: var(--status-danger); 
            margin-bottom: var(--space-2); 
        }
        .confirm-modal-client-item { 
            font-family: var(--font-mono); 
            font-size: var(--text-xs); 
            color: var(--text-secondary); 
            padding: 2px 0; 
        }
        .confirm-modal-checkbox { 
            display: flex; 
            align-items: center; 
            gap: var(--space-3); 
            margin-bottom: var(--space-4); 
            cursor: pointer; 
        }
        .confirm-modal-checkbox input[type="checkbox"] { 
            width: 18px; 
            height: 18px; 
            accent-color: var(--status-danger); 
        }
        .confirm-modal-checkbox-label { 
            font-size: var(--text-sm); 
            color: var(--text-secondary); 
        }
        .confirm-modal-actions { 
            display: flex; 
            gap: var(--space-3); 
            justify-content: center; 
        }
        
        /* Import/Export Section */
        .import-export-section { 
            margin-top: var(--space-6); 
            padding: var(--space-5); 
            background: var(--bg-surface); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-lg); 
        }
        .import-export-title { 
            font-family: var(--font-display); 
            font-size: var(--text-base); 
            margin-bottom: var(--space-4); 
            display: flex; 
            align-items: center; 
            gap: var(--space-2); 
        }
        .import-export-title svg { 
            width: 20px; 
            height: 20px; 
            stroke: var(--neon-cyan); 
            stroke-width: 2; 
            fill: none; 
        }
        .import-export-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: var(--space-3); 
        }
        .import-export-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: var(--space-2); 
            padding: var(--space-4); 
            background: var(--bg-elevated); 
            border: 1px dashed var(--border-default); 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            transition: all var(--transition-fast); 
        }
        .import-export-btn:hover { 
            border-color: var(--neon-cyan); 
            border-style: solid; 
        }
        .import-export-btn svg { 
            width: 24px; 
            height: 24px; 
            stroke: var(--text-muted); 
            stroke-width: 2; 
            fill: none; 
            transition: stroke var(--transition-fast); 
        }
        .import-export-btn:hover svg { stroke: var(--neon-cyan); }
        .import-export-btn span { 
            font-family: var(--font-display); 
            font-size: var(--text-xs); 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--text-muted); 
            transition: color var(--transition-fast); 
        }
        .import-export-btn:hover span { color: var(--neon-cyan); }
        
        /* ============================================
           Phase 11.2: Device Switcher Dropdown
           ============================================ */
        .device-switcher {
            position: relative;
            margin-left: var(--space-4);
        }
        .device-switcher-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 180px;
            max-width: 280px;
            /* Phase 11.4 UI Polish: Enable absolute positioning for status dot */
            position: relative;
        }
        .device-switcher-btn:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan-subtle);
        }
        .device-switcher-btn.open {
            border-color: var(--neon-cyan);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .device-switcher-icon {
            width: 18px;
            height: 18px;
            stroke: var(--neon-cyan);
            stroke-width: 2;
            fill: none;
            flex-shrink: 0;
        }
        .device-switcher-info {
            flex: 1;
            min-width: 0;
            text-align: left;
        }
        .device-switcher-serial {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .device-switcher-name {
            font-size: var(--text-xs);
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .device-switcher-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        /* Phase 11.4 UI Polish: Header button status dot - bottom-right like sound toggle */
        .device-switcher-btn > .device-switcher-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            border: 2px solid var(--bg-surface);
            box-sizing: content-box;
        }
        .device-switcher-status.online { background: var(--status-success); box-shadow: 0 0 6px var(--status-success); }
        .device-switcher-status.offline { background: var(--status-danger); }
        .device-switcher-status.unknown { background: var(--text-muted); }
        .device-switcher-arrow {
            width: 14px;
            height: 14px;
            stroke: var(--text-muted);
            stroke-width: 2;
            fill: none;
            flex-shrink: 0;
            transition: transform var(--transition-fast);
        }
        .device-switcher-btn.open .device-switcher-arrow {
            transform: rotate(180deg);
        }
        
        /* Dropdown Menu */
        .device-switcher-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-surface);
            border: 1px solid var(--neon-cyan);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        .device-switcher-menu.open {
            display: block;
            animation: dropdownSlide 0.15s ease-out;
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .device-switcher-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
            padding: var(--space-3);
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--border-subtle);
        }
        .device-switcher-item:last-child { border-bottom: none; }
        .device-switcher-item:hover {
            background: var(--bg-elevated);
        }
        .device-switcher-item.active {
            background: var(--neon-cyan-subtle);
        }
        /* Phase 11.4 UI Polish: Serial on top row */
        .device-switcher-item-serial {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            color: var(--text-primary);
        }
        /* Phase 11.4 UI Polish: Name and Status on same row */
        .device-switcher-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-2);
        }
        .device-switcher-item-name {
            font-size: var(--text-xs);
            color: var(--text-muted);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .device-switcher-item-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            color: var(--text-muted);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .device-switcher-item-status .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .device-switcher-item-status.online .status-dot { background: var(--status-success); }
        .device-switcher-item-status.offline .status-dot { background: var(--status-danger); }
        .device-switcher-item-status.unknown .status-dot { background: var(--text-muted); }
        
        /* Divider and Add Button */
        .device-switcher-divider {
            height: 1px;
            background: var(--border-default);
            margin: var(--space-1) 0;
        }
        .device-switcher-add {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            cursor: pointer;
            transition: background var(--transition-fast);
            color: var(--neon-cyan);
            font-size: var(--text-sm);
        }
        .device-switcher-add:hover {
            background: var(--neon-cyan-subtle);
        }
        .device-switcher-add svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        
        /* Empty State */
        .device-switcher-empty {
            padding: var(--space-4);
            text-align: center;
            color: var(--text-muted);
            font-size: var(--text-sm);
        }
        
        /* ============================================
           Phase 11.5: Active Device Indicator Bar
           ============================================ */
        .active-device-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: linear-gradient(135deg, var(--neon-cyan-subtle), var(--neon-magenta-subtle));
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
        }
        .active-device-bar.control {
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.1), rgba(0, 255, 159, 0.05));
            border-left: 3px solid var(--neon-cyan);
        }
        .active-device-bar.config {
            background: linear-gradient(135deg, rgba(255, 0, 229, 0.1), rgba(255, 184, 0, 0.05));
            border-left: 3px solid var(--neon-magenta);
        }
        .adb-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .adb-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--neon-cyan);
            stroke-width: 2;
            fill: none;
        }
        .active-device-bar.config .adb-icon svg {
            stroke: var(--neon-magenta);
        }
        .adb-action {
            font-family: var(--font-display);
            font-size: var(--text-xs);
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--neon-cyan);
        }
        .active-device-bar.config .adb-action {
            color: var(--neon-magenta);
        }
        .adb-serial {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-primary);
        }
        .adb-nickname {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }
        .adb-separator {
            color: var(--border-default);
        }
        .adb-detail {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--text-muted);
        }
        .adb-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            margin-left: auto;
        }
        .adb-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .adb-status.online .status-dot { background: var(--status-success); box-shadow: 0 0 6px var(--status-success); }
        .adb-status.online { color: var(--status-success); }
        .adb-status.offline .status-dot { background: var(--status-danger); }
        .adb-status.offline { color: var(--status-danger); }
        .adb-status.unknown .status-dot { background: var(--text-muted); }
        .adb-status.unknown { color: var(--text-muted); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .devices-header { flex-direction: column; align-items: stretch; }
            .devices-search { min-width: 100%; }
            .devices-actions { justify-content: center; }
            .device-table-container { overflow-x: auto; }
            .device-table { min-width: 600px; }
            .device-modal-actions { flex-direction: column; }
            .device-modal-actions-left, .device-modal-actions-right { justify-content: center; }
        }
        
        /* ============================================
           Phase 11.3: Multi-Device Monitor
           ============================================ */
        
        /* Monitor Status Badge in Sidebar */
        .monitor-status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            padding: 2px 6px;
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 600;
            background: var(--bg-elevated);
            color: var(--text-muted);
            border-radius: 10px;
            margin-left: auto;
        }
        .monitor-status-badge.has-warning {
            background: rgba(255, 184, 0, 0.2);
            color: var(--status-warning);
        }
        .monitor-status-badge.has-danger {
            background: rgba(255, 51, 102, 0.2);
            color: var(--status-danger);
            animation: pulse-danger 2s infinite;
        }
        @keyframes pulse-danger {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Monitor Status Badge - All Online State */
        .monitor-status-badge.all-online {
            background: rgba(0, 255, 159, 0.2);
            color: var(--status-success);
        }
        
        /* Monitor Status Badge - Collapsed Sidebar (show colored dot) */
        .sidebar.collapsed .monitor-status-badge {
            width: 10px;
            height: 10px;
            min-width: 10px;
            padding: 0;
            font-size: 0;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .sidebar.collapsed .monitor-status-badge.all-online {
            background: var(--status-success);
            box-shadow: 0 0 6px var(--status-success);
        }
        .sidebar.collapsed .monitor-status-badge.has-warning {
            background: var(--status-warning);
            box-shadow: 0 0 6px var(--status-warning);
        }
        .sidebar.collapsed .monitor-status-badge.has-danger {
            background: var(--status-danger);
            box-shadow: 0 0 6px var(--status-danger);
            animation: pulse-danger 2s infinite;
        }
        
        /* Monitor Summary Bar */
        .monitor-summary {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
        }
        .monitor-stat {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }
        .monitor-stat-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .monitor-stat-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        .monitor-stat-value {
            font-family: var(--font-mono);
            font-size: var(--text-lg);
            font-weight: 700;
        }
        .monitor-stat-label {
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .monitor-stat.total .monitor-stat-icon { color: var(--neon-cyan); }
        .monitor-stat.total .monitor-stat-value { color: var(--neon-cyan); }
        .monitor-stat.online .monitor-stat-icon { color: var(--status-success); }
        .monitor-stat.online .monitor-stat-value { color: var(--status-success); }
        .monitor-stat.warning .monitor-stat-icon { color: var(--status-warning); }
        .monitor-stat.warning .monitor-stat-value { color: var(--status-warning); }
        .monitor-stat.danger .monitor-stat-icon { color: var(--status-danger); }
        .monitor-stat.danger .monitor-stat-value { color: var(--status-danger); }
        .monitor-stat.offline .monitor-stat-icon { color: var(--status-danger); }
        .monitor-stat.offline .monitor-stat-value { color: var(--status-danger); }
        
        /* Monitor Toolbar */
        .monitor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            align-items: center;
        }
        .monitor-filter-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .monitor-filter-label {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .monitor-select {
            padding: var(--space-2) var(--space-3);
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            color: var(--text-primary);
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            cursor: pointer;
            min-width: 120px;
        }
        .monitor-select:focus {
            outline: none;
            border-color: var(--neon-cyan);
        }
        .monitor-refresh-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-left: auto;
        }
        .monitor-refresh-btn:hover {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }
        .monitor-refresh-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        .monitor-refresh-btn.spinning svg {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Monitor Grid */
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }
        @media (max-width: 1400px) {
            .monitor-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 1024px) {
            .monitor-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            .monitor-grid { grid-template-columns: 1fr; }
        }
        
        /* Monitor Group Header */
        .monitor-group {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) 0;
            margin-top: var(--space-2);
        }
        .monitor-group:first-child {
            margin-top: 0;
        }
        .monitor-group-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .monitor-group-icon svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        .monitor-group.online .monitor-group-icon { background: rgba(0, 255, 159, 0.2); color: var(--status-success); }
        .monitor-group.warning .monitor-group-icon { background: rgba(255, 184, 0, 0.2); color: var(--status-warning); }
        .monitor-group.offline .monitor-group-icon { background: rgba(255, 51, 102, 0.2); color: var(--status-danger); }
        .monitor-group-title {
            font-family: var(--font-display);
            font-size: var(--text-sm);
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .monitor-group.online .monitor-group-title { color: var(--status-success); }
        .monitor-group.warning .monitor-group-title { color: var(--status-warning); }
        .monitor-group.offline .monitor-group-title { color: var(--status-danger); }
        .monitor-group-count {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .monitor-group-line {
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }
        
        /* Device Monitor Card */
        .monitor-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        .monitor-card:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 240, 255, 0.1);
        }
        .monitor-card.warning {
            border-color: var(--status-warning);
            box-shadow: 0 0 0 1px rgba(255, 184, 0, 0.3);
        }
        .monitor-card.warning:hover {
            box-shadow: 0 4px 20px rgba(255, 184, 0, 0.2);
        }
        .monitor-card.danger {
            border-color: var(--status-danger);
            box-shadow: 0 0 0 1px rgba(255, 51, 102, 0.3);
            animation: card-pulse-danger 2s infinite;
        }
        @keyframes card-pulse-danger {
            0%, 100% { box-shadow: 0 0 0 1px rgba(255, 51, 102, 0.3); }
            50% { box-shadow: 0 0 0 3px rgba(255, 51, 102, 0.2), 0 0 15px rgba(255, 51, 102, 0.1); }
        }
        .monitor-card.offline {
            opacity: 0.7;
        }
        .monitor-card.offline:hover {
            border-color: var(--status-danger);
            opacity: 1;
        }
        
        /* Card Header */
        .monitor-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            gap: var(--space-2);
        }
        .monitor-card-info {
            flex: 1;
            min-width: 0;
        }
        .monitor-card-name {
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .monitor-card-serial {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--text-muted);
        }
        .monitor-card-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            flex-shrink: 0;
        }
        .monitor-card-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .monitor-card-dot.online {
            background: var(--status-success);
            box-shadow: 0 0 8px var(--status-success);
        }
        .monitor-card-dot.warning {
            background: var(--status-warning);
            box-shadow: 0 0 8px var(--status-warning);
        }
        .monitor-card-dot.danger {
            background: var(--status-danger);
            box-shadow: 0 0 8px var(--status-danger);
            animation: dot-pulse 1.5s infinite;
        }
        @keyframes dot-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .monitor-card-dot.offline {
            background: var(--status-danger);
            opacity: 0.5;
        }
        .monitor-card-state {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            background: var(--bg-elevated);
            color: var(--text-muted);
        }
        .monitor-card-state.pressurise { background: rgba(0, 240, 255, 0.15); color: var(--neon-cyan); }
        .monitor-card-state.boost { background: rgba(255, 0, 229, 0.15); color: var(--neon-magenta); }
        .monitor-card-state.purge { background: rgba(255, 230, 0, 0.15); color: var(--neon-yellow); }
        
        /* Card Metrics */
        .monitor-card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        .monitor-metric {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
        }
        .monitor-metric-icon {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        .monitor-metric-icon svg {
            width: 12px;
            height: 12px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        .monitor-metric-value {
            font-family: var(--font-mono);
            font-weight: 500;
            color: var(--text-primary);
        }
        .monitor-metric-unit {
            color: var(--text-muted);
            font-size: 0.65rem;
        }
        .monitor-metric.warning .monitor-metric-value { color: var(--status-warning); }
        .monitor-metric.danger .monitor-metric-value { color: var(--status-danger); }
        .monitor-metric.warning .monitor-metric-icon { color: var(--status-warning); }
        .monitor-metric.danger .monitor-metric-icon { color: var(--status-danger); }
        
        /* Loading State for Metrics */
        .monitor-metric.loading .monitor-metric-value {
            color: var(--text-muted);
            animation: metric-loading-pulse 1.5s ease-in-out infinite;
        }
        @keyframes metric-loading-pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        /* New Card Indicator (waiting for data) */
        .monitor-card.new-device::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
            animation: card-new-shimmer 2s infinite;
        }
        @keyframes card-new-shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Card Footer */
        .monitor-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: var(--space-2);
            border-top: 1px solid var(--border-subtle);
        }
        .monitor-card-fan {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
        }
        .monitor-fan-mode {
            font-family: var(--font-mono);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 0.6rem;
            text-transform: uppercase;
        }
        .monitor-fan-mode.auto { background: rgba(0, 255, 159, 0.15); color: var(--status-success); }
        .monitor-fan-mode.custom { background: rgba(255, 0, 229, 0.15); color: var(--neon-magenta); }
        .monitor-fan-speed {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* RSSI Signal Bars */
        .monitor-rssi {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 14px;
        }
        .monitor-rssi-bar {
            width: 3px;
            background: var(--border-default);
            border-radius: 1px;
            transition: background var(--transition-fast);
        }
        .monitor-rssi-bar:nth-child(1) { height: 4px; }
        .monitor-rssi-bar:nth-child(2) { height: 6px; }
        .monitor-rssi-bar:nth-child(3) { height: 8px; }
        .monitor-rssi-bar:nth-child(4) { height: 10px; }
        .monitor-rssi-bar:nth-child(5) { height: 14px; }
        .monitor-rssi-bar.active { background: var(--status-success); }
        .monitor-rssi.weak .monitor-rssi-bar.active { background: var(--status-warning); }
        .monitor-rssi.poor .monitor-rssi-bar.active { background: var(--status-danger); }
        
        /* Sensor Age Indicator */
        .monitor-age {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .monitor-age-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--status-success);
        }
        .monitor-age.aging .monitor-age-dot { background: var(--status-warning); }
        .monitor-age.stale .monitor-age-dot { background: var(--status-danger); }
        .monitor-age.aging { color: var(--status-warning); }
        .monitor-age.stale { color: var(--status-danger); }
        
        /* Monitor Empty State */
        .monitor-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: var(--space-8);
        }
        .monitor-empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            stroke: var(--text-muted);
            stroke-width: 1.5;
            fill: none;
            opacity: 0.5;
        }
        .monitor-empty-title {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }
        .monitor-empty-text {
            color: var(--text-muted);
            font-size: var(--text-sm);
            margin-bottom: var(--space-4);
        }
        
        /* Last Seen Text */
        .monitor-lastseen {
            font-size: var(--text-xs);
            color: var(--text-muted);
            font-style: italic;
        }
        
        /* Monitor Responsive */
        @media (max-width: 768px) {
            .monitor-toolbar { flex-direction: column; align-items: stretch; }
            .monitor-filter-group { justify-content: space-between; }
            .monitor-refresh-btn { margin-left: 0; justify-content: center; }
            .monitor-summary { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="bg-grid"></div>
    <div class="particles">
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div>
    </div>
    <div class="scanline"></div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <svg class="sidebar-logo-icon" viewBox="0 0 60 60">
                        <polygon points="30,5 55,20 55,45 30,55 5,45 5,20"/>
                        <polygon points="30,15 45,24 45,40 30,48 15,40 15,24"/>
                        <circle cx="30" cy="30" r="6"/>
                    </svg>
                    <span class="sidebar-logo-text">BE-TPP</span>
                </a>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <ul class="nav-list">
                        <li><a href="#" class="nav-item active" data-tab="overview">
                            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                            <span class="nav-label">Overview</span>
                        </a></li>
                        <li><a href="#" class="nav-item" data-tab="control">
                            <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            <span class="nav-label">Control Center</span>
                        </a></li>
                        <li><a href="#" class="nav-item" data-tab="devices">
                            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="12" y2="17"/></svg>
                            <span class="nav-label">Devices</span>
                            <span class="device-count-badge" id="deviceCountBadge">0</span>
                        </a></li>
                        <li><a href="#" class="nav-item" data-tab="monitor">
                            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><circle cx="7" cy="10" r="1.5"/><circle cx="12" cy="10" r="1.5"/><circle cx="17" cy="10" r="1.5"/></svg>
                            <span class="nav-label">Monitor</span>
                            <span class="monitor-status-badge" id="monitorStatusBadge">--</span>
                        </a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <ul class="nav-list">
                        <li><a href="#" class="nav-item" data-tab="logs">
                            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            <span class="nav-label">Message Logs</span>
                        </a></li>
                        <li><a href="#" class="nav-item" data-tab="config">
                            <svg class="nav-icon" viewBox="0 0 24 24"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/></svg>
                            <span class="nav-label">Configuration</span>
                        </a></li>
                    </ul>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-card" id="userCard">
                    <div class="user-avatar">OP</div>
                    <div class="user-info">
                        <div class="user-name">Operator</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <main class="main">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <h1 class="page-title" id="pageTitle">Overview</h1>
                    
                    <!-- Phase 11.2: Device Switcher Dropdown -->
                    <div class="device-switcher" id="deviceSwitcher">
                        <button class="device-switcher-btn" id="deviceSwitcherBtn">
                            <svg class="device-switcher-icon" viewBox="0 0 24 24">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                <line x1="8" y1="21" x2="16" y2="21"/>
                                <line x1="12" y1="17" x2="12" y2="21"/>
                            </svg>
                            <div class="device-switcher-info">
                                <div class="device-switcher-serial" id="switcherSerial">No Device</div>
                                <div class="device-switcher-name" id="switcherName">Select a device</div>
                            </div>
                            <div class="device-switcher-status unknown" id="switcherStatus"></div>
                            <svg class="device-switcher-arrow" viewBox="0 0 24 24">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        <div class="device-switcher-menu" id="deviceSwitcherMenu">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <!-- Phase 12: PWA Install Button -->
                    <button class="pwa-install-btn" id="pwaInstallBtn" title="Install App">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span>Install</span>
                    </button>
                    
                    <!-- Phase 11.4: Sound/Mute Toggle -->
                    <button class="header-btn sound-toggle" id="soundToggle" title="Mute/Unmute Alert Sounds">
                        <svg class="icon-sound-on" viewBox="0 0 24 24">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                        <svg class="icon-sound-off" viewBox="0 0 24 24">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <line x1="23" y1="9" x2="17" y2="15"/>
                            <line x1="17" y1="9" x2="23" y2="15"/>
                        </svg>
                    </button>
                    <button class="theme-toggle" id="themeToggle">
                        <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                    <button class="header-btn" id="logoutBtn">
                        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </button>
                </div>
            </header>
            
            <div class="content">
                <!-- Connection Panel -->
                <div class="connection-panel">
                    <div class="connection-header">
                        <div class="connection-status">
                            <div class="status-indicator">
                                <div class="status-dot" id="mqttStatusDot"></div>
                                <span id="mqttStatusText">Disconnected</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-dot" id="dataStatusDot"></div>
                                <span id="dataStatusText">No Data</span>
                            </div>
                            <!-- Phase 7: Internet Status Indicator -->
                            <div class="status-indicator">
                                <svg class="internet-icon" id="internetIcon" viewBox="0 0 24 24" width="16" height="16">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                                <span id="internetStatusText">Checking...</span>
                            </div>
                        </div>
                        <div class="connection-actions">
                            <button class="btn btn-primary" id="btnConnect">
                                <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                <span>Connect</span>
                            </button>
                            <button class="btn btn-ghost" id="btnDisconnect" disabled>
                                <svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                <span>Disconnect</span>
                            </button>
                        </div>
                    </div>
                    <div class="connection-form">
                        <div class="form-group">
                            <label class="form-label">Broker URL</label>
                            <input type="text" class="form-input" id="brokerUrl" value="wss://v51110b0.ala.eu-central-1.emqxsl.com:8084/mqtt">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-input" id="mqttUsername" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="mqttPassword" placeholder="********">
                        </div>
                        <div class="form-group">
                            <label class="form-label">QP Serial</label>
                            <input type="text" class="form-input" id="qpSerial" value="582D347068FB">
                        </div>
                        <!-- FIX: Separate Device Client ID and Web Client ID -->
                        <div class="form-group">
                            <label class="form-label">Device Client ID</label>
                            <input type="text" class="form-input" id="deviceClientId" placeholder="ESP32 Client ID for topics">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Web Client ID</label>
                            <input type="text" class="form-input" id="webClientId" readonly placeholder="Auto-generated">
                        </div>
                    </div>
                </div>
                
                <!-- Overview Tab -->
                <div class="tab-panel active" id="tab-overview">
                    <!-- B.3: Empty State when disconnected -->
                    <div class="overview-empty-state" id="overviewEmptyState">
                        <svg class="overview-empty-icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <div class="overview-empty-title">No Connection</div>
                        <p class="overview-empty-text">Connect to MQTT broker to see real-time device data and controls.</p>
                        <span class="overview-empty-hint">Use the connection panel above</span>
                    </div>
                    
                    <div class="bento-grid">
                        <!-- Status Cards -->
                        <div class="card stat-card">
                            <div class="stat-header">
                                <div class="stat-icon"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
                                <div class="stat-badges">
                                    <span class="stat-badge offline" id="deviceStatusBadge">OFFLINE</span>
                                    <span class="stat-badge fan-state" id="fanStateBadge">--</span>
                                </div>
                            </div>
                            <div class="stat-value"><span id="fanSpeedValue">--</span><span class="unit">%</span></div>
                            <div class="stat-label">Fan Speed</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-header">
                                <div class="stat-icon magenta"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/></svg></div>
                                <span class="stat-badge auto" id="fanModeBadge">--</span>
                            </div>
                            <div class="stat-value" id="fanModeValue">--</div>
                            <div class="stat-label">Fan Mode</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green"><svg viewBox="0 0 24 24"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg></div>
                                <!-- Phase 7: Signal Bars -->
                                <div class="signal-bars" id="signalBars">
                                    <div class="signal-bar" data-level="1"></div>
                                    <div class="signal-bar" data-level="2"></div>
                                    <div class="signal-bar" data-level="3"></div>
                                    <div class="signal-bar" data-level="4"></div>
                                </div>
                            </div>
                            <div class="stat-value"><span id="rssiValue">--</span><span class="unit">dBm</span></div>
                            <div class="stat-label">WiFi Signal</div>
                        </div>
                        <div class="card stat-card">
                            <div class="stat-header">
                                <div class="stat-icon yellow"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                            </div>
                            <div class="stat-value" id="uptimeValue">--</div>
                            <div class="stat-label">Uptime</div>
                        </div>
                        
                        <!-- Device Info -->
                        <div class="card span-2">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                                    Device Information
                                </h3>
                            </div>
                            <div class="data-grid">
                                <div class="data-item"><span class="data-label">Serial</span><span class="data-value" id="infoSerial">--</span></div>
                                <div class="data-item"><span class="data-label">Client ID</span><span class="data-value" id="infoClientId">--</span></div>
                                <div class="data-item"><span class="data-label">Firmware</span><span class="data-value" id="infoFirmware">--</span></div>
                                <div class="data-item"><span class="data-label">ESP Temp</span><span class="data-value" id="infoEspTemp">--</span></div>
                                <div class="data-item"><span class="data-label">Free Heap</span><span class="data-value" id="infoHeap">--</span></div>
                                <div class="data-item"><span class="data-label">Last Update</span><span class="data-value" id="infoLastUpdate">--</span></div>
                            </div>
                        </div>
                        <div class="card span-2">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/></svg>
                                    Speed Configuration
                                </h3>
                            </div>
                            <div class="data-grid">
                                <div class="data-item"><span class="data-label">Speed Map</span><span class="data-value" id="infoSpeedMap">--</span></div>
                                <div class="data-item"><span class="data-label">Steady Levels</span><span class="data-value" id="infoSteadyLevels">--</span></div>
                                <div class="data-item"><span class="data-label">Steady Index</span><span class="data-value" id="infoSteadyIndex">--</span></div>
                                <div class="data-item"><span class="data-label">EMA Alpha</span><span class="data-value" id="infoEmaAlpha">--</span></div>
                            </div>
                        </div>
                        
                        <!-- Sensor Section Header -->
                        <div class="section-header span-4">
                            <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span>Air Quality Sensors</span>
                            <div class="section-line"></div>
                            <span class="sensor-timestamp" id="sensorTimestamp">No data</span>
                            <!-- Phase 9.3: Sensor Age Badge with Tooltip -->
                            <span class="sensor-age-badge" id="sensorAgeBadge" title="Click for details">
                                <span class="age-text" id="sensorAgeText">--</span>
                                <span class="age-status" id="sensorAgeStatus">FRESH</span>
                                <div class="sensor-age-tooltip">
                                    <div class="tooltip-row"><span class="tooltip-label">Sensor Read:</span><span class="tooltip-value" id="tooltipSensorAge">--</span></div>
                                    <div class="tooltip-row"><span class="tooltip-label">Dashboard:</span><span class="tooltip-value" id="tooltipDashboardAge">--</span></div>
                                    <div class="tooltip-row"><span class="tooltip-label">Total Lag:</span><span class="tooltip-value" id="tooltipTotalLag">--</span></div>
                                </div>
                            </span>
                        </div>
                        
                        <!-- PM2.5 -->
                        <div class="card stat-card sensor-card" id="cardPm25">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></div>
                                <span class="quality-badge" id="pm25Quality">--</span>
                            </div>
                            <div class="stat-value"><span id="pm25Value">--</span><span class="unit">ug/m&sup3;</span></div>
                            <div class="stat-label">PM2.5</div>
                            <div class="ema-value" id="pm25Ema">EMA: --</div>
                            <div class="sensor-bar"><div class="sensor-bar-fill" id="pm25Bar"></div></div>
                        </div>
                        
                        <!-- CO2 -->
                        <div class="card stat-card sensor-card" id="cardCo2">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon co2"><svg viewBox="0 0 24 24"><path d="M4 19h16M4 15h16M4 11h16M4 7h16"/></svg></div>
                                <span class="quality-badge" id="co2Quality">--</span>
                            </div>
                            <div class="stat-value"><span id="co2Value">--</span><span class="unit">ppm</span></div>
                            <div class="stat-label">CO<sub>2</sub></div>
                            <div class="ema-value" id="co2Ema">EMA: --</div>
                            <div class="sensor-bar"><div class="sensor-bar-fill" id="co2Bar"></div></div>
                        </div>
                        
                        <!-- Temperature -->
                        <div class="card stat-card sensor-card" id="cardTemp">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon temp"><svg viewBox="0 0 24 24"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg></div>
                                <span class="quality-badge" id="tempQuality">--</span>
                            </div>
                            <div class="stat-value"><span id="tempValue">--</span><span class="unit">&deg;C</span></div>
                            <div class="stat-label">Temperature</div>
                        </div>
                        
                        <!-- Humidity -->
                        <div class="card stat-card sensor-card" id="cardHumidity">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon humidity"><svg viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div>
                                <span class="quality-badge" id="humidityQuality">--</span>
                            </div>
                            <div class="stat-value"><span id="humidityValue">--</span><span class="unit">%</span></div>
                            <div class="stat-label">Humidity</div>
                        </div>
                        
                        <!-- PM10 -->
                        <div class="card stat-card sensor-card" id="cardPm10">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon pm10"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/></svg></div>
                                <span class="quality-badge" id="pm10Quality">--</span>
                            </div>
                            <div class="stat-value"><span id="pm10Value">--</span><span class="unit">ug/m&sup3;</span></div>
                            <div class="stat-label">PM10</div>
                            <div class="sensor-bar"><div class="sensor-bar-fill" id="pm10Bar"></div></div>
                        </div>
                        
                        <!-- TVOC -->
                        <div class="card stat-card sensor-card" id="cardTvoc">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon tvoc"><svg viewBox="0 0 24 24"><path d="M12 3v18M5.5 8l13 8M5.5 16l13-8"/></svg></div>
                                <span class="quality-badge" id="tvocQuality">--</span>
                            </div>
                            <div class="stat-value"><span id="tvocValue">--</span><span class="unit">idx</span></div>
                            <div class="stat-label">TVOC Index</div>
                            <div class="sensor-bar"><div class="sensor-bar-fill" id="tvocBar"></div></div>
                        </div>
                        
                        <!-- Noise -->
                        <div class="card stat-card sensor-card" id="cardNoise">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon noise"><svg viewBox="0 0 24 24"><path d="M12 6v12M8 9v6M16 9v6M4 10v4M20 10v4"/></svg></div>
                            </div>
                            <div class="stat-value"><span id="noiseValue">--</span><span class="unit">dB</span></div>
                            <div class="stat-label">Noise Level</div>
                        </div>
                        
                        <!-- Sensor Status -->
                        <div class="card stat-card sensor-card" id="cardSensorStatus">
                            <div class="stat-header">
                                <div class="stat-icon sensor-icon status"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                                <span class="stat-badge offline" id="sensorStatusBadge">NO DATA</span>
                            </div>
                            <div class="stat-value" id="sensorAgeValue">--</div>
                            <div class="stat-label">Sensor Age</div>
                        </div>
                        
                        <!-- Charts Section Header -->
                        <div class="section-header span-4">
                            <svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                            <span>Real-Time Charts</span>
                            <div class="section-line"></div>
                            <!-- Phase 8: Display Sensors/Fan data points -->
                            <span class="chart-info" id="sensorDataPoints">Sensors: 0/60</span>
                            <span class="chart-info" id="fanDataPoints">Fan: 0/20</span>
                        </div>
                        
                        <!-- PM2.5 Chart -->
                        <div class="card chart-card span-2">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                                    PM2.5 Trend
                                </h3>
                                <span class="chart-badge" id="pm25ChartBadge">--</span>
                            </div>
                            <div class="chart-container" id="chartPm25"></div>
                        </div>
                        
                        <!-- CO2 Chart -->
                        <div class="card chart-card span-2">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><path d="M4 19h16M4 15h16M4 11h16M4 7h16"/></svg>
                                    CO<sub>2</sub> Trend
                                </h3>
                                <span class="chart-badge" id="co2ChartBadge">--</span>
                            </div>
                            <div class="chart-container" id="chartCo2"></div>
                        </div>
                        
                        <!-- Temperature & Humidity Chart -->
                        <div class="card chart-card span-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
                                    Temperature & Humidity
                                </h3>
                            </div>
                            <div class="chart-container chart-wide" id="chartTempHum"></div>
                        </div>
                        
                        <!-- Fan Speed Chart - Phase 6 -->
                        <div class="card chart-card span-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 10c-1.1 0-2-.9-2-2h4c0 1.1-.9 2-2 2zm4-6h-8v2h8v-2z"/></svg>
                                    Fan Speed Trend
                                </h3>
                                <span class="chart-badge" id="fanSpeedChartBadge">--%</span>
                            </div>
                            <div class="chart-container chart-wide" id="chartFanSpeed"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Control Tab - Phase 9: Control Center Polish -->
                <div class="tab-panel" id="tab-control">
                    <!-- Phase 11.5: Active Device Indicator Bar -->
                    <div class="active-device-bar control" id="activeDeviceBarControl">
                        <div class="adb-icon">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                        </div>
                        <span class="adb-action">CONTROLLING:</span>
                        <span class="adb-serial">--</span>
                        <span class="adb-nickname"></span>
                        <span class="adb-separator">|</span>
                        <span class="adb-detail">Client: --</span>
                        <div class="adb-status unknown">
                            <div class="status-dot"></div>
                            <span>Unknown</span>
                        </div>
                    </div>
                    
                    <div class="bento-grid">
                        <!-- Operation Mode - Toggle Switch -->
                        <div class="card span-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/></svg>
                                    Operation Mode
                                </h3>
                                <span class="stat-badge auto" id="currentModeBadge">--</span>
                            </div>
                            <div class="mode-toggle-container">
                                <span class="mode-toggle-label active" id="labelAuto">AUTOMATIC</span>
                                <div class="mode-toggle" id="modeToggle">
                                    <div class="mode-toggle-knob"></div>
                                </div>
                                <span class="mode-toggle-label" id="labelCustom">CUSTOM</span>
                            </div>
                        </div>
                        
                        <!-- Fan Speed Control - Buttons + Slider -->
                        <div class="card span-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                    Fan Speed Control
                                </h3>
                                <span class="stat-badge" id="currentSpeedBadge">--</span>
                            </div>
                            <div class="control-section">
                                <div class="speed-grid">
                                    <button class="speed-btn" data-speed="0">OFF</button>
                                    <button class="speed-btn" data-speed="1">1</button>
                                    <button class="speed-btn" data-speed="2">2</button>
                                    <button class="speed-btn" data-speed="3">3</button>
                                    <button class="speed-btn" data-speed="4">4</button>
                                    <button class="speed-btn" data-speed="5">5</button>
                                </div>
                                <!-- Speed Slider Visual -->
                                <div class="speed-slider-container">
                                    <div class="speed-slider-track">
                                        <div class="speed-slider-fill" id="speedSliderFill"></div>
                                        <div class="speed-slider-knob" id="speedSliderKnob"></div>
                                    </div>
                                    <div class="speed-slider-value"><span id="speedSliderValue">0</span>%</div>
                                    <div class="speed-slider-labels">
                                        <span>OFF</span>
                                        <span>20%</span>
                                        <span>40%</span>
                                        <span>60%</span>
                                        <span>80%</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="card span-4">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                    Quick Actions
                                </h3>
                            </div>
                            <div class="quick-actions-grid">
                                <button class="quick-action-btn qa-off" id="qaOff" data-mode="custom" data-speed="0">
                                    <span class="qa-icon">&#x2B55;</span>
                                    <span class="qa-label">OFF</span>
                                </button>
                                <button class="quick-action-btn qa-sleep" id="qaSleep" data-mode="custom" data-speed="1">
                                    <span class="qa-icon">&#x1F319;</span>
                                    <span class="qa-label">Sleep</span>
                                </button>
                                <button class="quick-action-btn qa-eco" id="qaEco" data-mode="custom" data-speed="2">
                                    <span class="qa-icon">&#x1F343;</span>
                                    <span class="qa-label">Eco</span>
                                </button>
                                <button class="quick-action-btn qa-turbo" id="qaTurbo" data-mode="custom" data-speed="5">
                                    <span class="qa-icon">&#x1F4A8;</span>
                                    <span class="qa-label">Turbo</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- System -->
                        <div class="card span-2">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                    System
                                </h3>
                            </div>
                            <div class="system-actions">
                                <button class="btn btn-danger" id="btnReboot">
                                    <svg viewBox="0 0 24 24"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                                    <span>Reboot Device</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Phase 9.4: Diagnostic Panel -->
                        <div class="card span-2">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                    Diagnostics
                                </h3>
                            </div>
                            <div class="diag-grid">
                                <button class="diag-btn" id="btnDiagPing">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                    <span class="diag-btn-label">Ping</span>
                                </button>
                                <button class="diag-btn" id="btnDiagStatus">
                                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                                    <span class="diag-btn-label">Get Status</span>
                                </button>
                                <button class="diag-btn" id="btnDiagConfig">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                    <span class="diag-btn-label">Get Config</span>
                                </button>
                                <button class="diag-btn danger" id="btnFactoryReset">
                                    <svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                    <span class="diag-btn-label">Factory Reset</span>
                                </button>
                            </div>
                            <div class="diag-result">
                                <span class="diag-result-label">Last Ping:</span>
                                <span class="diag-result-value pending" id="diagLastPing">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Devices Tab - Phase 11.1 -->
                <div class="tab-panel" id="tab-devices">
                    <!-- Header with Search and Actions -->
                    <div class="devices-header">
                        <div class="devices-search">
                            <svg class="devices-search-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <input type="text" class="devices-search-input" id="deviceSearchInput" placeholder="Search QP Serial, Client ID, or Nickname...">
                        </div>
                        <div class="devices-actions">
                            <button class="btn btn-primary" id="btnAddDevice">
                                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                <span>Add Device</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Bar -->
                    <div class="devices-stats">
                        <div class="devices-stat">
                            <span class="devices-stat-value" id="statTotalDevices">0</span>
                            <span class="devices-stat-label">Total Devices</span>
                        </div>
                        <div class="devices-stat online">
                            <span class="devices-stat-value" id="statOnlineDevices">0</span>
                            <span class="devices-stat-label">Online</span>
                        </div>
                        <div class="devices-stat offline">
                            <span class="devices-stat-value" id="statOfflineDevices">0</span>
                            <span class="devices-stat-label">Offline</span>
                        </div>
                    </div>
                    
                    <!-- Device Table -->
                    <div class="device-table-container">
                        <table class="device-table">
                            <thead>
                                <tr>
                                    <th data-sort="status" class="sorted">Status <span class="sort-icon">v</span></th>
                                    <th data-sort="qpSerial">QP Serial <span class="sort-icon">-</span></th>
                                    <th data-sort="qpNickname">Nickname <span class="sort-icon">-</span></th>
                                    <th data-sort="clientId">Client ID <span class="sort-icon">-</span></th>
                                    <th data-sort="lastSeen">Last Seen <span class="sort-icon">-</span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deviceTableBody">
                                <!-- Device rows will be inserted here -->
                            </tbody>
                        </table>
                        <!-- Empty State -->
                        <div class="device-empty" id="deviceEmptyState" style="display: none;">
                            <svg class="device-empty-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="13" x2="15" y2="13"/></svg>
                            <p class="device-empty-text">No devices registered yet</p>
                            <button class="btn btn-primary" id="btnAddDeviceEmpty">
                                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                <span>Add First Device</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Import/Export Section -->
                    <div class="import-export-section">
                        <h3 class="import-export-title">
                            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Import / Export
                        </h3>
                        <div class="import-export-grid">
                            <button class="import-export-btn" id="btnImportCSV">
                                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                <span>Import CSV</span>
                            </button>
                            <button class="import-export-btn" id="btnImportJSON">
                                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                <span>Import JSON</span>
                            </button>
                            <button class="import-export-btn" id="btnExportCSV">
                                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                <span>Export CSV</span>
                            </button>
                            <button class="import-export-btn" id="btnExportJSON">
                                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                <span>Export JSON</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hidden file inputs -->
                    <input type="file" class="hidden-input" id="importCSVFile" accept=".csv">
                    <input type="file" class="hidden-input" id="importJSONFile" accept=".json">
                </div>
                
                <!-- Monitor Tab - Phase 11.3: Multi-Device Monitor -->
                <div class="tab-panel" id="tab-monitor">
                    <!-- Summary Bar -->
                    <div class="monitor-summary">
                        <div class="monitor-stat total">
                            <div class="monitor-stat-icon">
                                <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                            </div>
                            <div>
                                <div class="monitor-stat-value" id="monitorTotal">0</div>
                                <div class="monitor-stat-label">Total</div>
                            </div>
                        </div>
                        <div class="monitor-stat online">
                            <div class="monitor-stat-icon">
                                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div>
                                <div class="monitor-stat-value" id="monitorOnline">0</div>
                                <div class="monitor-stat-label">Online</div>
                            </div>
                        </div>
                        <div class="monitor-stat warning">
                            <div class="monitor-stat-icon">
                                <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            </div>
                            <div>
                                <div class="monitor-stat-value" id="monitorWarning">0</div>
                                <div class="monitor-stat-label">Warning</div>
                            </div>
                        </div>
                        <!-- Phase 11.4: Danger Stat -->
                        <div class="monitor-stat danger">
                            <div class="monitor-stat-icon">
                                <svg viewBox="0 0 24 24"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </div>
                            <div>
                                <div class="monitor-stat-value" id="monitorDanger">0</div>
                                <div class="monitor-stat-label">Danger</div>
                            </div>
                        </div>
                        <div class="monitor-stat offline">
                            <div class="monitor-stat-icon">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </div>
                            <div>
                                <div class="monitor-stat-value" id="monitorOffline">0</div>
                                <div class="monitor-stat-label">Offline</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toolbar -->
                    <div class="monitor-toolbar">
                        <div class="monitor-filter-group">
                            <span class="monitor-filter-label">Filter:</span>
                            <select class="monitor-select" id="monitorFilter">
                                <option value="all">All Devices</option>
                                <option value="online">Online Only</option>
                                <option value="warning">Warning Only</option>
                                <option value="offline">Offline Only</option>
                            </select>
                        </div>
                        <div class="monitor-filter-group">
                            <span class="monitor-filter-label">Group:</span>
                            <select class="monitor-select" id="monitorGroup">
                                <option value="status">By Status</option>
                                <option value="none">No Grouping</option>
                            </select>
                        </div>
                        <div class="monitor-filter-group">
                            <span class="monitor-filter-label">Sort:</span>
                            <select class="monitor-select" id="monitorSort">
                                <option value="status">Status</option>
                                <option value="name">Name</option>
                                <option value="serial">Serial</option>
                                <option value="pm25">PM2.5</option>
                                <option value="co2">CO2</option>
                            </select>
                        </div>
                        <button class="monitor-refresh-btn" id="btnMonitorRefresh" title="Refresh">
                            <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                    
                    <!-- Device Cards Grid -->
                    <div class="monitor-grid" id="monitorGrid">
                        <!-- Empty State (shown when no devices) -->
                        <div class="monitor-empty" id="monitorEmptyState">
                            <svg class="monitor-empty-icon" viewBox="0 0 24 24">
                                <rect x="2" y="3" width="20" height="14" rx="2"/>
                                <line x1="8" y1="21" x2="16" y2="21"/>
                                <line x1="12" y1="17" x2="12" y2="21"/>
                                <line x1="7" y1="10" x2="17" y2="10"/>
                            </svg>
                            <div class="monitor-empty-title">No Devices to Monitor</div>
                            <p class="monitor-empty-text">Register devices in the Devices tab and connect to MQTT to start monitoring.</p>
                            <button class="btn btn-primary" onclick="switchToDevicesTab()">
                                <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                <span>Add Devices</span>
                            </button>
                        </div>
                        
                        <!-- Device cards will be rendered here dynamically -->
                    </div>
                </div>
                
                <!-- Logs Tab -->
                <div class="tab-panel" id="tab-logs">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                MQTT Message Log
                            </h3>
                            <button class="btn btn-ghost" id="btnClearLogs">
                                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                <span>Clear</span>
                            </button>
                        </div>
                        <div class="log-viewer" id="logViewer">
                            <div class="log-entry"><span class="log-time">--:--:--</span><span class="log-message">Waiting for messages...</span></div>
                        </div>
                    </div>
                    
                    <!-- Phase 11.4: Warning History Log -->
                    <div class="card warning-log-section">
                        <div class="card-header">
                            <h3 class="card-title" style="color: var(--status-warning);">
                                <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                Warning History
                            </h3>
                            <div style="display: flex; align-items: center; gap: var(--space-3); margin-left: auto;">
                                <span class="stat-badge" id="warningLogCount" style="background: var(--bg-elevated); min-width: 70px; text-align: center;">0 entries</span>
                                <button class="btn btn-ghost" id="btnClearWarningLogs">
                                    <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    <span>Clear</span>
                                </button>
                            </div>
                        </div>
                        <div class="warning-log-viewer" id="warningLogViewer">
                            <div class="warning-log-empty">No warnings recorded yet</div>
                        </div>
                    </div>
                </div>
                
                <!-- Config Tab - Phase 10.5: Device Config & OTA -->
                <div class="tab-panel" id="tab-config">
                    <!-- Phase 11.5: Active Device Indicator Bar -->
                    <div class="active-device-bar config" id="activeDeviceBarConfig">
                        <div class="adb-icon">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        </div>
                        <span class="adb-action">CONFIGURING:</span>
                        <span class="adb-serial">--</span>
                        <span class="adb-nickname"></span>
                        <span class="adb-separator">|</span>
                        <span class="adb-detail">Client: --</span>
                        <div class="adb-status unknown">
                            <div class="status-dot"></div>
                            <span>Unknown</span>
                        </div>
                    </div>
                    
                    <div class="config-grid">
                        
                        <!-- MQTT Topics Section (added) -->
                        <div class="config-section">
                            <div class="config-section-header">
                                <div class="config-section-icon">
                                    <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                </div>
                                <h3 class="config-section-title">MQTT Topics</h3>
                            </div>
                            <div class="data-grid" id="topicsDisplay">
                                <div class="data-item"><span class="data-label">Status Topic</span><span class="data-value" id="topicStatus">--</span></div>
                                <div class="data-item"><span class="data-label">Sensors Topic</span><span class="data-value" id="topicSensors">--</span></div>
                                <div class="data-item"><span class="data-label">Mode Topic</span><span class="data-value" id="topicMode">--</span></div>
                                <div class="data-item"><span class="data-label">Speed Topic</span><span class="data-value" id="topicSpeed">--</span></div>
                                <div class="data-item"><span class="data-label">Config Topic</span><span class="data-value" id="topicConfig">--</span></div>
                                <div class="data-item"><span class="data-label">Diag Topic</span><span class="data-value" id="topicDiag">--</span></div>
                                <div class="data-item"><span class="data-label">Diag Cmd Topic</span><span class="data-value" id="topicDiagCmd">--</span></div>
                            </div>
                        </div>
                        
                        <!-- Fan Settings Section -->
                        <div class="config-section">
                            <div class="config-section-header">
                                <div class="config-section-icon">
                                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><circle cx="12" cy="12" r="3"/></svg>
                                </div>
                                <h3 class="config-section-title">Fan Settings</h3>
                            </div>
                            
                            <!-- Speed Map -->
                            <div class="config-form-group" style="margin-bottom: var(--space-4);">
                                <label class="config-form-label">Speed Map (Level 0-5 to %)</label>
                                <div class="speed-map-grid">
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">L0</span>
                                        <input type="number" class="speed-map-input" id="speedMap0" value="0" min="0" max="100">
                                    </div>
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">L1</span>
                                        <input type="number" class="speed-map-input" id="speedMap1" value="20" min="0" max="100">
                                    </div>
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">L2</span>
                                        <input type="number" class="speed-map-input" id="speedMap2" value="40" min="0" max="100">
                                    </div>
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">L3</span>
                                        <input type="number" class="speed-map-input" id="speedMap3" value="60" min="0" max="100">
                                    </div>
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">L4</span>
                                        <input type="number" class="speed-map-input" id="speedMap4" value="80" min="0" max="100">
                                    </div>
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">L5</span>
                                        <input type="number" class="speed-map-input" id="speedMap5" value="100" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Steady Levels -->
                            <div class="config-form-group" style="margin-bottom: var(--space-4);">
                                <label class="config-form-label">Steady Levels (Auto Mode Thresholds %)</label>
                                <div class="speed-map-grid">
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">Low</span>
                                        <input type="number" class="speed-map-input" id="steadyLevel0" value="20" min="0" max="100">
                                    </div>
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">Mid</span>
                                        <input type="number" class="speed-map-input" id="steadyLevel1" value="40" min="0" max="100">
                                    </div>
                                    <div class="speed-map-item">
                                        <span class="speed-map-label">High</span>
                                        <input type="number" class="speed-map-input" id="steadyLevel2" value="60" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- EMA Alpha & Publish Interval -->
                            <div class="config-form">
                                <div class="config-form-group">
                                    <label class="config-form-label">EMA Alpha (0.01-0.50)</label>
                                    <input type="number" class="config-form-input small" id="cfgEmaAlpha" value="0.20" min="0.01" max="0.50" step="0.01">
                                </div>
                                <div class="config-form-group">
                                    <label class="config-form-label">Publish Interval (ms)</label>
                                    <input type="number" class="config-form-input medium" id="cfgPubInterval" value="30000" min="5000" max="300000" step="1000">
                                </div>
                            </div>
                            
                            <div class="config-actions">
                                <button class="btn btn-primary" id="btnApplyFanSettings">
                                    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                    <span>Apply Fan Settings</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Device Identity Section -->
                        <div class="config-section">
                            <div class="config-section-header">
                                <div class="config-section-icon">
                                    <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                </div>
                                <h3 class="config-section-title">Device Identity</h3>
                            </div>
                            
                            <div class="config-form">
                                <div class="config-form-group">
                                    <label class="config-form-label">Device Serial</label>
                                    <input type="text" class="config-form-input" id="cfgDeviceSerial" placeholder="e.g. 582D34712B3D">
                                </div>
                                <div class="config-form-group">
                                    <label class="config-form-label">QP Serial</label>
                                    <input type="text" class="config-form-input" id="cfgQpSerial" placeholder="e.g. 582D34712B3D">
                                </div>
                            </div>
                            
                            <div class="config-actions">
                                <button class="btn btn-warning" id="btnApplyIdentity">
                                    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                    <span>Apply Identity</span>
                                </button>
                                <div class="config-warning">
                                    <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    <span>Device will reboot</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MQTT Settings Section -->
                        <div class="config-section">
                            <div class="config-section-header">
                                <div class="config-section-icon">
                                    <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                </div>
                                <h3 class="config-section-title">MQTT Settings (Device)</h3>
                            </div>
                            
                            <div class="config-form">
                                <div class="config-form-group">
                                    <label class="config-form-label">MQTT Host</label>
                                    <input type="text" class="config-form-input" id="cfgMqttHost" placeholder="broker.emqx.io">
                                </div>
                                <div class="config-form-group">
                                    <label class="config-form-label">Port</label>
                                    <input type="number" class="config-form-input small" id="cfgMqttPort" value="8883" min="1" max="65535">
                                </div>
                                <div class="config-form-group">
                                    <label class="config-form-label">TLS</label>
                                    <label class="config-checkbox">
                                        <input type="checkbox" id="cfgMqttTls" checked>
                                        <span class="config-checkbox-toggle"></span>
                                        <span class="config-checkbox-label">Enable</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="config-form">
                                <div class="config-form-group">
                                    <label class="config-form-label">Username</label>
                                    <input type="text" class="config-form-input" id="cfgMqttUser" placeholder="Username">
                                </div>
                                <div class="config-form-group">
                                    <label class="config-form-label">Password</label>
                                    <input type="password" class="config-form-input" id="cfgMqttPass" placeholder="********">
                                </div>
                            </div>
                            
                            <div class="config-actions">
                                <button class="btn btn-warning" id="btnApplyMqtt">
                                    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                    <span>Apply MQTT Settings</span>
                                </button>
                                <div class="config-warning">
                                    <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    <span>Device will reboot</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- OTA Update Section -->
                        <div class="config-section">
                            <div class="config-section-header">
                                <div class="config-section-icon">
                                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                </div>
                                <h3 class="config-section-title">OTA Firmware Update</h3>
                            </div>
                            
                            <!-- Current Firmware Info -->
                            <div class="firmware-info">
                                <span class="firmware-label">Current Version:</span>
                                <span class="firmware-value" id="cfgCurrentFirmware">--</span>
                            </div>
                            
                            <div class="config-form-group full-width" style="margin-bottom: var(--space-4);">
                                <label class="config-form-label">OTA Firmware URL (.bin)</label>
                                <input type="url" class="config-form-input url" id="cfgOtaUrl" placeholder="https://example.com/firmware.bin">
                            </div>
                            
                            <div class="config-actions">
                                <button class="btn btn-danger" id="btnStartOta">
                                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    <span>Start OTA Update</span>
                                </button>
                                <div class="config-warning">
                                    <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    <span>Device will reboot after update</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Config Backup Section -->
                        <div class="config-section">
                            <div class="config-section-header">
                                <div class="config-section-icon">
                                    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                </div>
                                <h3 class="config-section-title">Config Backup</h3>
                            </div>
                            
                            <div class="config-backup-actions">
                                <button class="btn btn-ghost" id="btnExportConfig">
                                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    <span>Export Config (JSON)</span>
                                </button>
                                <button class="btn btn-ghost" id="btnImportConfig">
                                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    <span>Import Config (JSON)</span>
                                </button>
                                <input type="file" class="hidden-input" id="importConfigFile" accept=".json">
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Device Edit Modal - Phase 11.1 -->
    <div class="modal-overlay" id="deviceEditModal">
        <div class="modal device-modal">
            <div class="device-modal-header">
                <h3 class="device-modal-title" id="deviceModalTitle">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="var(--neon-cyan)" stroke-width="2" fill="none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Edit Device
                </h3>
                <button class="device-modal-close" id="btnCloseDeviceModal">
                    <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            
            <!-- QP Serial Section -->
            <div class="device-form-section">
                <div class="device-form-section-title">
                    <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 9h6v6H9z"/></svg>
                    QP Serial (Location/Room)
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">QP Serial</label>
                    <input type="text" class="device-form-input" id="editQpSerial" readonly>
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Nickname</label>
                    <input type="text" class="device-form-input" id="editQpNickname" placeholder="e.g. Meeting Room">
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Location</label>
                    <input type="text" class="device-form-input" id="editQpLocation" placeholder="e.g. Floor 2, Building A">
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Notes</label>
                    <textarea class="device-form-input textarea" id="editQpNotes" placeholder="Additional details..."></textarea>
                </div>
            </div>
            
            <!-- Client IDs Section -->
            <div class="device-form-section client">
                <div class="device-form-section-title">
                    <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                    Client IDs (ESP32)
                </div>
                <div class="device-client-list" id="editClientList">
                    <!-- Client items will be inserted here -->
                </div>
                <button class="btn btn-ghost" id="btnAddClientId" style="margin-top: var(--space-3); width: 100%;">
                    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>Add Client ID</span>
                </button>
            </div>
            
            <div class="device-modal-actions">
                <div class="device-modal-actions-left">
                    <button class="btn btn-danger" id="btnDeleteDevice">
                        <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        <span>Delete Device</span>
                    </button>
                </div>
                <div class="device-modal-actions-right">
                    <button class="btn btn-ghost" id="btnCancelDevice">Cancel</button>
                    <button class="btn btn-primary" id="btnSaveDevice">
                        <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        <span>Save</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Device Modal - Phase 11.1 -->
    <div class="modal-overlay" id="deviceAddModal">
        <div class="modal device-modal">
            <div class="device-modal-header">
                <h3 class="device-modal-title">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="var(--neon-cyan)" stroke-width="2" fill="none"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add New Device
                </h3>
                <button class="device-modal-close" id="btnCloseAddModal">
                    <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            
            <!-- QP Serial Section -->
            <div class="device-form-section">
                <div class="device-form-section-title">
                    <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 9h6v6H9z"/></svg>
                    QP Serial (Location/Room)
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">QP Serial *</label>
                    <input type="text" class="device-form-input" id="addQpSerial" placeholder="e.g. 582D34712B45">
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Nickname</label>
                    <input type="text" class="device-form-input" id="addQpNickname" placeholder="e.g. Meeting Room">
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Location</label>
                    <input type="text" class="device-form-input" id="addQpLocation" placeholder="e.g. Floor 2, Building A">
                </div>
            </div>
            
            <!-- Client ID Section -->
            <div class="device-form-section client">
                <div class="device-form-section-title">
                    <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                    Client ID (ESP32) - Optional
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Client ID</label>
                    <input type="text" class="device-form-input" id="addClientId" placeholder="e.g. be-tpp-cca7f7f924f0">
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Client Nickname</label>
                    <input type="text" class="device-form-input" id="addClientNickname" placeholder="e.g. Fan A">
                </div>
            </div>
            
            <div class="device-modal-actions">
                <div class="device-modal-actions-left"></div>
                <div class="device-modal-actions-right">
                    <button class="btn btn-ghost" id="btnCancelAdd">Cancel</button>
                    <button class="btn btn-primary" id="btnConfirmAdd">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span>Add Device</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Delete Modal - Phase 11.1 -->
    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal confirm-modal">
            <div class="confirm-modal-icon">
                <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
            <h3 class="confirm-modal-title">Confirm Delete Device</h3>
            <p class="confirm-modal-text">Are you sure you want to delete this device? This action cannot be undone.</p>
            
            <div class="confirm-modal-details">
                <div class="confirm-modal-detail">
                    <span class="confirm-modal-label">QP Serial:</span>
                    <span class="confirm-modal-value" id="deleteQpSerial">--</span>
                </div>
                <div class="confirm-modal-detail">
                    <span class="confirm-modal-label">Nickname:</span>
                    <span class="confirm-modal-value" id="deleteNickname">--</span>
                </div>
                <div class="confirm-modal-clients" id="deleteClientsList" style="display: none;">
                    <div class="confirm-modal-clients-title">Warning: Affected Client IDs:</div>
                    <div id="deleteClientsItems">
                        <!-- Client items will be inserted here -->
                    </div>
                </div>
            </div>
            
            <label class="confirm-modal-checkbox" id="deleteClientsCheckbox" style="display: none;">
                <input type="checkbox" id="chkDeleteClients" checked>
                <span class="confirm-modal-checkbox-label">Also delete linked Client IDs</span>
            </label>
            
            <div class="confirm-modal-actions">
                <button class="btn btn-ghost" id="btnCancelDelete">Cancel</button>
                <button class="btn btn-danger" id="btnConfirmDelete">
                    <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    <span>Delete Device</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Client ID Modal - Phase 11.1 -->
    <div class="modal-overlay" id="addClientModal">
        <div class="modal device-modal" style="max-width: 400px;">
            <div class="device-modal-header">
                <h3 class="device-modal-title">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="var(--neon-magenta)" stroke-width="2" fill="none"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Client ID
                </h3>
                <button class="device-modal-close" id="btnCloseClientModal">
                    <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            
            <div class="device-form-section client">
                <div class="device-form-group">
                    <label class="device-form-label">Client ID *</label>
                    <input type="text" class="device-form-input" id="newClientId" placeholder="e.g. be-tpp-cca7f7f924f0">
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Nickname</label>
                    <input type="text" class="device-form-input" id="newClientNickname" placeholder="e.g. Fan A">
                </div>
                <div class="device-form-group">
                    <label class="device-form-label">Notes</label>
                    <input type="text" class="device-form-input" id="newClientNotes" placeholder="Additional details...">
                </div>
            </div>
            
            <div class="device-modal-actions">
                <div class="device-modal-actions-left"></div>
                <div class="device-modal-actions-right">
                    <button class="btn btn-ghost" id="btnCancelClient">Cancel</button>
                    <button class="btn btn-primary" id="btnConfirmClient">
                        <span>Add Client</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Logout Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal">
            <h3 class="modal-title">Confirm Logout</h3>
            <p class="modal-text">Are you sure you want to logout? You will be disconnected from MQTT.</p>
            <div class="modal-actions">
                <button class="btn btn-ghost" id="cancelLogout">Cancel</button>
                <button class="btn btn-danger" id="confirmLogout">Logout</button>
            </div>
        </div>
    </div>
    
    <!-- Phase 9.4: Diagnostic Status Modal -->
    <div class="modal-overlay" id="diagStatusModal">
        <div class="modal" style="max-width: 600px;">
            <h3 class="modal-title" id="diagModalTitle">Diagnostic Status</h3>
            <div class="diag-modal-content">
                <div class="diag-json" id="diagJsonContent">Waiting for response...</div>
            </div>
            <div class="diag-modal-actions">
                <button class="btn btn-ghost" id="closeDiagModal">Close</button>
                <button class="btn btn-primary" id="applyConfigFromDiag" style="display: none;">Apply to Config Form</button>
            </div>
        </div>
    </div>
    
    <!-- Phase 9.4: Factory Reset Confirm Modal -->
    <div class="modal-overlay" id="factoryResetModal">
        <div class="modal">
            <h3 class="modal-title">Factory Reset</h3>
            <div class="factory-reset-warning">
                <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <div class="factory-reset-warning-text">
                    <strong>Warning:</strong> This will erase all device configuration including WiFi credentials, MQTT settings, and custom parameters. The device will reboot and enter setup mode.
                </div>
            </div>
            <p class="modal-text">Are you sure you want to perform a factory reset on this device?</p>
            <div class="modal-actions">
                <button class="btn btn-ghost" id="cancelFactoryReset">Cancel</button>
                <button class="btn btn-danger" id="confirmFactoryReset">Confirm Reset</button>
            </div>
        </div>
    </div>
    
    <script>
        /* ============================================
           BE-TPP ADMIN DASHBOARD - JAVASCRIPT
           Phase 9: Control Center Polish
           ============================================ */
        
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        
        const CONFIG = {
            LOGIN_URL: 'index.html',
            STORAGE_KEY: 'betpp_mqtt_config',
            RECONNECT_DELAY: 5000,
            EMA_ALPHA: 0.2,
            // Phase 6.1: Max data points per interval
            MAX_SENSOR_POINTS: 60,    // ~10 min @ 10s interval (sensors)
            MAX_FAN_POINTS: 20,       // ~10 min @ 30s interval (fan/status)
            // Phase 6.2: Add min/max to new grid lines display
            ESP_TEMP_WARN: 50,        // Celsius - Show warning badge
            ESP_TEMP_DANGER: 65,      // Celsius - Toast warning
            ESP_TEMP_CRITICAL: 80     // Celsius - Toast + highlight display
        };
        
        // State
        let mqttClient = null;
        let chartPm25 = null, chartCo2 = null, chartTempHum = null, chartFanSpeed = null;
        let resizeTimeout = null;
        
        // Phase 6.1: Separate data structure per message type
        let chartDataSensors = { 
            time: [], 
            pm25: [], 
            co2: [], 
            temp: [], 
            humidity: [],
            pm25Ema: [],
            co2Ema: []
        };
        
        let chartDataFan = {
            time: [],
            fanSpeed: []
        };
        
        let lastSensorTime = null;
        let webClientId = null; // Auto-generated Web Client ID
        let lastFanSpeed = null; // Track fan speed from status message
        let lastEspTemp = null;  // Phase 6.2: Add min/max to new grid lines display
        
        // Phase 11.2: Track current MQTT subscriptions for device switching
        let currentSubscribedTopics = [];
        
        // Phase 7: Enhanced Status System
        let isOnline = navigator.onLine;
        let reconnectTimer = null;
        let reconnectCountdown = 0;
        // Phase 9.3: Store firmware EMA values for charts
        let lastFirmwarePm25Ema = null;
        let lastFirmwareCo2Ema = null;
        
        /* ============================================
           Phase 11.1: Device Registry System
           ============================================ */
        
        // Device Registry Constants
        const DEVICE_REGISTRY_KEY = 'be-tpp-device-registry';
        const ACTIVE_DEVICE_KEY = 'be-tpp-active-device';
        const DEVICE_ONLINE_TIMEOUT = 90000; // 90 seconds (unified with MONITOR_CONFIG.OFFLINE_THRESHOLD_MS)
        
        // Device Registry State
        let deviceRegistry = {
            version: "2.0",
            lastModified: null,
            qpSerials: {},
            clientIds: {},
            groups: []
        };
        
        // Runtime state (not saved to localStorage)
        let deviceStatus = {}; // { qpSerial: { online, lastSeen, clientIds } }
        let currentEditingQp = null; // QP Serial being edited
        let deviceSortColumn = 'status';
        let deviceSortOrder = 'desc';
        
        // Initialize Device Registry
        function initDeviceRegistry() {
            loadDeviceRegistry();
            renderDeviceList();
            updateDeviceStats();
            setupDeviceEventListeners();
            
            // Restore active device
            const savedActive = localStorage.getItem(ACTIVE_DEVICE_KEY);
            if (savedActive) {
                try {
                    const active = JSON.parse(savedActive);
                    if (active.qpSerial && deviceRegistry.qpSerials[active.qpSerial]) {
                        $('#qpSerial').value = active.qpSerial;
                        if (active.clientId) {
                            $('#deviceClientId').value = active.clientId;
                        }
                        updateTopicsDisplay();
                    }
                } catch (e) {
                    console.warn('Failed to restore active device:', e);
                }
            }
        }
        
        // Load from localStorage
        function loadDeviceRegistry() {
            try {
                const saved = localStorage.getItem(DEVICE_REGISTRY_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    deviceRegistry = {
                        version: parsed.version || "2.0",
                        lastModified: parsed.lastModified || null,
                        qpSerials: parsed.qpSerials || {},
                        clientIds: parsed.clientIds || {},
                        groups: parsed.groups || []
                    };
                }
            } catch (e) {
                console.error('Failed to load device registry:', e);
            }
        }
        
        // Save to localStorage
        function saveDeviceRegistry() {
            try {
                deviceRegistry.lastModified = new Date().toISOString();
                localStorage.setItem(DEVICE_REGISTRY_KEY, JSON.stringify(deviceRegistry));
                updateDeviceCountBadge();
                // Phase 11.2: Update Device Switcher display when registry changes
                updateDeviceSwitcherDisplay();
                updateActiveDeviceBars();
            } catch (e) {
                console.error('Failed to save device registry:', e);
            }
        }
        
        // Update device count badge in sidebar
        function updateDeviceCountBadge() {
            const badge = $('#deviceCountBadge');
            if (badge) {
                badge.textContent = Object.keys(deviceRegistry.qpSerials).length;
            }
        }
        
        /* ============================================
           Phase 11.2: Device Switcher Functions
           ============================================ */
        
        // Get current active device from form fields
        function getActiveDevice() {
            const qpSerial = $('#qpSerial').value.trim();
            const clientId = $('#deviceClientId').value.trim();
            return { qpSerial, clientId };
        }
        
        // Update Device Switcher button display
        function updateDeviceSwitcherDisplay() {
            const { qpSerial, clientId } = getActiveDevice();
            const serialEl = $('#switcherSerial');
            const nameEl = $('#switcherName');
            const statusEl = $('#switcherStatus');
            
            if (!qpSerial) {
                serialEl.textContent = 'No Device';
                nameEl.textContent = 'Select a device';
                statusEl.className = 'device-switcher-status unknown';
                return;
            }
            
            const device = deviceRegistry.qpSerials[qpSerial];
            const status = getDeviceStatus(qpSerial);
            
            serialEl.textContent = qpSerial;
            nameEl.textContent = device?.nickname || device?.location || 'Unknown Device';
            statusEl.className = `device-switcher-status ${status}`;
        }
        
        // Render Device Switcher dropdown menu
        function renderDeviceSwitcherMenu() {
            const menu = $('#deviceSwitcherMenu');
            if (!menu) return;
            
            const { qpSerial: activeQp } = getActiveDevice();
            const devices = Object.entries(deviceRegistry.qpSerials);
            
            if (devices.length === 0) {
                menu.innerHTML = `
                    <div class="device-switcher-empty">No devices registered</div>
                    <div class="device-switcher-divider"></div>
                    <div class="device-switcher-add" onclick="openAddDeviceFromSwitcher()">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span>Add New Device</span>
                    </div>
                `;
                return;
            }
            
            // Sort devices: online first, then by serial
            const sortedDevices = devices
                .map(([qpSerial, data]) => ({
                    qpSerial,
                    ...data,
                    status: getDeviceStatus(qpSerial),
                    clients: getClientIdsForQp(qpSerial)
                }))
                .sort((a, b) => {
                    // Online first
                    if (a.status === 'online' && b.status !== 'online') return -1;
                    if (a.status !== 'online' && b.status === 'online') return 1;
                    // Then by serial
                    return a.qpSerial.localeCompare(b.qpSerial);
                });
            
            let html = '';
            
            sortedDevices.forEach(device => {
                const isActive = device.qpSerial === activeQp;
                const displayName = device.nickname || device.location || 'Unnamed';
                const statusLabel = device.status === 'online' ? 'Online' : 
                                   device.status === 'offline' ? 'Offline' : 'Unknown';
                const clientId = device.clients.length > 0 ? device.clients[0].id : '';
                
                html += `
                    <div class="device-switcher-item ${isActive ? 'active' : ''}" 
                         onclick="selectDeviceFromSwitcher('${device.qpSerial}', '${clientId}')">
                        <div class="device-switcher-item-serial">${device.qpSerial}</div>
                        <div class="device-switcher-item-row">
                            <div class="device-switcher-item-name">${displayName}</div>
                            <div class="device-switcher-item-status ${device.status}">
                                <div class="status-dot"></div>
                                <span>${statusLabel}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add divider and "Add New Device" button
            html += `
                <div class="device-switcher-divider"></div>
                <div class="device-switcher-add" onclick="openAddDeviceFromSwitcher()">
                    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>Add New Device</span>
                </div>
            `;
            
            menu.innerHTML = html;
        }
        
        // Toggle Device Switcher dropdown
        function toggleDeviceSwitcher(forceClose = false) {
            const btn = $('#deviceSwitcherBtn');
            const menu = $('#deviceSwitcherMenu');
            
            if (forceClose || menu.classList.contains('open')) {
                btn.classList.remove('open');
                menu.classList.remove('open');
            } else {
                renderDeviceSwitcherMenu();
                btn.classList.add('open');
                menu.classList.add('open');
            }
        }
        
        // Select device from switcher dropdown
        function selectDeviceFromSwitcher(qpSerial, clientId) {
            // Update form fields
            $('#qpSerial').value = qpSerial;
            if (clientId) {
                $('#deviceClientId').value = clientId;
            }
            
            // Update display
            updateDeviceSwitcherDisplay();
            updateTopicsDisplay();
            
            // Close dropdown
            toggleDeviceSwitcher(true);
            
            // Save to localStorage
            localStorage.setItem(ACTIVE_DEVICE_KEY, JSON.stringify({ qpSerial, clientId }));
            
            // Update Active Device Bars
            updateActiveDeviceBars();
            
            // Log the selection
            addLog('system', `Device selected: ${qpSerial}`);
            showToast('info', 'Device Selected', `Switched to ${qpSerial}`);
            
            // If connected, trigger MQTT resubscription (Phase 11.2.3)
            if (mqttClient && mqttClient.connected) {
                handleDeviceSwitch(qpSerial, clientId);
            }
        }
        
        // Open Add Device modal from switcher
        function openAddDeviceFromSwitcher() {
            toggleDeviceSwitcher(true);
            // Switch to Devices tab and open Add modal
            $$('.nav-item').forEach(n => n.classList.remove('active'));
            const devicesTab = document.querySelector('.nav-item[data-tab="devices"]');
            if (devicesTab) devicesTab.classList.add('active');
            $$('.tab-panel').forEach(p => p.classList.remove('active'));
            $('#tab-devices').classList.add('active');
            $('#pageTitle').textContent = 'Devices';
            // Open Add Device modal (use correct function name)
            setTimeout(() => openAddDevice(), 100);
        }
        
        // Setup Device Switcher event listeners
        function setupDeviceSwitcherEvents() {
            const btn = $('#deviceSwitcherBtn');
            const menu = $('#deviceSwitcherMenu');
            
            // Toggle on button click
            btn.onclick = (e) => {
                e.stopPropagation();
                toggleDeviceSwitcher();
            };
            
            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.device-switcher')) {
                    toggleDeviceSwitcher(true);
                }
            });
            
            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    toggleDeviceSwitcher(true);
                }
            });
        }
        
        /* ============================================
           Phase 11.5: Active Device Indicator Bars
           ============================================ */
        
        // Update all Active Device Bars
        function updateActiveDeviceBars() {
            const { qpSerial, clientId } = getActiveDevice();
            const device = deviceRegistry.qpSerials[qpSerial];
            
            // Check MQTT connection first - if disconnected, show offline
            const isMqttConnected = mqttClient && mqttClient.connected;
            let status = 'unknown';
            if (!isMqttConnected) {
                status = 'offline';
            } else {
                status = getDeviceStatus(qpSerial);
            }
            
            const displayName = device?.nickname || device?.location || '';
            const statusLabel = status === 'online' ? 'Online' : 
                               status === 'offline' ? 'Offline' : 'Unknown';
            
            // Update Control Center bar
            const controlBar = $('#activeDeviceBarControl');
            if (controlBar) {
                controlBar.querySelector('.adb-serial').textContent = qpSerial || '--';
                controlBar.querySelector('.adb-nickname').textContent = displayName ? `(${displayName})` : '';
                controlBar.querySelector('.adb-detail').textContent = clientId ? `Client: ${clientId}` : 'Client: --';
                const statusEl = controlBar.querySelector('.adb-status');
                statusEl.className = `adb-status ${status}`;
                statusEl.innerHTML = `<div class="status-dot"></div><span>${statusLabel}</span>`;
            }
            
            // Update Configuration bar
            const configBar = $('#activeDeviceBarConfig');
            if (configBar) {
                configBar.querySelector('.adb-serial').textContent = qpSerial || '--';
                configBar.querySelector('.adb-nickname').textContent = displayName ? `(${displayName})` : '';
                configBar.querySelector('.adb-detail').textContent = clientId ? `Client: ${clientId}` : 'Client: --';
                const statusEl = configBar.querySelector('.adb-status');
                statusEl.className = `adb-status ${status}`;
                statusEl.innerHTML = `<div class="status-dot"></div><span>${statusLabel}</span>`;
            }
        }
        
        /* ============================================
           Phase 11.2.3: MQTT Device Switch Handler
           ============================================ */
        
        // Clear all chart data arrays
        function clearAllChartData() {
            // Reset sensor chart data
            chartDataSensors.time = [];
            chartDataSensors.pm25 = [];
            chartDataSensors.co2 = [];
            chartDataSensors.temp = [];
            chartDataSensors.humidity = [];
            chartDataSensors.pm25Ema = [];
            chartDataSensors.co2Ema = [];
            
            // Reset fan chart data
            chartDataFan.time = [];
            chartDataFan.fanSpeed = [];
            
            // Reset tracking variables
            lastSensorTime = null;
            lastFanSpeed = null;
            lastFirmwarePm25Ema = null;
            lastFirmwareCo2Ema = null;
            
            // Reset chart displays with "Waiting for data..." graphic
            if (chartPm25) {
                chartPm25.setOption({
                    xAxis: { data: [] },
                    series: [{ data: [] }, { data: [] }],
                    graphic: { invisible: false }
                });
            }
            if (chartCo2) {
                chartCo2.setOption({
                    xAxis: { data: [] },
                    series: [{ data: [] }, { data: [] }],
                    graphic: { invisible: false }
                });
            }
            if (chartTempHum) {
                chartTempHum.setOption({
                    xAxis: { data: [] },
                    series: [{ data: [] }, { data: [] }],
                    graphic: { invisible: false }
                });
            }
            if (chartFanSpeed) {
                chartFanSpeed.setOption({
                    xAxis: { data: [] },
                    series: [{ data: [] }],
                    graphic: { invisible: false }
                });
            }
            
            // Reset data point counters
            const sensorPts = $('#sensorDataPoints');
            const fanPts = $('#fanDataPoints');
            if (sensorPts) sensorPts.textContent = 'Sensors: 0/' + CONFIG.MAX_SENSOR_POINTS;
            if (fanPts) fanPts.textContent = 'Fan: 0/' + CONFIG.MAX_FAN_POINTS;
            
            addLog('system', 'Chart data cleared');
        }
        
        // Reset all sensor and device UI displays
        function resetSensorDisplays() {
            // Sensor values
            $('#pm25Value').textContent = '--';
            $('#co2Value').textContent = '--';
            $('#tempValue').textContent = '--';
            $('#humidityValue').textContent = '--';
            $('#pm10Value').textContent = '--';
            $('#tvocValue').textContent = '--';
            $('#noiseValue').textContent = '--';
            
            // Quality badges
            $('#pm25Quality').textContent = '--';
            $('#pm25Quality').className = 'quality-badge';
            $('#co2Quality').textContent = '--';
            $('#co2Quality').className = 'quality-badge';
            $('#tempQuality').textContent = '--';
            $('#tempQuality').className = 'quality-badge';
            $('#humidityQuality').textContent = '--';
            $('#humidityQuality').className = 'quality-badge';
            $('#pm10Quality').textContent = '--';
            $('#pm10Quality').className = 'quality-badge';
            $('#tvocQuality').textContent = '--';
            $('#tvocQuality').className = 'quality-badge';
            
            // Sensor cards
            $('#cardPm25').className = 'card stat-card sensor-card';
            $('#cardCo2').className = 'card stat-card sensor-card';
            $('#cardTemp').className = 'card stat-card sensor-card';
            $('#cardHumidity').className = 'card stat-card sensor-card';
            $('#cardPm10').className = 'card stat-card sensor-card';
            $('#cardTvoc').className = 'card stat-card sensor-card';
            
            // EMA values
            $('#pm25Ema').textContent = 'EMA: --';
            $('#co2Ema').textContent = 'EMA: --';
            
            // Sensor bars
            $('#pm25Bar').style.width = '0%';
            $('#co2Bar').style.width = '0%';
            $('#pm10Bar').style.width = '0%';
            $('#tvocBar').style.width = '0%';
            
            // Fan status
            $('#fanSpeedValue').textContent = '--';
            $('#fanModeValue').textContent = '--';
            $('#fanModeBadge').textContent = '--';
            $('#fanModeBadge').className = 'stat-badge';
            $('#fanStateBadge').textContent = '--';
            $('#fanStateBadge').className = 'stat-badge fan-state';
            $('#currentModeBadge').textContent = '--';
            $('#currentModeBadge').className = 'stat-badge';
            $('#currentSpeedBadge').textContent = '--';
            
            // Device info
            $('#rssiValue').textContent = '--';
            $('#uptimeValue').textContent = '--';
            $('#infoSerial').textContent = '--';
            $('#infoClientId').textContent = '--';
            $('#infoFirmware').textContent = '--';
            $('#infoEspTemp').textContent = '--';
            $('#infoHeap').textContent = '--';
            $('#infoSpeedMap').textContent = '--';
            $('#infoSteadyLevels').textContent = '--';
            $('#infoSteadyIndex').textContent = '--';
            $('#infoEmaAlpha').textContent = '--';
            $('#infoLastUpdate').textContent = '--';
            
            // Device status badge
            $('#deviceStatusBadge').textContent = 'OFFLINE';
            $('#deviceStatusBadge').className = 'stat-badge offline';
            
            // Sensor age
            $('#sensorAgeText').textContent = '--';
            $('#sensorAgeStatus').textContent = 'WAITING';
            $('#sensorAgeBadge').className = 'sensor-age-badge';
            $('#sensorTimestamp').textContent = 'No data';
            $('#sensorAgeValue').textContent = '--';
            
            // Data status
            $('#dataStatusDot').className = 'status-dot';
            $('#dataStatusText').textContent = 'No Data';
            $('#sensorStatusBadge').textContent = 'WAITING';
            $('#sensorStatusBadge').className = 'stat-badge offline';
            
            // Speed buttons
            $$('.speed-btn').forEach(btn => btn.classList.remove('active'));
            
            // Speed slider
            $('#speedSliderFill').style.width = '0%';
            $('#speedSliderKnob').style.left = '0%';
            $('#speedSliderValue').textContent = '0';
            
            // Mode toggle
            const modeToggle = $('#modeToggle');
            if (modeToggle) {
                modeToggle.classList.remove('custom');
                modeToggle.classList.add('automatic');
            }
            $('#labelAuto').classList.add('active');
            $('#labelCustom').classList.remove('active');
            
            // Quick actions
            $$('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
            
            // Chart badges
            $('#pm25ChartBadge').textContent = '--';
            $('#co2ChartBadge').textContent = '--';
            $('#fanSpeedChartBadge').textContent = '--';
            
            // Signal bars
            $$('#signalBars .signal-bar').forEach(bar => bar.classList.remove('active'));
            
            addLog('system', 'UI displays reset');
        }
        
        // Handle device switch when MQTT is connected
        function handleDeviceSwitch(newQpSerial, newClientId) {
            if (!mqttClient || !mqttClient.connected) {
                addLog('warning', 'Cannot switch device: MQTT not connected');
                return;
            }
            
            addLog('system', `Switching MQTT to device: ${newQpSerial}`);
            
            // Step 1: Unsubscribe from old topics
            if (currentSubscribedTopics.length > 0) {
                mqttClient.unsubscribe(currentSubscribedTopics, (err) => {
                    if (err) {
                        addLog('error', 'Unsubscribe error: ' + err.message);
                    } else {
                        addLog('system', 'Unsubscribed from old topics');
                    }
                });
            }
            
            // Step 2: Clear chart data
            clearAllChartData();
            
            // Step 3: Reset UI displays
            resetSensorDisplays();
            
            // Step 4: Subscribe to new topics
            const newTopics = getTopics();
            const topicsToSubscribe = [newTopics.status, newTopics.sensors, newTopics.diag];
            
            mqttClient.subscribe(topicsToSubscribe, (err) => {
                if (err) {
                    addLog('error', 'Subscribe error: ' + err.message);
                    showToast('error', 'Subscribe Failed', 'Could not subscribe to new device topics');
                } else {
                    currentSubscribedTopics = topicsToSubscribe;
                    addLog('system', `Subscribed to new device: ${newQpSerial}`);
                    showToast('success', 'Device Switched', `Now monitoring ${newQpSerial}`);
                }
            });
            
            // Update topics display
            updateTopicsDisplay();
        }
        
        // Get client IDs linked to a QP Serial
        function getClientIdsForQp(qpSerial) {
            const clients = [];
            for (const [clientId, data] of Object.entries(deviceRegistry.clientIds)) {
                if (data.qpSerial === qpSerial) {
                    clients.push({ id: clientId, ...data });
                }
            }
            return clients;
        }
        
        // Get device status (online/offline/unknown)
        function getDeviceStatus(qpSerial) {
            const status = deviceStatus[qpSerial];
            if (!status) return 'unknown';
            const now = Date.now();
            if (now - status.lastSeen < DEVICE_ONLINE_TIMEOUT) return 'online';
            return 'offline';
        }
        
        // Format last seen time
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Never';
            const now = Date.now();
            const diff = now - timestamp;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' hr ago';
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        }
        
        // Render device list table
        function renderDeviceList() {
            const tbody = $('#deviceTableBody');
            const emptyState = $('#deviceEmptyState');
            if (!tbody) return;
            
            const searchInput = $('#deviceSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            let devices = Object.entries(deviceRegistry.qpSerials).map(([qpSerial, data]) => ({
                qpSerial, ...data,
                clients: getClientIdsForQp(qpSerial),
                status: getDeviceStatus(qpSerial),
                lastSeen: deviceStatus[qpSerial]?.lastSeen || null
            }));
            
            // Filter by search
            if (searchTerm) {
                devices = devices.filter(d => {
                    const searchStr = `${d.qpSerial} ${d.nickname || ''} ${d.location || ''} ${d.clients.map(c => c.id + ' ' + (c.nickname || '')).join(' ')}`.toLowerCase();
                    return searchStr.includes(searchTerm);
                });
            }
            
            // Sort
            devices.sort((a, b) => {
                let valA, valB;
                switch (deviceSortColumn) {
                    case 'status':
                        const order = { online: 0, offline: 1, unknown: 2 };
                        valA = order[a.status]; valB = order[b.status]; break;
                    case 'qpSerial': valA = a.qpSerial; valB = b.qpSerial; break;
                    case 'qpNickname': valA = a.nickname || 'zzz'; valB = b.nickname || 'zzz'; break;
                    case 'clientId': valA = a.clients[0]?.id || 'zzz'; valB = b.clients[0]?.id || 'zzz'; break;
                    case 'lastSeen': valA = a.lastSeen || 0; valB = b.lastSeen || 0; break;
                    default: valA = a.qpSerial; valB = b.qpSerial;
                }
                if (typeof valA === 'string') return deviceSortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return deviceSortOrder === 'asc' ? valA - valB : valB - valA;
            });
            
            if (devices.length === 0 && !searchTerm) {
                tbody.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            if (emptyState) emptyState.style.display = 'none';
            
            tbody.innerHTML = devices.map(d => `
                <tr data-qp="${d.qpSerial}">
                    <td><div class="device-status-cell"><span class="device-status-dot ${d.status}"></span>${d.status === 'online' ? 'Online' : d.status === 'offline' ? 'Offline' : 'Unknown'}</div></td>
                    <td><span class="device-serial">${d.qpSerial}</span></td>
                    <td><span class="device-nickname ${d.nickname ? '' : 'empty'}">${d.nickname || '(No name)'}</span></td>
                    <td>${d.clients.length > 0 ? `<span class="device-client">${d.clients[0].id.substring(0, 18)}...</span>${d.clients.length > 1 ? `<span class="device-client-count">+${d.clients.length - 1}</span>` : ''}` : '<span class="device-client" style="opacity:0.5">-</span>'}</td>
                    <td><span class="device-lastseen">${formatLastSeen(d.lastSeen)}</span></td>
                    <td><div class="device-actions-cell">
                        <button class="device-action-btn" onclick="openEditDevice('${d.qpSerial}')" title="Edit"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                        <button class="device-action-btn" onclick="selectDevice('${d.qpSerial}')" title="Select"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg></button>
                        <button class="device-action-btn delete" onclick="confirmDeleteDevice('${d.qpSerial}')" title="Delete"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div></td>
                </tr>
            `).join('');
            
            $$('.device-table th[data-sort]').forEach(th => {
                th.classList.toggle('sorted', th.dataset.sort === deviceSortColumn);
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.textContent = th.dataset.sort === deviceSortColumn ? (deviceSortOrder === 'asc' ? '^' : 'v') : '-';
            });
        }
        
        // Update stats bar
        function updateDeviceStats() {
            const total = Object.keys(deviceRegistry.qpSerials).length;
            let online = 0;
            for (const qp of Object.keys(deviceRegistry.qpSerials)) {
                if (getDeviceStatus(qp) === 'online') online++;
            }
            if ($('#statTotalDevices')) $('#statTotalDevices').textContent = total;
            if ($('#statOnlineDevices')) $('#statOnlineDevices').textContent = online;
            if ($('#statOfflineDevices')) $('#statOfflineDevices').textContent = total - online;
            updateDeviceCountBadge();
        }
        
        // Auto-detect device from MQTT status
        function autoDetectDevice(status) {
            const serial = status.serial ?? status.qpSerial;
            const clientId = status.client_id ?? status.clientId;
            if (!serial) return;
            
            let changed = false;
            if (!deviceRegistry.qpSerials[serial]) {
                deviceRegistry.qpSerials[serial] = { nickname: "", location: "", notes: "Auto-detected", addedAt: new Date().toISOString() };
                changed = true;
                showToast('info', 'New Device', `Detected: ${serial}`);
            }
            if (clientId && !deviceRegistry.clientIds[clientId]) {
                deviceRegistry.clientIds[clientId] = { nickname: "", qpSerial: serial, notes: "Auto-detected", addedAt: new Date().toISOString() };
                changed = true;
            }
            if (!deviceStatus[serial]) deviceStatus[serial] = { online: true, lastSeen: Date.now(), clientIds: [] };
            deviceStatus[serial].lastSeen = Date.now();
            if (clientId && !deviceStatus[serial].clientIds.includes(clientId)) deviceStatus[serial].clientIds.push(clientId);
            
            if (changed) { saveDeviceRegistry(); }
            // Always update UI when receiving MQTT status
            renderDeviceList(); updateDeviceStats();
            // Phase 11.2: Update Active Device Bar status when receiving data
            updateActiveDeviceBars();
            updateDeviceSwitcherDisplay();
        }
        
        // Modal functions
        function openAddDevice() {
            $('#addQpSerial').value = ''; $('#addQpNickname').value = ''; $('#addQpLocation').value = '';
            $('#addClientId').value = ''; $('#addClientNickname').value = '';
            $('#deviceAddModal').classList.add('active');
        }
        
        function openEditDevice(qpSerial) {
            const device = deviceRegistry.qpSerials[qpSerial];
            if (!device) return;
            currentEditingQp = qpSerial;
            $('#editQpSerial').value = qpSerial;
            $('#editQpNickname').value = device.nickname || '';
            $('#editQpLocation').value = device.location || '';
            $('#editQpNotes').value = device.notes || '';
            
            const clients = getClientIdsForQp(qpSerial);
            const clientList = $('#editClientList');
            if (clients.length === 0) {
                clientList.innerHTML = '<p style="color: var(--text-muted); font-size: var(--text-sm);">No Client IDs</p>';
            } else {
                clientList.innerHTML = clients.map(c => `
                    <div class="device-client-item" data-client="${c.id}">
                        <div class="device-client-info">
                            <div class="device-client-id">${c.id}</div>
                            <input type="text" class="device-form-input" style="margin-top: 4px; padding: 6px 8px;" value="${c.nickname || ''}" placeholder="Nickname" onchange="updateClientNickname('${c.id}', this.value)">
                        </div>
                        <button class="device-action-btn delete" onclick="removeClientFromEdit('${c.id}')" title="Delete"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                `).join('');
            }
            $('#deviceEditModal').classList.add('active');
        }
        
        function updateClientNickname(clientId, nickname) {
            if (deviceRegistry.clientIds[clientId]) deviceRegistry.clientIds[clientId].nickname = nickname;
        }
        
        function removeClientFromEdit(clientId) {
            const item = document.querySelector(`.device-client-item[data-client="${clientId}"]`);
            if (item) { item.remove(); delete deviceRegistry.clientIds[clientId]; }
        }
        
        function saveDevice() {
            if (!currentEditingQp) return;
            deviceRegistry.qpSerials[currentEditingQp] = {
                ...deviceRegistry.qpSerials[currentEditingQp],
                nickname: $('#editQpNickname').value.trim(),
                location: $('#editQpLocation').value.trim(),
                notes: $('#editQpNotes').value.trim()
            };
            saveDeviceRegistry(); closeDeviceModal(); renderDeviceList();
            showToast('success', 'Saved', 'Device saved successfully');
        }
        
        function addDevice() {
            const qpSerial = $('#addQpSerial').value.trim().toUpperCase();
            const nickname = $('#addQpNickname').value.trim();
            const location = $('#addQpLocation').value.trim();
            const clientId = $('#addClientId').value.trim().toLowerCase();
            const clientNickname = $('#addClientNickname').value.trim();
            
            if (!qpSerial) { showToast('error', 'Error', 'Please enter QP Serial'); return; }
            if (deviceRegistry.qpSerials[qpSerial]) { showToast('warning', 'Warning', 'QP Serial already exists'); return; }
            
            deviceRegistry.qpSerials[qpSerial] = { nickname, location, notes: "", addedAt: new Date().toISOString() };
            if (clientId) deviceRegistry.clientIds[clientId] = { nickname: clientNickname, qpSerial, notes: "", addedAt: new Date().toISOString() };
            
            saveDeviceRegistry(); closeAddModal(); renderDeviceList(); updateDeviceStats();
            showToast('success', 'Added', `Device ${qpSerial} added successfully`);
        }
        
        function confirmDeleteDevice(qpSerial) {
            const device = deviceRegistry.qpSerials[qpSerial];
            if (!device) return;
            currentEditingQp = qpSerial;
            $('#deleteQpSerial').textContent = qpSerial;
            $('#deleteNickname').textContent = device.nickname || '(None)';
            
            const clients = getClientIdsForQp(qpSerial);
            const clientsList = $('#deleteClientsList');
            const checkbox = $('#deleteClientsCheckbox');
            if (clients.length > 0) {
                clientsList.style.display = 'block'; checkbox.style.display = 'flex';
                $('#deleteClientsItems').innerHTML = clients.map(c => `<div class="confirm-modal-client-item">- ${c.id} ${c.nickname ? '(' + c.nickname + ')' : ''}</div>`).join('');
                $('#chkDeleteClients').checked = true;
            } else { clientsList.style.display = 'none'; checkbox.style.display = 'none'; }
            $('#confirmDeleteModal').classList.add('active');
        }
        
        function deleteDevice() {
            if (!currentEditingQp) return;
            if ($('#chkDeleteClients').checked) {
                getClientIdsForQp(currentEditingQp).forEach(c => delete deviceRegistry.clientIds[c.id]);
            }
            delete deviceRegistry.qpSerials[currentEditingQp];
            delete deviceStatus[currentEditingQp];
            saveDeviceRegistry(); closeDeleteModal(); closeDeviceModal(); renderDeviceList(); updateDeviceStats();
            showToast('success', 'Deleted', 'Device deleted successfully');
        }
        
        function selectDevice(qpSerial) {
            const clients = getClientIdsForQp(qpSerial);
            const clientId = clients.length > 0 ? clients[0].id : '';
            $('#qpSerial').value = qpSerial;
            $('#deviceClientId').value = clientId;
            localStorage.setItem(ACTIVE_DEVICE_KEY, JSON.stringify({ qpSerial, clientId }));
            updateTopicsDisplay();
            // Phase 11.2: Sync Device Switcher and Active Device Bars
            updateDeviceSwitcherDisplay();
            updateActiveDeviceBars();
            // If connected, trigger MQTT resubscription
            if (mqttClient && mqttClient.connected) {
                handleDeviceSwitch(qpSerial, clientId);
            }
            const device = deviceRegistry.qpSerials[qpSerial];
            showToast('success', 'Device Selected', `Selected: ${device.nickname || qpSerial}`);
            const overviewTab = document.querySelector('.nav-item[data-tab="overview"]');
            if (overviewTab) overviewTab.click();
        }
        
        function closeDeviceModal() { $('#deviceEditModal').classList.remove('active'); currentEditingQp = null; }
        function closeAddModal() { $('#deviceAddModal').classList.remove('active'); }
        function closeDeleteModal() { $('#confirmDeleteModal').classList.remove('active'); }
        function closeClientModal() { $('#addClientModal').classList.remove('active'); }
        
        function openAddClientModal() {
            if (!currentEditingQp) return;
            $('#newClientId').value = ''; $('#newClientNickname').value = ''; $('#newClientNotes').value = '';
            $('#addClientModal').classList.add('active');
        }
        
        function addClientToDevice() {
            if (!currentEditingQp) return;
            const clientId = $('#newClientId').value.trim().toLowerCase();
            const nickname = $('#newClientNickname').value.trim();
            const notes = $('#newClientNotes').value.trim();
            if (!clientId) { showToast('error', 'Error', 'Please enter Client ID'); return; }
            if (deviceRegistry.clientIds[clientId]) { showToast('warning', 'Warning', 'Client ID already exists'); return; }
            deviceRegistry.clientIds[clientId] = { nickname, qpSerial: currentEditingQp, notes, addedAt: new Date().toISOString() };
            closeClientModal(); openEditDevice(currentEditingQp);
            showToast('success', 'Added', 'Client ID added successfully');
        }
        
        function setupDeviceEventListeners() {
            const searchInput = $('#deviceSearchInput');
            if (searchInput) searchInput.oninput = () => renderDeviceList();
            
            $$('.device-table th[data-sort]').forEach(th => {
                th.onclick = () => {
                    if (deviceSortColumn === th.dataset.sort) deviceSortOrder = deviceSortOrder === 'asc' ? 'desc' : 'asc';
                    else { deviceSortColumn = th.dataset.sort; deviceSortOrder = 'asc'; }
                    renderDeviceList();
                };
            });
            
            if ($('#btnAddDevice')) $('#btnAddDevice').onclick = openAddDevice;
            if ($('#btnAddDeviceEmpty')) $('#btnAddDeviceEmpty').onclick = openAddDevice;
            if ($('#btnCloseDeviceModal')) $('#btnCloseDeviceModal').onclick = closeDeviceModal;
            if ($('#btnCancelDevice')) $('#btnCancelDevice').onclick = closeDeviceModal;
            if ($('#btnSaveDevice')) $('#btnSaveDevice').onclick = saveDevice;
            if ($('#btnDeleteDevice')) $('#btnDeleteDevice').onclick = () => { const qp = currentEditingQp; closeDeviceModal(); confirmDeleteDevice(qp); };
            if ($('#btnAddClientId')) $('#btnAddClientId').onclick = openAddClientModal;
            if ($('#btnCloseAddModal')) $('#btnCloseAddModal').onclick = closeAddModal;
            if ($('#btnCancelAdd')) $('#btnCancelAdd').onclick = closeAddModal;
            if ($('#btnConfirmAdd')) $('#btnConfirmAdd').onclick = addDevice;
            if ($('#btnCancelDelete')) $('#btnCancelDelete').onclick = closeDeleteModal;
            if ($('#btnConfirmDelete')) $('#btnConfirmDelete').onclick = deleteDevice;
            if ($('#btnCloseClientModal')) $('#btnCloseClientModal').onclick = closeClientModal;
            if ($('#btnCancelClient')) $('#btnCancelClient').onclick = closeClientModal;
            if ($('#btnConfirmClient')) $('#btnConfirmClient').onclick = addClientToDevice;
            
            if ($('#deviceEditModal')) $('#deviceEditModal').onclick = (e) => { if (e.target.id === 'deviceEditModal') closeDeviceModal(); };
            if ($('#deviceAddModal')) $('#deviceAddModal').onclick = (e) => { if (e.target.id === 'deviceAddModal') closeAddModal(); };
            if ($('#confirmDeleteModal')) $('#confirmDeleteModal').onclick = (e) => { if (e.target.id === 'confirmDeleteModal') closeDeleteModal(); };
            if ($('#addClientModal')) $('#addClientModal').onclick = (e) => { if (e.target.id === 'addClientModal') closeClientModal(); };
            
            if ($('#btnImportCSV')) $('#btnImportCSV').onclick = () => $('#importCSVFile').click();
            if ($('#btnImportJSON')) $('#btnImportJSON').onclick = () => $('#importJSONFile').click();
            if ($('#btnExportCSV')) $('#btnExportCSV').onclick = exportDevicesCSV;
            if ($('#btnExportJSON')) $('#btnExportJSON').onclick = exportDevicesJSON;
            
            if ($('#importCSVFile')) $('#importCSVFile').onchange = (e) => { if (e.target.files?.[0]) { importDevicesCSV(e.target.files[0]); e.target.value = ''; } };
            if ($('#importJSONFile')) $('#importJSONFile').onchange = (e) => { if (e.target.files?.[0]) { importDevicesJSON(e.target.files[0]); e.target.value = ''; } };
        }
        
        // Import CSV
        function importDevicesCSV(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const lines = e.target.result.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { showToast('error', 'Error', 'Invalid CSV file'); return; }
                    const hasHeader = lines[0].toLowerCase().includes('serial');
                    let imported = 0;
                    for (let i = hasHeader ? 1 : 0; i < lines.length; i++) {
                        const parts = lines[i].split(',').map(p => p.trim());
                        if (parts.length < 2) continue;
                        let qpSerial, clientId;
                        if (parts[0].match(/^\d+$/)) { qpSerial = parts[1].toUpperCase(); clientId = parts[2]?.toLowerCase() || ''; }
                        else { qpSerial = parts[0].toUpperCase(); clientId = parts[1]?.toLowerCase() || ''; }
                        if (!qpSerial || qpSerial.length < 6) continue;
                        if (!deviceRegistry.qpSerials[qpSerial]) {
                            deviceRegistry.qpSerials[qpSerial] = { nickname: "", location: "", notes: "Imported", addedAt: new Date().toISOString() };
                            imported++;
                        }
                        if (clientId && !deviceRegistry.clientIds[clientId]) {
                            deviceRegistry.clientIds[clientId] = { nickname: "", qpSerial, notes: "Imported", addedAt: new Date().toISOString() };
                        }
                    }
                    saveDeviceRegistry(); renderDeviceList(); updateDeviceStats();
                    showToast('success', 'Imported', `Imported ${imported} devices`);
                } catch (err) { showToast('error', 'Error', 'Failed to read CSV file'); }
            };
            reader.readAsText(file);
        }
        
        // Import JSON
        function importDevicesJSON(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    let imported = 0;
                    if (data.qpSerials) {
                        for (const [qp, info] of Object.entries(data.qpSerials)) {
                            if (!deviceRegistry.qpSerials[qp]) {
                                deviceRegistry.qpSerials[qp] = { nickname: info.nickname || "", location: info.location || "", notes: info.notes || "Imported", addedAt: new Date().toISOString() };
                                imported++;
                            }
                        }
                    }
                    if (data.clientIds) {
                        for (const [cid, info] of Object.entries(data.clientIds)) {
                            if (!deviceRegistry.clientIds[cid]) {
                                deviceRegistry.clientIds[cid] = { nickname: info.nickname || "", qpSerial: info.qpSerial || "", notes: info.notes || "Imported", addedAt: new Date().toISOString() };
                            }
                        }
                    }
                    saveDeviceRegistry(); renderDeviceList(); updateDeviceStats();
                    showToast('success', 'Imported', `Imported ${imported} devices`);
                } catch (err) { showToast('error', 'Error', 'Failed to read JSON file'); }
            };
            reader.readAsText(file);
        }
        
        // Export CSV
        function exportDevicesCSV() {
            let csv = 'No.,QP Serial,Client ID,QP Nickname,Client Nickname,Location\n';
            let n = 1;
            for (const [qp, data] of Object.entries(deviceRegistry.qpSerials)) {
                const clients = getClientIdsForQp(qp);
                if (clients.length === 0) { csv += `${n++},${qp},,${data.nickname || ''},,"${data.location || ''}"\n`; }
                else { for (const c of clients) { csv += `${n++},${qp},${c.id},${data.nickname || ''},${c.nickname || ''},"${data.location || ''}"\n`; } }
            }
            downloadFile(csv, 'be-tpp-devices.csv', 'text/csv');
            showToast('success', 'Exported', 'CSV exported successfully');
        }
        
        // Export JSON
        function exportDevicesJSON() {
            const data = { version: "2.0", exportedAt: new Date().toISOString(), qpSerials: deviceRegistry.qpSerials, clientIds: deviceRegistry.clientIds, groups: deviceRegistry.groups };
            downloadFile(JSON.stringify(data, null, 2), 'be-tpp-devices.json', 'application/json');
            showToast('success', 'Exported', 'JSON exported successfully');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        /* ============================================
           Phase 11.3: Multi-Device Monitor
           ============================================ */
        
        // Monitor Configuration
        const MONITOR_CONFIG = {
            OFFLINE_THRESHOLD_MS: 90000,      // 90 seconds (3x publish interval)
            WARNING_PM25: 25,                  // PM2.5 EMA warning threshold
            DANGER_PM25: 50,                   // PM2.5 EMA danger threshold
            WARNING_CO2: 800,                  // CO2 EMA warning threshold
            DANGER_CO2: 1000,                  // CO2 EMA danger threshold
            WARNING_SENSOR_AGE: 60000,         // 60 seconds
            DANGER_SENSOR_AGE: 90000,          // 90 seconds
            // Phase 11.4: ESP Temp thresholds (Celsius)
            WARNING_ESP_TEMP: 50,              // ESP temperature warning
            DANGER_ESP_TEMP: 65,               // ESP temperature danger (may restart)
            // Phase 11.4: Free Heap thresholds (bytes)
            WARNING_HEAP: 50000,               // 50 KB warning
            DANGER_HEAP: 20000,                // 20 KB danger (may crash)
            RSSI_LEVELS: [-50, -60, -70, -80]  // Signal strength thresholds
        };
        
        // Monitor State
        let monitorDeviceData = {};  // { qpSerial: { ...status data... } }
        let isMonitorWildcardSubscribed = false;
        
        // Phase 11.4: Warning Sound System State
        const WARNING_SOUND_CONFIG = {
            DEBOUNCE_MS: 30000,            // 30 seconds between alerts
            TOAST_DURATION_WARNING: 5000,  // 5 seconds for warning toast
            TOAST_DURATION_DANGER: 8000,   // 8 seconds for danger toast
            MAX_WARNING_LOG_ENTRIES: 100,  // Maximum warning log entries
            BEEP_FREQUENCY: 880,           // A5 note (Hz)
            BEEP_DURATION: 150,            // ms per beep
            BEEP_COUNT: 3,                 // Number of beeps
            BEEP_GAP: 100                  // Gap between beeps (ms)
        };
        
        let warningSoundState = {
            audioContext: null,
            isMuted: localStorage.getItem('betpp_sound_muted') === 'true',
            lastPlayTime: 0,
            previousDangerDevices: new Set(),
            previousWarningDevices: new Set(),
            warningLogEntries: []
        };
        
        // Initialize Monitor Tab
        function initMonitorTab() {
            setupMonitorEventListeners();
            renderMonitorGrid();
            updateMonitorSummary();
        }
        
        // Setup Monitor Event Listeners
        function setupMonitorEventListeners() {
            const filterSelect = $('#monitorFilter');
            const groupSelect = $('#monitorGroup');
            const sortSelect = $('#monitorSort');
            const refreshBtn = $('#btnMonitorRefresh');
            
            if (filterSelect) filterSelect.onchange = () => renderMonitorGrid();
            if (groupSelect) groupSelect.onchange = () => renderMonitorGrid();
            if (sortSelect) sortSelect.onchange = () => renderMonitorGrid();
            if (refreshBtn) refreshBtn.onclick = () => {
                refreshBtn.classList.add('spinning');
                renderMonitorGrid();
                updateMonitorSummary();
                setTimeout(() => refreshBtn.classList.remove('spinning'), 1000);
            };
        }
        
        // Check device warnings based on status data
        function checkDeviceWarnings(data) {
            const warnings = [];
            
            // PM2.5 EMA check
            const pm25 = data.pm25_ema ?? data.pm25Ema;
            if (pm25 !== undefined) {
                if (pm25 > MONITOR_CONFIG.DANGER_PM25) {
                    warnings.push({ type: 'pm25', level: 'danger', value: pm25 });
                } else if (pm25 > MONITOR_CONFIG.WARNING_PM25) {
                    warnings.push({ type: 'pm25', level: 'warning', value: pm25 });
                }
            }
            
            // CO2 EMA check
            const co2 = data.co2_ema ?? data.co2Ema;
            if (co2 !== undefined) {
                if (co2 > MONITOR_CONFIG.DANGER_CO2) {
                    warnings.push({ type: 'co2', level: 'danger', value: co2 });
                } else if (co2 > MONITOR_CONFIG.WARNING_CO2) {
                    warnings.push({ type: 'co2', level: 'warning', value: co2 });
                }
            }
            
            // Sensor Age check
            const sensorAge = data.last_sensor_age_ms ?? data.lastSensorAgeMs;
            if (sensorAge !== undefined) {
                if (sensorAge > MONITOR_CONFIG.DANGER_SENSOR_AGE) {
                    warnings.push({ type: 'sensor_age', level: 'danger', value: sensorAge });
                } else if (sensorAge > MONITOR_CONFIG.WARNING_SENSOR_AGE) {
                    warnings.push({ type: 'sensor_age', level: 'warning', value: sensorAge });
                }
            }
            
            // Phase 11.4: ESP Temperature check
            const espTemp = data.esp_temp ?? data.espTemp;
            if (espTemp !== undefined) {
                if (espTemp > MONITOR_CONFIG.DANGER_ESP_TEMP) {
                    warnings.push({ type: 'esp_temp', level: 'danger', value: espTemp });
                } else if (espTemp > MONITOR_CONFIG.WARNING_ESP_TEMP) {
                    warnings.push({ type: 'esp_temp', level: 'warning', value: espTemp });
                }
            }
            
            // Phase 11.4: Free Heap check (lower is worse)
            const freeHeap = data.free_heap ?? data.freeHeap;
            if (freeHeap !== undefined) {
                if (freeHeap < MONITOR_CONFIG.DANGER_HEAP) {
                    warnings.push({ type: 'heap', level: 'danger', value: freeHeap });
                } else if (freeHeap < MONITOR_CONFIG.WARNING_HEAP) {
                    warnings.push({ type: 'heap', level: 'warning', value: freeHeap });
                }
            }
            
            return warnings;
        }
        
        /* ============================================
           Phase 11.4: WARNING SOUND SYSTEM
           ============================================ */
        
        // Initialize Audio Context (must be called after user interaction)
        function initAudioContext() {
            if (warningSoundState.audioContext) return;
            try {
                warningSoundState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('[Warning Sound] AudioContext initialized');
            } catch (e) {
                console.warn('[Warning Sound] Failed to create AudioContext:', e);
            }
        }
        
        // Play danger beep sound using Web Audio API
        function playDangerBeep() {
            if (warningSoundState.isMuted) return;
            if (!warningSoundState.audioContext) {
                initAudioContext();
                if (!warningSoundState.audioContext) return;
            }
            
            // Debounce check
            const now = Date.now();
            if (now - warningSoundState.lastPlayTime < WARNING_SOUND_CONFIG.DEBOUNCE_MS) {
                console.log('[Warning Sound] Debounced - too soon since last alert');
                return;
            }
            warningSoundState.lastPlayTime = now;
            
            const ctx = warningSoundState.audioContext;
            const { BEEP_FREQUENCY, BEEP_DURATION, BEEP_COUNT, BEEP_GAP } = WARNING_SOUND_CONFIG;
            
            // Resume context if suspended (iOS requirement)
            if (ctx.state === 'suspended') {
                ctx.resume();
            }
            
            // Play beep sequence
            for (let i = 0; i < BEEP_COUNT; i++) {
                const startTime = ctx.currentTime + (i * (BEEP_DURATION + BEEP_GAP)) / 1000;
                
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(BEEP_FREQUENCY, startTime);
                
                // Envelope for smooth sound
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + (BEEP_DURATION / 1000) - 0.01);
                gainNode.gain.linearRampToValueAtTime(0, startTime + (BEEP_DURATION / 1000));
                
                oscillator.start(startTime);
                oscillator.stop(startTime + (BEEP_DURATION / 1000));
            }
            
            console.log('[Warning Sound] Playing danger alert');
        }
        
        // Toggle sound mute state
        function toggleSoundMute() {
            warningSoundState.isMuted = !warningSoundState.isMuted;
            localStorage.setItem('betpp_sound_muted', warningSoundState.isMuted);
            
            const btn = $('#soundToggle');
            if (btn) {
                btn.classList.toggle('muted', warningSoundState.isMuted);
                btn.title = warningSoundState.isMuted ? 'Click to unmute alerts' : 'Click to mute alerts';
            }
            
            showToast('info', warningSoundState.isMuted ? 'Alerts Muted' : 'Alerts Enabled', 
                warningSoundState.isMuted ? 'You will not hear danger alerts' : 'Sound alerts are now active');
        }
        
        // Format warning type for display
        function formatWarningType(type) {
            const typeMap = {
                'pm25': 'PM2.5',
                'co2': 'CO2',
                'sensor_age': 'Sensor Age',
                'esp_temp': 'ESP Temp',
                'heap': 'Free Heap'
            };
            return typeMap[type] || type;
        }
        
        // Format warning value for display
        function formatWarningValue(type, value) {
            switch (type) {
                case 'pm25': return value.toFixed(1) + ' ug/m3';
                case 'co2': return Math.round(value) + ' ppm';
                case 'sensor_age': return Math.round(value / 1000) + 's';
                case 'esp_temp': return value.toFixed(1) + ' C';
                case 'heap': return (value / 1024).toFixed(1) + ' KB';
                default: return value;
            }
        }
        
        // Add entry to warning log
        function addWarningLog(qpSerial, warnings, deviceNickname) {
            if (!warnings || warnings.length === 0) return;
            
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0]; // HH:MM:SS
            const displayName = deviceNickname || qpSerial;
            
            // Add entries for each warning
            warnings.forEach(warning => {
                const entry = {
                    time: timeStr,
                    timestamp: now.getTime(),
                    device: displayName,
                    qpSerial: qpSerial,
                    type: warning.type,
                    value: warning.value,
                    level: warning.level
                };
                
                warningSoundState.warningLogEntries.unshift(entry);
            });
            
            // Limit entries
            if (warningSoundState.warningLogEntries.length > WARNING_SOUND_CONFIG.MAX_WARNING_LOG_ENTRIES) {
                warningSoundState.warningLogEntries = warningSoundState.warningLogEntries.slice(0, WARNING_SOUND_CONFIG.MAX_WARNING_LOG_ENTRIES);
            }
            
            renderWarningLog();
        }
        
        // Render warning log viewer
        function renderWarningLog() {
            const viewer = $('#warningLogViewer');
            const countBadge = $('#warningLogCount');
            if (!viewer) return;
            
            const entries = warningSoundState.warningLogEntries;
            
            if (entries.length === 0) {
                viewer.innerHTML = '<div class="warning-log-empty">No warnings recorded yet</div>';
                if (countBadge) countBadge.textContent = '0 entries';
                return;
            }
            
            viewer.innerHTML = entries.map(entry => `
                <div class="warning-log-entry ${entry.level}">
                    <span class="warning-log-time">${entry.time}</span>
                    <span class="warning-log-device" title="${entry.qpSerial}">${entry.device}</span>
                    <span class="warning-log-type">${formatWarningType(entry.type)}</span>
                    <span class="warning-log-value">${formatWarningValue(entry.type, entry.value)}</span>
                    <span class="warning-log-level ${entry.level}">${entry.level.toUpperCase()}</span>
                </div>
            `).join('');
            
            if (countBadge) countBadge.textContent = `${entries.length} entries`;
        }
        
        // Clear warning log
        function clearWarningLog() {
            warningSoundState.warningLogEntries = [];
            renderWarningLog();
            showToast('info', 'Cleared', 'Warning history cleared');
        }
        
        // Show warning toast with grouped warnings
        function showWarningToast(qpSerial, warnings, deviceNickname) {
            if (!warnings || warnings.length === 0) return;
            
            const displayName = deviceNickname || qpSerial;
            const hasDanger = warnings.some(w => w.level === 'danger');
            const level = hasDanger ? 'danger' : 'warning';
            const toastType = hasDanger ? 'error' : 'warning';
            
            // Group warnings by type
            const warningTexts = warnings.map(w => 
                `${formatWarningType(w.type)}: ${formatWarningValue(w.type, w.value)}`
            );
            
            const title = `${hasDanger ? 'DANGER' : 'Warning'}: ${displayName}`;
            const message = warningTexts.slice(0, 3).join(', ') + (warningTexts.length > 3 ? '...' : '');
            
            // Custom toast with extended duration for danger
            const duration = hasDanger ? WARNING_SOUND_CONFIG.TOAST_DURATION_DANGER : WARNING_SOUND_CONFIG.TOAST_DURATION_WARNING;
            showToastWithDuration(toastType, title, message, duration);
        }
        
        // Show toast with custom duration
        function showToastWithDuration(type, title, message, duration) {
            const container = $('#toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { 
                success: '<polyline points="20 6 9 17 4 12"/>', 
                warning: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>', 
                error: '<polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>', 
                info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>' 
            };
            toast.innerHTML = `<svg class="toast-icon" viewBox="0 0 24 24">${icons[type]}</svg><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
            toast.querySelector('.toast-close').onclick = () => toast.remove();
            container.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }
        
        // Process device warnings and trigger alerts
        function processDeviceWarnings(qpSerial, warnings, deviceNickname) {
            const hasDanger = warnings.some(w => w.level === 'danger');
            const hasWarning = warnings.length > 0;
            
            const wasDanger = warningSoundState.previousDangerDevices.has(qpSerial);
            const wasWarning = warningSoundState.previousWarningDevices.has(qpSerial);
            
            // Check for NEW danger (wasn't danger before)
            if (hasDanger && !wasDanger) {
                // Play sound for new danger
                playDangerBeep();
                // Show toast
                showWarningToast(qpSerial, warnings, deviceNickname);
                // Log to warning history
                addWarningLog(qpSerial, warnings, deviceNickname);
            } 
            // Check for NEW warning (wasn't warning or danger before)
            else if (hasWarning && !wasDanger && !wasWarning) {
                // Show toast only (no sound for warnings)
                showWarningToast(qpSerial, warnings, deviceNickname);
                // Log to warning history
                addWarningLog(qpSerial, warnings, deviceNickname);
            }
            
            // Update tracking sets
            if (hasDanger) {
                warningSoundState.previousDangerDevices.add(qpSerial);
                warningSoundState.previousWarningDevices.delete(qpSerial);
            } else if (hasWarning) {
                warningSoundState.previousDangerDevices.delete(qpSerial);
                warningSoundState.previousWarningDevices.add(qpSerial);
            } else {
                warningSoundState.previousDangerDevices.delete(qpSerial);
                warningSoundState.previousWarningDevices.delete(qpSerial);
            }
        }
        
        // Get device monitor status (online/warning/danger/offline)
        function getMonitorDeviceStatus(qpSerial) {
            const data = monitorDeviceData[qpSerial];
            if (!data || !data.lastSeen) return 'offline';
            
            const now = Date.now();
            if (now - data.lastSeen > MONITOR_CONFIG.OFFLINE_THRESHOLD_MS) return 'offline';
            
            const warnings = checkDeviceWarnings(data);
            if (warnings.some(w => w.level === 'danger')) return 'danger';
            if (warnings.length > 0) return 'warning';
            
            return 'online';
        }
        
        // Get RSSI level (1-5) and class
        function getRssiInfo(rssi) {
            if (rssi === undefined || rssi === null) return { level: 0, class: '' };
            
            let level = 1;
            if (rssi >= -50) level = 5;
            else if (rssi >= -60) level = 4;
            else if (rssi >= -70) level = 3;
            else if (rssi >= -80) level = 2;
            
            let cls = '';
            if (level <= 2) cls = 'poor';
            else if (level <= 3) cls = 'weak';
            
            return { level, class: cls };
        }
        
        // Get sensor age class
        function getSensorAgeClass(ageMs) {
            if (ageMs === undefined || ageMs === null) return '';
            if (ageMs > MONITOR_CONFIG.DANGER_SENSOR_AGE) return 'stale';
            if (ageMs > MONITOR_CONFIG.WARNING_SENSOR_AGE) return 'aging';
            return '';
        }
        
        // Create device card HTML
        function createMonitorCard(qpSerial) {
            const regData = deviceRegistry.qpSerials[qpSerial] || {};
            const statusData = monitorDeviceData[qpSerial] || {};
            const deviceStat = getMonitorDeviceStatus(qpSerial);
            const warnings = checkDeviceWarnings(statusData);
            
            // Extract values with fallbacks
            const nickname = regData.nickname || regData.location || 'Unnamed';
            const fanSpeed = statusData.fan_speed ?? statusData.fanSpeed ?? '--';
            const fanMode = statusData.fan_mode ?? statusData.fanMode ?? '--';
            const fanState = statusData.fan_state ?? statusData.fanState ?? '';
            const rssi = statusData.rssi;
            const pm25Ema = statusData.pm25_ema ?? statusData.pm25Ema;
            const co2Ema = statusData.co2_ema ?? statusData.co2Ema;
            const sensorAgeMs = statusData.last_sensor_age_ms ?? statusData.lastSensorAgeMs;
            const temp = statusData.temp ?? statusData.temperature;
            const humidity = statusData.humidity;
            
            // Card class based on status
            let cardClass = 'monitor-card';
            if (deviceStat === 'danger') cardClass += ' danger';
            else if (deviceStat === 'warning') cardClass += ' warning';
            else if (deviceStat === 'offline') cardClass += ' offline';
            
            // Add new-device class if still loading sensor data (not offline and missing temp/humidity)
            const isLoadingData = deviceStat !== 'offline' && (temp === undefined || humidity === undefined);
            if (isLoadingData) cardClass += ' new-device';
            
            // Status dot class
            let dotClass = 'monitor-card-dot ' + deviceStat;
            
            // Fan state badge
            let stateHtml = '';
            if (fanState && deviceStat !== 'offline') {
                stateHtml = `<span class="monitor-card-state ${fanState}">${fanState}</span>`;
            }
            
            // RSSI bars
            const rssiInfo = getRssiInfo(rssi);
            let rssiBarsHtml = `<div class="monitor-rssi ${rssiInfo.class}">`;
            for (let i = 1; i <= 5; i++) {
                rssiBarsHtml += `<div class="monitor-rssi-bar ${i <= rssiInfo.level ? 'active' : ''}"></div>`;
            }
            rssiBarsHtml += '</div>';
            
            // PM2.5 warning class
            const pm25Warning = warnings.find(w => w.type === 'pm25');
            const pm25Class = pm25Warning ? pm25Warning.level : '';
            
            // CO2 warning class
            const co2Warning = warnings.find(w => w.type === 'co2');
            const co2Class = co2Warning ? co2Warning.level : '';
            
            // Sensor age
            const ageClass = getSensorAgeClass(sensorAgeMs);
            const ageSec = sensorAgeMs !== undefined ? (sensorAgeMs / 1000).toFixed(0) : '--';
            
            // Fan mode badge class
            const modeClass = fanMode === 'automatic' ? 'auto' : (fanMode === 'custom' ? 'custom' : '');
            const modeText = fanMode === 'automatic' ? 'AUTO' : (fanMode === 'custom' ? 'CUSTOM' : '--');
            
            // Last seen (for offline)
            let lastSeenHtml = '';
            if (deviceStat === 'offline' && statusData.lastSeen) {
                lastSeenHtml = `<span class="monitor-lastseen">Last: ${formatLastSeen(statusData.lastSeen)}</span>`;
            }
            
            return `
                <div class="${cardClass}" data-qp="${qpSerial}" onclick="handleMonitorCardClick('${qpSerial}')">
                    <div class="monitor-card-header">
                        <div class="monitor-card-info">
                            <div class="monitor-card-name">${nickname}</div>
                            <div class="monitor-card-serial">${qpSerial}</div>
                        </div>
                        <div class="monitor-card-status">
                            ${stateHtml}
                            <div class="${dotClass}"></div>
                        </div>
                    </div>
                    <div class="monitor-card-metrics">
                        <div class="monitor-metric ${pm25Class}${pm25Ema === undefined ? ' loading' : ''}">
                            <div class="monitor-metric-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/></svg></div>
                            <span class="monitor-metric-value">${pm25Ema !== undefined ? pm25Ema.toFixed(0) : '--'}</span>
                            <span class="monitor-metric-unit">PM2.5</span>
                        </div>
                        <div class="monitor-metric ${co2Class}${co2Ema === undefined ? ' loading' : ''}">
                            <div class="monitor-metric-icon"><svg viewBox="0 0 24 24"><path d="M4 19h16M4 15h16M4 11h16M4 7h16"/></svg></div>
                            <span class="monitor-metric-value">${co2Ema !== undefined ? Math.round(co2Ema) : '--'}</span>
                            <span class="monitor-metric-unit">CO2</span>
                        </div>
                        <div class="monitor-metric${temp === undefined ? ' loading' : ''}">
                            <div class="monitor-metric-icon"><svg viewBox="0 0 24 24"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg></div>
                            <span class="monitor-metric-value">${temp !== undefined ? temp.toFixed(1) : '--'}</span>
                            <span class="monitor-metric-unit">C</span>
                        </div>
                        <div class="monitor-metric${humidity === undefined ? ' loading' : ''}">
                            <div class="monitor-metric-icon"><svg viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div>
                            <span class="monitor-metric-value">${humidity !== undefined ? humidity.toFixed(0) : '--'}</span>
                            <span class="monitor-metric-unit">%</span>
                        </div>
                    </div>
                    <div class="monitor-card-footer">
                        <div class="monitor-card-fan">
                            <span class="monitor-fan-mode ${modeClass}">${modeText}</span>
                            <span class="monitor-fan-speed">${fanSpeed}%</span>
                        </div>
                        ${rssiBarsHtml}
                        <div class="monitor-age ${ageClass}">
                            <div class="monitor-age-dot"></div>
                            <span>${ageSec}s</span>
                        </div>
                        ${lastSeenHtml}
                    </div>
                </div>
            `;
        }
        
        // Render monitor grid
        function renderMonitorGrid() {
            const grid = $('#monitorGrid');
            const emptyState = $('#monitorEmptyState');
            if (!grid) return;
            
            const filter = $('#monitorFilter')?.value || 'all';
            const groupBy = $('#monitorGroup')?.value || 'status';
            const sortBy = $('#monitorSort')?.value || 'status';
            
            // Get all devices from registry
            let devices = Object.keys(deviceRegistry.qpSerials).map(qpSerial => ({
                qpSerial,
                status: getMonitorDeviceStatus(qpSerial),
                data: monitorDeviceData[qpSerial] || {},
                regData: deviceRegistry.qpSerials[qpSerial] || {}
            }));
            
            // Filter
            if (filter !== 'all') {
                if (filter === 'warning') {
                    devices = devices.filter(d => d.status === 'warning' || d.status === 'danger');
                } else {
                    devices = devices.filter(d => d.status === filter);
                }
            }
            
            // Sort
            devices.sort((a, b) => {
                switch (sortBy) {
                    case 'status':
                        const order = { danger: 0, warning: 1, online: 2, offline: 3 };
                        return order[a.status] - order[b.status];
                    case 'name':
                        const nameA = a.regData.nickname || a.qpSerial;
                        const nameB = b.regData.nickname || b.qpSerial;
                        return nameA.localeCompare(nameB);
                    case 'serial':
                        return a.qpSerial.localeCompare(b.qpSerial);
                    case 'pm25':
                        const pm25A = a.data.pm25_ema ?? a.data.pm25Ema ?? -1;
                        const pm25B = b.data.pm25_ema ?? b.data.pm25Ema ?? -1;
                        return pm25B - pm25A;  // Descending
                    case 'co2':
                        const co2A = a.data.co2_ema ?? a.data.co2Ema ?? -1;
                        const co2B = b.data.co2_ema ?? b.data.co2Ema ?? -1;
                        return co2B - co2A;  // Descending
                    default:
                        return 0;
                }
            });
            
            // Check if empty
            if (devices.length === 0) {
                grid.innerHTML = '';
                if (emptyState) {
                    emptyState.style.display = 'block';
                    grid.appendChild(emptyState);
                }
                return;
            }
            if (emptyState) emptyState.style.display = 'none';
            
            // Render with or without grouping
            let html = '';
            
            if (groupBy === 'status') {
                // Group by status
                const groups = {
                    danger: devices.filter(d => d.status === 'danger'),
                    warning: devices.filter(d => d.status === 'warning'),
                    online: devices.filter(d => d.status === 'online'),
                    offline: devices.filter(d => d.status === 'offline')
                };
                
                // Render each group
                for (const [status, groupDevices] of Object.entries(groups)) {
                    if (groupDevices.length === 0) continue;
                    
                    const icons = {
                        danger: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                        warning: '<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                        online: '<svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                        offline: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>'
                    };
                    const titles = { danger: 'Danger', warning: 'Warning', online: 'Online', offline: 'Offline' };
                    
                    html += `
                        <div class="monitor-group ${status}">
                            <div class="monitor-group-icon">${icons[status]}</div>
                            <span class="monitor-group-title">${titles[status]}</span>
                            <span class="monitor-group-count">${groupDevices.length}</span>
                            <div class="monitor-group-line"></div>
                        </div>
                    `;
                    
                    for (const device of groupDevices) {
                        html += createMonitorCard(device.qpSerial);
                    }
                }
            } else {
                // No grouping
                for (const device of devices) {
                    html += createMonitorCard(device.qpSerial);
                }
            }
            
            grid.innerHTML = html;
        }
        
        // Update summary bar counts
        function updateMonitorSummary() {
            const devices = Object.keys(deviceRegistry.qpSerials);
            let online = 0, warning = 0, danger = 0, offline = 0;
            
            for (const qpSerial of devices) {
                const status = getMonitorDeviceStatus(qpSerial);
                if (status === 'online') online++;
                else if (status === 'warning') warning++;
                else if (status === 'danger') danger++;
                else offline++;
            }
            
            const total = devices.length;
            
            if ($('#monitorTotal')) $('#monitorTotal').textContent = total;
            if ($('#monitorOnline')) $('#monitorOnline').textContent = online;
            if ($('#monitorWarning')) $('#monitorWarning').textContent = warning;
            if ($('#monitorDanger')) $('#monitorDanger').textContent = danger;
            if ($('#monitorOffline')) $('#monitorOffline').textContent = offline;
            
            // Update sidebar badge
            const badge = $('#monitorStatusBadge');
            if (badge) {
                // Clear all state classes first
                badge.classList.remove('has-warning', 'has-danger', 'all-online');
                
                if (total === 0) {
                    // No devices registered
                    badge.textContent = '--';
                } else if (danger > 0) {
                    // Has danger devices (most severe)
                    badge.textContent = danger;
                    badge.classList.add('has-danger');
                } else if (warning > 0) {
                    // Has warning devices
                    badge.textContent = warning;
                    badge.classList.add('has-warning');
                } else if (offline > 0) {
                    // Has offline devices (show as danger)
                    badge.textContent = `${online}/${total}`;
                    badge.classList.add('has-danger');
                } else if (online === total) {
                    // All devices online
                    badge.textContent = `${online}/${total}`;
                    badge.classList.add('all-online');
                } else {
                    // Default state
                    badge.textContent = `${online}/${total}`;
                }
            }
        }
        
        // Handle card click - switch to Overview
        function handleMonitorCardClick(qpSerial) {
            const clientIds = getClientIdsForQp(qpSerial);
            const clientId = clientIds.length > 0 ? clientIds[0].id : '';
            
            // Update form fields
            $('#qpSerial').value = qpSerial;
            if (clientId) $('#deviceClientId').value = clientId;
            
            // Save to localStorage
            localStorage.setItem(ACTIVE_DEVICE_KEY, JSON.stringify({ qpSerial, clientId }));
            
            // Update displays
            updateDeviceSwitcherDisplay();
            updateTopicsDisplay();
            updateActiveDeviceBars();
            
            // Switch to Overview tab
            $$('.nav-item').forEach(n => n.classList.remove('active'));
            const overviewTab = document.querySelector('.nav-item[data-tab="overview"]');
            if (overviewTab) overviewTab.classList.add('active');
            $$('.tab-panel').forEach(p => p.classList.remove('active'));
            $('#tab-overview').classList.add('active');
            $('#pageTitle').textContent = 'Overview';
            
            // If connected, switch MQTT subscription
            if (mqttClient && mqttClient.connected) {
                handleDeviceSwitch(qpSerial, clientId);
            }
            
            showToast('info', 'Device Selected', `Switched to ${qpSerial}`);
            addLog('system', `Monitor: Switched to device ${qpSerial}`);
        }
        
        // Update monitor data from MQTT message
        function updateMonitorDeviceData(qpSerial, statusData) {
            if (!monitorDeviceData[qpSerial]) {
                monitorDeviceData[qpSerial] = {};
            }
            
            // Merge status data
            Object.assign(monitorDeviceData[qpSerial], statusData);
            monitorDeviceData[qpSerial].lastSeen = Date.now();
            
            // Phase 11.4: Check and process warnings
            const warnings = checkDeviceWarnings(monitorDeviceData[qpSerial]);
            const regData = deviceRegistry.qpSerials[qpSerial] || {};
            const nickname = regData.nickname || regData.location || qpSerial;
            processDeviceWarnings(qpSerial, warnings, nickname);
            
            // Update monitor UI if tab is active
            const monitorTab = $('#tab-monitor');
            if (monitorTab && monitorTab.classList.contains('active')) {
                // Update only the affected card for performance
                const card = document.querySelector(`.monitor-card[data-qp="${qpSerial}"]`);
                if (card) {
                    const newCardHtml = createMonitorCard(qpSerial);
                    const temp = document.createElement('div');
                    temp.innerHTML = newCardHtml;
                    card.replaceWith(temp.firstElementChild);
                }
                updateMonitorSummary();
            } else {
                // Just update summary badge even if not on monitor tab
                updateMonitorSummary();
            }
        }
        
        // Subscribe to wildcard topics for monitoring
        function subscribeMonitorWildcard() {
            if (!mqttClient || !mqttClient.connected || isMonitorWildcardSubscribed) return;
            
            // Subscribe to both status and sensor wildcards for complete data
            // Note: sensors topic is /be-tpp/{serial}/sensors (not /fan/sensors)
            const statusWildcard = '/be-tpp/+/fan/status';
            const sensorWildcard = '/be-tpp/+/sensors';
            
            mqttClient.subscribe([statusWildcard, sensorWildcard], (err) => {
                if (err) {
                    addLog('error', 'Monitor wildcard subscribe failed: ' + err.message);
                } else {
                    isMonitorWildcardSubscribed = true;
                    addLog('system', 'Monitor: Subscribed to status + sensor wildcards');
                }
            });
        }
        
        // Unsubscribe from wildcard
        function unsubscribeMonitorWildcard() {
            if (!mqttClient || !isMonitorWildcardSubscribed) return;
            
            const statusWildcard = '/be-tpp/+/fan/status';
            const sensorWildcard = '/be-tpp/+/sensors';
            
            mqttClient.unsubscribe([statusWildcard, sensorWildcard], (err) => {
                if (!err) {
                    isMonitorWildcardSubscribed = false;
                    addLog('system', 'Monitor: Unsubscribed from wildcards');
                }
            });
        }
        
        // Handle wildcard MQTT message for monitor
        function handleMonitorMessage(topic, payload) {
            // Extract QP Serial from topic: /be-tpp/{qpSerial}/fan/status or /be-tpp/{qpSerial}/sensors
            const statusMatch = topic.match(/\/be-tpp\/([^/]+)\/fan\/status/);
            const sensorMatch = topic.match(/\/be-tpp\/([^/]+)\/sensors/);
            
            if (!statusMatch && !sensorMatch) return false;
            
            const qpSerial = statusMatch ? statusMatch[1] : sensorMatch[1];
            const isStatusTopic = !!statusMatch;
            const isSensorTopic = !!sensorMatch;
            
            // Auto-register device if not in registry
            if (!deviceRegistry.qpSerials[qpSerial]) {
                deviceRegistry.qpSerials[qpSerial] = {
                    nickname: '',
                    location: '',
                    notes: 'Auto-detected from Monitor',
                    addedAt: new Date().toISOString()
                };
                saveDeviceRegistry();
                renderDeviceList();
                updateDeviceStats();
            }
            
            // Update device status tracking
            if (!deviceStatus[qpSerial]) {
                deviceStatus[qpSerial] = { online: true, lastSeen: Date.now(), clientIds: [] };
            }
            deviceStatus[qpSerial].lastSeen = Date.now();
            
            // Handle status topic - auto-register client ID
            if (isStatusTopic) {
                const clientId = payload.client_id ?? payload.clientId;
                if (clientId) {
                    if (!deviceRegistry.clientIds[clientId]) {
                        deviceRegistry.clientIds[clientId] = {
                            nickname: '',
                            qpSerial: qpSerial,
                            notes: 'Auto-detected from Monitor',
                            addedAt: new Date().toISOString()
                        };
                        saveDeviceRegistry();
                    }
                    if (!deviceStatus[qpSerial].clientIds.includes(clientId)) {
                        deviceStatus[qpSerial].clientIds.push(clientId);
                    }
                }
                // Update monitor data with status payload
                updateMonitorDeviceData(qpSerial, payload);
            }
            
            // Handle sensor topic - update temp/humidity for all devices
            if (isSensorTopic) {
                const sensorData = {};
                
                // Support both direct payload and { sensors: [...] } structure
                let sensorPayload = payload;
                if (payload.sensors && Array.isArray(payload.sensors) && payload.sensors.length > 0) {
                    sensorPayload = payload.sensors[0];
                }
                
                if (sensorPayload.temperature !== undefined) sensorData.temp = parseFloat(sensorPayload.temperature);
                if (sensorPayload.humidity !== undefined) sensorData.humidity = parseFloat(sensorPayload.humidity);
                if (sensorPayload.pm25 !== undefined) sensorData.pm25_live = parseFloat(sensorPayload.pm25);
                if (sensorPayload.co2 !== undefined) sensorData.co2_live = parseFloat(sensorPayload.co2);
                
                // Update monitor data with sensor values
                if (Object.keys(sensorData).length > 0) {
                    updateMonitorDeviceData(qpSerial, sensorData);
                }
            }
            
            return true;
        }
        
        // Switch to Devices tab (used by empty state button)
        function switchToDevicesTab() {
            $$('.nav-item').forEach(n => n.classList.remove('active'));
            const devicesTab = document.querySelector('.nav-item[data-tab="devices"]');
            if (devicesTab) devicesTab.classList.add('active');
            $$('.tab-panel').forEach(p => p.classList.remove('active'));
            $('#tab-devices').classList.add('active');
            $('#pageTitle').textContent = 'Devices';
        }
        
        // Periodic check for offline devices (unified check for all components)
        // B2+B3+B4+B5+B6: Updates Monitor, Devices Table, Stats, and Device Switcher
        function checkMonitorOfflineDevices() {
            const now = Date.now();
            let hasMonitorChanges = false;
            
            // Check Monitor tab devices (90s threshold)
            for (const qpSerial of Object.keys(monitorDeviceData)) {
                const data = monitorDeviceData[qpSerial];
                if (data.lastSeen && now - data.lastSeen > MONITOR_CONFIG.OFFLINE_THRESHOLD_MS) {
                    const oldStatus = data._lastStatus;
                    const newStatus = 'offline';
                    if (oldStatus !== newStatus) {
                        data._lastStatus = newStatus;
                        hasMonitorChanges = true;
                    }
                }
            }
            
            // B6: Always update Monitor summary and sidebar badge (regardless of which tab is active)
            updateMonitorSummary();
            
            // Always update Monitor grid when Monitor tab is active (for consistent status display)
            const monitorTab = $('#tab-monitor');
            if (monitorTab && monitorTab.classList.contains('active')) {
                renderMonitorGrid();
            }
            
            // B2+B5: Update Devices table (only if Devices tab is active for performance)
            const devicesTab = $('#tab-devices');
            if (devicesTab && devicesTab.classList.contains('active')) {
                renderDeviceList();
            }
            
            // B3: Always update Device Stats bar (sidebar badge needs this)
            updateDeviceStats();
            
            // B4: Always update Device Switcher display (visible on all tabs)
            updateDeviceSwitcherDisplay();
        }
        
        // Start monitor offline checker interval
        let monitorOfflineCheckInterval = null;
        function startMonitorOfflineChecker() {
            if (monitorOfflineCheckInterval) return;
            monitorOfflineCheckInterval = setInterval(checkMonitorOfflineDevices, 10000);  // Every 10 seconds
        }
        
        function stopMonitorOfflineChecker() {
            if (monitorOfflineCheckInterval) {
                clearInterval(monitorOfflineCheckInterval);
                monitorOfflineCheckInterval = null;
            }
        }
        
        /* ============================================
           Phase 10.5: Double-click Prevention Utility
           ============================================ */
        // Prevent double-click - disable temporary buttons
        function lockButton(buttonId, timeout = 5000) {
            const btn = $(buttonId);
            if (!btn) return null;
            
            // Save original state
            const original = {
                html: btn.innerHTML,
                disabled: btn.disabled
            };
            
            // Disable and show loading
            btn.disabled = true;
            btn.innerHTML = `<svg class="spin" viewBox="0 0 24 24" width="14" height="14"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="30 60"/></svg><span>Sending...</span>`;
            
            // Auto unlock after timeout (safety)
            setTimeout(() => unlockButton(buttonId, original), timeout);
            
            return original;
        }
        
        function unlockButton(buttonId, original) {
            const btn = $(buttonId);
            if (!btn || !original) return;
            btn.disabled = original.disabled;
            btn.innerHTML = original.html;
        }
        
        /* ============================================
           FIX: Generate unique Web Client ID
           ============================================ */
        function generateWebClientId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let random = '';
            for (let i = 0; i < 8; i++) {
                random += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `be-pwa_${random}`;
        }
        
        /* ============================================
           MQTT Topics - Use Device Client ID for topics
           ============================================ */
        function getTopics() {
            const qpSerial = $('#qpSerial').value;
            const deviceClientId = $('#deviceClientId').value || 'default-device';
            return {
                status: `/be-tpp/${qpSerial}/fan/status`,
                sensors: `/be-tpp/${qpSerial}/sensors`,
                diag: `/be-tpp/${deviceClientId}/diag`,
                diagCmd: `/be-tpp/${deviceClientId}/diag/cmd`,
                mode: `/be-tpp/${qpSerial}/fan/mode`,
                speed: `/be-tpp/${qpSerial}/fan/speed`,
                config: `/be-tpp/${deviceClientId}/config`
            };
        }
        
        function updateTopicsDisplay() {
            const topics = getTopics();
            $('#topicStatus').textContent = topics.status;
            $('#topicSensors').textContent = topics.sensors;
            $('#topicMode').textContent = topics.mode;
            $('#topicSpeed').textContent = topics.speed;
            $('#topicConfig').textContent = topics.config;
            $('#topicDiag').textContent = topics.diag;
            $('#topicDiagCmd').textContent = topics.diagCmd;
        }
        
        /* ============================================
           MQTT Connection - Use Web Client ID for connect
           ============================================ */
        function connect() {
            const brokerUrl = $('#brokerUrl').value;
            const username = $('#mqttUsername').value;
            const password = $('#mqttPassword').value;
            
            if (!brokerUrl) { 
                showToast('error', 'Error', 'Broker URL is required'); 
                return; 
            }
            
            // FIX: Use Web Client ID (auto-generated) for MQTT connection
            // Do not use Device Client ID to avoid conflict with ESP32
            webClientId = generateWebClientId();
            $('#webClientId').value = webClientId;
            
            saveConfig();
            
            // Phase 11.4: Initialize AudioContext on user interaction (browser requirement)
            initAudioContext();
            
            updateStatus('connecting');
            addLog('system', `Connecting as "${webClientId}" to ${brokerUrl}...`);
            
            const options = { 
                clientId: webClientId, // Use Web Client ID
                clean: true, 
                reconnectPeriod: CONFIG.RECONNECT_DELAY 
            };
            
            if (username) { 
                options.username = username; 
                options.password = password; 
            }
            
            try {
                mqttClient = mqtt.connect(brokerUrl, options);
                
                mqttClient.on('connect', () => {
                    updateStatus('online');
                    addLog('system', `Connected as "${webClientId}"`);
                    showToast('success', 'Connected', `Client ID: ${webClientId}`);
                    
                    const topics = getTopics();
                    const topicsToSubscribe = [topics.status, topics.sensors, topics.diag];
                    mqttClient.subscribe(topicsToSubscribe, (err) => {
                        if (err) { 
                            addLog('error', 'Subscribe error: ' + err.message); 
                        } else { 
                            // Phase 11.2: Track subscribed topics
                            currentSubscribedTopics = topicsToSubscribe;
                            addLog('system', 'Subscribed to topics'); 
                        }
                    });
                    
                    // Phase 11.3: Subscribe to wildcard for Monitor tab
                    subscribeMonitorWildcard();
                    startMonitorOfflineChecker();
                });
                
                mqttClient.on('message', handleMessage);
                mqttClient.on('error', (err) => { 
                    addLog('error', 'MQTT Error: ' + err.message); 
                    showToast('error', 'MQTT Error', err.message); 
                });
                mqttClient.on('close', () => { 
                    updateStatus('offline'); 
                    addLog('system', 'Disconnected from MQTT broker'); 
                });
                mqttClient.on('reconnect', () => { 
                    updateStatus('reconnecting'); 
                    addLog('system', 'Reconnecting...'); 
                });
                
            } catch (err) {
                updateStatus('offline');
                addLog('error', 'Connection failed: ' + err.message);
                showToast('error', 'Connection Failed', err.message);
            }
        }
        
        function disconnect() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
            // Phase 11.2: Clear tracked topics on disconnect
            currentSubscribedTopics = [];
            // Phase 11.3: Cleanup monitor
            isMonitorWildcardSubscribed = false;
            stopMonitorOfflineChecker();
            updateStatus('offline');
            addLog('system', 'Disconnected');
            showToast('info', 'Disconnected', 'MQTT connection closed');
        }
        
        function updateStatus(status) {
            const dot = $('#mqttStatusDot');
            const text = $('#mqttStatusText');
            const btnConnect = $('#btnConnect');
            const btnDisconnect = $('#btnDisconnect');
            
            // Clear reconnect timer if exists
            if (reconnectTimer) {
                clearInterval(reconnectTimer);
                reconnectTimer = null;
            }
            
            dot.className = 'status-dot';
            
            // B.3: Toggle empty state based on connection status
            const emptyState = $('#overviewEmptyState');
            
            if (status === 'online') {
                dot.classList.add('online');
                text.textContent = 'Connected';
                btnConnect.disabled = true;
                btnDisconnect.disabled = false;
                // B.2: Remove skeleton when connected (data will come soon)
                setSkeletonLoading(false);
                // B.3: Hide empty state
                if (emptyState) emptyState.classList.remove('show');
            } else if (status === 'connecting') {
                dot.classList.add('connecting');
                text.textContent = 'Connecting...';
                btnConnect.disabled = true;
                btnDisconnect.disabled = false;
                // B.2: Show skeleton loading while connecting
                setSkeletonLoading(true);
                // B.3: Hide empty state while connecting
                if (emptyState) emptyState.classList.remove('show');
            } else if (status === 'reconnecting') {
                // Phase 7: Reconnect countdown
                dot.classList.add('connecting');
                reconnectCountdown = Math.ceil(CONFIG.RECONNECT_DELAY / 1000);
                text.textContent = `Reconnecting in ${reconnectCountdown}s...`;
                btnConnect.disabled = true;
                btnDisconnect.disabled = false;
                
                reconnectTimer = setInterval(() => {
                    reconnectCountdown--;
                    if (reconnectCountdown > 0) {
                        text.textContent = `Reconnecting in ${reconnectCountdown}s...`;
                    } else {
                        text.textContent = 'Reconnecting...';
                        clearInterval(reconnectTimer);
                        reconnectTimer = null;
                    }
                }, 1000);
            } else {
                text.textContent = 'Disconnected';
                btnConnect.disabled = false;
                btnDisconnect.disabled = true;
                // FIX: Reset device status badge on disconnect
                $('#deviceStatusBadge').textContent = 'OFFLINE';
                $('#deviceStatusBadge').className = 'stat-badge offline';
                // B.2: Remove skeleton when disconnected
                setSkeletonLoading(false);
                // B.3: Show empty state when disconnected
                if (emptyState) emptyState.classList.add('show');
            }
            
            // Update Active Device Bars to reflect connection status
            updateActiveDeviceBars();
        }
        
        /* ============================================
           Phase 7: Internet Status Functions
           Phase 9.2: Bug Fix - Image Load Test
           ============================================ */
        
        // Internet Status indicator
        let internetCheckInterval = null;
        let lastKnownOnlineState = null;
        
        function initInternetStatus() {
            // Check Internet status through image loading
            checkInternetWithImage();
            
            // Listen for online/offline events (fast detection)
            window.addEventListener('online', () => {
                // When browser detects online, verify with image test
                checkInternetWithImage();
            });
            
            window.addEventListener('offline', () => {
                // When browser detects offline, update immediately
                handleInternetStateChange(false);
            });
            
            // Polling backup every 5 seconds (to detect reconnect)
            internetCheckInterval = setInterval(() => {
                checkInternetWithImage();
            }, 5000);
        }
        
        // Check Internet connection with image loading
        function checkInternetWithImage() {
            // If navigator.onLine is false, trust it and update immediately
            if (!navigator.onLine) {
                handleInternetStateChange(false);
                return;
            }
            
            // Load image from Google (reliable, fast)
            const img = new Image();
            const timeout = setTimeout(() => {
                img.onerror = null;
                img.onload = null;
                handleInternetStateChange(false);
            }, 3000); // timeout 3 seconds
            
            img.onload = () => {
                clearTimeout(timeout);
                handleInternetStateChange(true);
            };
            
            img.onerror = () => {
                clearTimeout(timeout);
                handleInternetStateChange(false);
            };
            
            // Use Google favicon + timestamp to prevent cache
            img.src = 'https://www.google.com/favicon.ico?_=' + Date.now();
        }
        
        // Handler for Internet status changes
        function handleInternetStateChange(online) {
            // Update UI
            updateInternetStatus(online ? 'online' : 'offline');
            
            // Show toast notification if status changed
            if (lastKnownOnlineState !== null && lastKnownOnlineState !== online) {
                if (online) {
                    showToast('success', 'Internet Restored', 'Connection is back online');
                    addLog('system', 'Internet connection restored');
                } else {
                    showToast('warning', 'No Internet', 'Internet connection lost');
                    addLog('system', 'Internet connection lost');
                }
            }
            
            // Save previous status
            lastKnownOnlineState = online;
            isOnline = online;
        }
        
        // Update UI for Internet Status
        function updateInternetStatus(status) {
            const icon = $('#internetIcon');
            const text = $('#internetStatusText');
            
            if (!icon || !text) return;
            
            // Use setAttribute for SVG element (className does not work on SVG)
            if (status === 'online') {
                icon.setAttribute('class', 'internet-icon online');
                text.textContent = 'Online';
            } else {
                icon.setAttribute('class', 'internet-icon offline');
                text.textContent = 'No Internet';
            }
        }
        
        /* ============================================
           Phase 7: Signal Bars Functions
           ============================================ */
        function updateSignalBars(rssi) {
            const signalBars = $('#signalBars');
            if (!signalBars) return;
            
            // Remove all signal classes
            signalBars.className = 'signal-bars';
            
            // RSSI thresholds:
            // Excellent: > -50 dBm
            // Good: -50 to -60 dBm
            // Fair: -60 to -70 dBm
            // Weak: -70 to -80 dBm
            // None: < -80 dBm or no signal
            
            if (rssi === null || rssi === undefined || rssi < -80) {
                signalBars.classList.add('none');
            } else if (rssi >= -50) {
                signalBars.classList.add('excellent');
            } else if (rssi >= -60) {
                signalBars.classList.add('good');
            } else if (rssi >= -70) {
                signalBars.classList.add('fair');
            } else {
                signalBars.classList.add('weak');
            }
        }
        
        function getSignalQuality(rssi) {
            if (rssi === null || rssi === undefined) return { label: 'N/A', class: '' };
            if (rssi >= -50) return { label: 'Excellent', class: 'excellent' };
            if (rssi >= -60) return { label: 'Good', class: 'good' };
            if (rssi >= -70) return { label: 'Fair', class: 'fair' };
            if (rssi >= -80) return { label: 'Weak', class: 'weak' };
            return { label: 'Very Weak', class: 'none' };
        }
        
        /* ============================================
           Phase 9: Control Center Functions
           ============================================ */
        // Update Mode Toggle visual
        function updateModeToggle(mode) {
            const toggle = $('#modeToggle');
            const labelAuto = $('#labelAuto');
            const labelCustom = $('#labelCustom');
            
            if (!toggle) return;
            
            if (mode === 'custom') {
                toggle.classList.add('custom');
                labelAuto.classList.remove('active');
                labelCustom.classList.add('active');
            } else {
                toggle.classList.remove('custom');
                labelAuto.classList.add('active');
                labelCustom.classList.remove('active');
            }
        }
        
        // Phase 9.3: Update Fan State Badge (pressurise/boost/purge)
        function updateFanStateBadge(state) {
            const badge = $('#fanStateBadge');
            if (!badge) return;
            
            const stateNormalized = state.toLowerCase();
            badge.textContent = state.toUpperCase();
            badge.className = 'stat-badge fan-state ' + stateNormalized;
        }
        
        // Update Speed Slider visual (percent 0-100)
        function updateSpeedSlider(percent) {
            const fill = $('#speedSliderFill');
            const knob = $('#speedSliderKnob');
            const value = $('#speedSliderValue');
            
            if (!fill || !knob || !value) return;
            
            const pct = Math.max(0, Math.min(100, percent));
            fill.style.width = pct + '%';
            knob.style.left = pct + '%';
            value.textContent = pct;
        }
        
        // Update Quick Actions button highlight
        function updateQuickActionsHighlight(mode, speedLevel) {
            // Clear all active states
            $$('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
            
            // Only highlight if in custom mode
            if (mode !== 'custom') return;
            
            // Highlight matching quick action
            const speedMapping = {
                0: 'qaOff',    // OFF
                1: 'qaSleep',  // Sleep
                2: 'qaEco',    // Eco
                5: 'qaTurbo'   // Turbo
            };
            
            const btnId = speedMapping[speedLevel];
            if (btnId) {
                const btn = $('#' + btnId);
                if (btn) btn.classList.add('active');
            }
        }
        
        // Quick Action click handler
        function handleQuickAction(mode, speed) {
            sendMode(mode);
            if (mode === 'custom') {
                setTimeout(() => sendSpeed(speed), 100);
            }
            showToast('info', 'Quick Action', `Setting ${mode} mode, speed ${speed}`);
        }
        
        // Message Handling
        function handleMessage(topic, message) {
            try {
                const payload = JSON.parse(message.toString());
                const topics = getTopics();
                
                // Phase 11.3: Handle wildcard messages for Monitor tab
                // Check if this is a fan/status message from any device
                if (topic.match(/\/be-tpp\/[^/]+\/fan\/status/)) {
                    handleMonitorMessage(topic, payload);
                }
                
                // Phase 11.3: Handle wildcard sensor messages for Monitor tab (Temp/Humidity)
                // Note: sensors topic is /be-tpp/{serial}/sensors (not /fan/sensors)
                if (topic.match(/\/be-tpp\/[^/]+\/sensors/)) {
                    handleMonitorMessage(topic, payload);
                }
                
                if (topic === topics.status) {
                    updateDeviceStatus(payload);
                    addLog('status', JSON.stringify(payload));
                } else if (topic === topics.sensors) {
                    // FIX: Extract sensor data from payload.sensors[0] array
                    if (payload.sensors && Array.isArray(payload.sensors) && payload.sensors.length > 0) {
                        updateSensors(payload.sensors[0]);
                    } else {
                        // Fallback: try using payload directly
                        updateSensors(payload);
                    }
                    addLog('sensors', JSON.stringify(payload));
                } else if (topic === topics.diag) {
                    // Phase 9.4: Handle diagnostic responses
                    handleDiagResponse(payload);
                    addLog('diag', JSON.stringify(payload));
                }
            } catch (err) {
                addLog('error', 'Parse error: ' + err.message);
            }
        }
        
        function updateDeviceStatus(status) {
            // Phase 11.1: Auto-detect device from status
            autoDetectDevice(status);
            
            $('#deviceStatusBadge').textContent = 'ONLINE';
            $('#deviceStatusBadge').className = 'stat-badge online';
            
            // FIX: Support both snake_case (ESP32) and camelCase
            const fanSpeed = status.fan_speed ?? status.fanSpeedPercent;
            const fanMode = status.fan_mode ?? status.mode;
            const fanState = status.fan_state ?? status.fanState;  // Phase 9.3: fan state
            const currentSpeed = status.current_speed ?? status.currentSpeed;
            const rssi = status.rssi;
            const uptime = status.uptime;
            const serial = status.serial ?? status.qpSerial;
            const clientId = status.client_id ?? status.clientId;
            const firmware = status.fw_ver ?? status.firmware_version ?? status.firmwareVersion;
            const espTemp = status.esp_temp ?? status.esp_temperature ?? status.espTemperature;
            const heap = status.heap ?? status.freeHeap;
            const speedMap = status.speed_map ?? status.speedMap;
            const steadyLevels = status.steady_levels ?? status.steadyLevels;
            const steadyIndex = status.steady_index ?? status.steadyIndex;
            const emaAlpha = status.ema_alpha ?? status.emaAlpha;
            // Phase 9.3: EMA values and sensor age from firmware
            const pm25Ema = status.pm25_ema ?? status.pm25Ema;
            const co2Ema = status.co2_ema ?? status.co2Ema;
            const lastSensorAgeMs = status.last_sensor_age_ms ?? status.lastSensorAgeMs;
            
            if (fanSpeed !== undefined) {
                $('#fanSpeedValue').textContent = fanSpeed;
                lastFanSpeed = fanSpeed;
                updateFanChart(fanSpeed);  // Phase 6.1: Update fan chart from /fan/status
            }
            
            // Calculate current speed level from fan_speed percentage if not provided
            let speedLevel = currentSpeed;
            if (speedLevel === undefined && fanSpeed !== undefined && speedMap) {
                speedLevel = speedMap.findIndex(s => s === fanSpeed);
                if (speedLevel === -1) speedLevel = undefined;
            }
            
            if (speedLevel !== undefined) {
                $('#currentSpeedBadge').textContent = `LV ${speedLevel}`;
                $$('.speed-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.speed) === speedLevel);
                });
            }
            
            if (fanMode !== undefined) {
                const modeDisplay = fanMode === 'automatic' ? 'AUTO' : 'CUSTOM';
                $('#fanModeValue').textContent = modeDisplay;
                $('#fanModeBadge').textContent = modeDisplay;
                $('#fanModeBadge').className = `stat-badge ${fanMode === 'automatic' ? 'auto' : 'custom'}`;
                $('#currentModeBadge').textContent = modeDisplay;
                $('#currentModeBadge').className = `stat-badge ${fanMode === 'automatic' ? 'auto' : 'custom'}`;
                // Phase 9: Update Mode Toggle
                updateModeToggle(fanMode);
            }
            
            // Phase 9.3: Update Fan State Badge
            if (fanState) {
                updateFanStateBadge(fanState);
            }
            
            // Phase 9: Update Speed Slider
            if (fanSpeed !== undefined) {
                updateSpeedSlider(fanSpeed);
            }
            
            // Phase 9: Update Quick Actions highlight
            if (fanMode !== undefined && speedLevel !== undefined) {
                updateQuickActionsHighlight(fanMode, speedLevel);
            }
            
            if (rssi !== undefined) { 
                $('#rssiValue').textContent = rssi; 
                updateSignalBars(rssi);  // Phase 7: Update signal bars
            }
            if (uptime !== undefined) { $('#uptimeValue').textContent = formatUptime(uptime); }
            if (serial) { $('#infoSerial').textContent = serial; }
            if (clientId) { $('#infoClientId').textContent = clientId; }
            if (firmware) { $('#infoFirmware').textContent = firmware; }
            if (espTemp !== undefined) { 
                $('#infoEspTemp').textContent = espTemp.toFixed(1) + String.fromCharCode(176) + 'C';
                // Phase 6.2: Add min/max to new grid lines display
                checkEspTempWarning(espTemp);
            }
            // Phase 9.3: Heap with color coding
            if (heap !== undefined) { 
                const heapKB = heap / 1024;
                $('#infoHeap').textContent = heapKB.toFixed(1) + ' KB';
                updateHeapColor(heapKB);
            }
            if (speedMap) { $('#infoSpeedMap').textContent = speedMap.join(', '); }
            if (steadyLevels) { $('#infoSteadyLevels').textContent = steadyLevels.join(', '); }
            if (steadyIndex !== undefined) { $('#infoSteadyIndex').textContent = steadyIndex; }
            if (emaAlpha !== undefined) { $('#infoEmaAlpha').textContent = emaAlpha; }
            
            // Phase 9.3: EMA values from firmware
            // Phase 9.3: EMA values from firmware (UI + save for charts)
            if (pm25Ema !== undefined) { 
                $('#pm25Ema').textContent = 'EMA: ' + pm25Ema.toFixed(1);
                lastFirmwarePm25Ema = pm25Ema;  // Save for charts
            }
            if (co2Ema !== undefined) { 
                $('#co2Ema').textContent = 'EMA: ' + Math.round(co2Ema);
                lastFirmwareCo2Ema = co2Ema;  // Save for charts
            }
            
            // Phase 9.3: Sensor Age from firmware
            if (lastSensorAgeMs !== undefined) { updateSensorAge(lastSensorAgeMs); }
            
            // Phase 10.5: Populate Config tab fields from status
            populateConfigFromStatus(status);
            
            $('#infoLastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        // Phase 6.2: Add min/max to new grid lines display
        function checkEspTempWarning(temp) {
            const infoEspTemp = $('#infoEspTemp');
            const parentRow = infoEspTemp.closest('.data-item');
            
            // Reset classes
            if (parentRow) {
                parentRow.classList.remove('esp-temp-warn', 'esp-temp-danger', 'esp-temp-critical');
            }
            
            if (temp >= CONFIG.ESP_TEMP_CRITICAL) {
                // Critical: > 80C
                if (parentRow) parentRow.classList.add('esp-temp-critical');
                if (lastEspTemp === null || lastEspTemp < CONFIG.ESP_TEMP_CRITICAL) {
                    showToast('error', 'ESP Temperature Critical!', `Current: ${temp.toFixed(1)}${String.fromCharCode(176)}C - Device may restart!`);
                }
            } else if (temp >= CONFIG.ESP_TEMP_DANGER) {
                // Danger: 65-80C
                if (parentRow) parentRow.classList.add('esp-temp-danger');
                if (lastEspTemp === null || lastEspTemp < CONFIG.ESP_TEMP_DANGER) {
                    showToast('warning', 'ESP Temperature High!', `Current: ${temp.toFixed(1)}${String.fromCharCode(176)}C - Check ventilation`);
                }
            } else if (temp >= CONFIG.ESP_TEMP_WARN) {
                // Warn: 50-65C
                if (parentRow) parentRow.classList.add('esp-temp-warn');
            }
            
            lastEspTemp = temp;
        }
        
        // Phase 9.3: Heap color coding
        function updateHeapColor(heapKB) {
            const heapEl = $('#infoHeap');
            if (!heapEl) return;
            
            heapEl.classList.remove('heap-good', 'heap-warning', 'heap-danger');
            
            if (heapKB >= 100) {
                heapEl.classList.add('heap-good');
            } else if (heapKB >= 50) {
                heapEl.classList.add('heap-warning');
            } else {
                heapEl.classList.add('heap-danger');
            }
        }
        
        // Phase 9.3: Sensor Age display with firmware data
        let lastFirmwareSensorAge = null;  // Sensor age from firmware
        let lastStatusReceiveTime = null;  // Dashboard receive time
        
        function updateSensorAge(firmwareAgeMs) {
            const badge = $('#sensorAgeBadge');
            const ageText = $('#sensorAgeText');
            const ageStatus = $('#sensorAgeStatus');
            
            if (!badge || !ageText || !ageStatus) return;
            
            // Save values for tooltip
            lastFirmwareSensorAge = firmwareAgeMs;
            lastStatusReceiveTime = Date.now();
            
            // Show data from firmware
            const ageSec = firmwareAgeMs / 1000;
            ageText.textContent = ageSec.toFixed(1) + 's';
            
            // Calculate status receive time
            badge.classList.remove('fresh', 'aging', 'stale', 'failsafe');
            
            if (ageSec < 30) {
                badge.classList.add('fresh');
                ageStatus.textContent = 'FRESH';
            } else if (ageSec < 60) {
                badge.classList.add('aging');
                ageStatus.textContent = 'AGING';
            } else if (ageSec < 90) {
                badge.classList.add('stale');
                ageStatus.textContent = 'STALE';
            } else {
                badge.classList.add('failsafe');
                ageStatus.textContent = 'FAILSAFE';
            }
            
            // Update tooltip values
            updateSensorAgeTooltip();
        }
        
        function updateSensorAgeTooltip() {
            if (lastFirmwareSensorAge === null) return;
            
            const sensorAgeSec = lastFirmwareSensorAge / 1000;
            const dashboardAgeSec = lastStatusReceiveTime ? (Date.now() - lastStatusReceiveTime) / 1000 : 0;
            const totalLag = sensorAgeSec + dashboardAgeSec;
            
            $('#tooltipSensorAge').textContent = sensorAgeSec.toFixed(1) + 's';
            $('#tooltipDashboardAge').textContent = dashboardAgeSec.toFixed(1) + 's';
            $('#tooltipTotalLag').textContent = totalLag.toFixed(1) + 's';
        }
        
        function formatUptime(seconds) {
            const d = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (d > 0) return `${d}d ${h}h`;
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }
        
        function updateSensors(sensors) {
            lastSensorTime = Date.now();
            $('#dataStatusDot').className = 'status-dot online';
            $('#dataStatusText').textContent = 'Receiving';
            $('#sensorTimestamp').textContent = new Date().toLocaleTimeString();
            $('#sensorStatusBadge').textContent = 'LIVE';
            $('#sensorStatusBadge').className = 'stat-badge online';
            $('#sensorAgeValue').textContent = '0s';
            
            if (sensors.pm25 !== undefined && sensors.pm25 !== null) {
                const pm25 = parseFloat(sensors.pm25);
                $('#pm25Value').textContent = pm25.toFixed(1);
                const pm25Q = getPM25Quality(pm25);
                $('#pm25Quality').textContent = pm25Q.label;
                $('#pm25Quality').className = 'quality-badge ' + pm25Q.class;
                $('#cardPm25').className = 'card stat-card sensor-card ' + pm25Q.class;
                const pm25Bar = $('#pm25Bar');
                pm25Bar.style.width = Math.min(pm25 / 50 * 100, 100) + '%';
                pm25Bar.className = 'sensor-bar-fill ' + pm25Q.class;
            }
            
            if (sensors.co2 !== undefined && sensors.co2 !== null) {
                const co2 = parseInt(sensors.co2);
                $('#co2Value').textContent = co2;
                const co2Q = getCO2Quality(co2);
                $('#co2Quality').textContent = co2Q.label;
                $('#co2Quality').className = 'quality-badge ' + co2Q.class;
                $('#cardCo2').className = 'card stat-card sensor-card ' + co2Q.class;
                const co2Bar = $('#co2Bar');
                co2Bar.style.width = Math.min((co2 - 400) / 1600 * 100, 100) + '%';
                co2Bar.className = 'sensor-bar-fill ' + co2Q.class;
            }
            
            if (sensors.temperature !== undefined && sensors.temperature !== null) {
                const temp = parseFloat(sensors.temperature);
                $('#tempValue').textContent = temp.toFixed(1);
                const tempQ = getTempComfort(temp);
                $('#tempQuality').textContent = tempQ.label;
                $('#tempQuality').className = 'quality-badge ' + tempQ.class;
                $('#cardTemp').className = 'card stat-card sensor-card ' + tempQ.class;
            }
            
            if (sensors.humidity !== undefined && sensors.humidity !== null) {
                const hum = parseFloat(sensors.humidity);
                $('#humidityValue').textContent = hum.toFixed(0);
                const humQ = getHumidityComfort(hum);
                $('#humidityQuality').textContent = humQ.label;
                $('#humidityQuality').className = 'quality-badge ' + humQ.class;
                $('#cardHumidity').className = 'card stat-card sensor-card ' + humQ.class;
            }
            
            if (sensors.pm10 !== undefined && sensors.pm10 !== null) {
                const pm10 = parseFloat(sensors.pm10);
                $('#pm10Value').textContent = pm10.toFixed(1);
                const pm10Q = getPM10Quality(pm10);
                $('#pm10Quality').textContent = pm10Q.label;
                $('#pm10Quality').className = 'quality-badge ' + pm10Q.class;
                $('#cardPm10').className = 'card stat-card sensor-card ' + pm10Q.class;
                const pm10Bar = $('#pm10Bar');
                pm10Bar.style.width = Math.min(pm10 / 200 * 100, 100) + '%';
                pm10Bar.className = 'sensor-bar-fill ' + pm10Q.class;
            }
            
            if (sensors.tvoc_index !== undefined && sensors.tvoc_index !== null) {
                const tvoc = parseInt(sensors.tvoc_index);
                $('#tvocValue').textContent = tvoc;
                const tvocQ = getTVOCQuality(tvoc);
                $('#tvocQuality').textContent = tvocQ.label;
                $('#tvocQuality').className = 'quality-badge ' + tvocQ.class;
                $('#cardTvoc').className = 'card stat-card sensor-card ' + tvocQ.class;
                const tvocBar = $('#tvocBar');
                tvocBar.style.width = Math.min(tvoc / 300 * 100, 100) + '%';
                tvocBar.className = 'sensor-bar-fill ' + tvocQ.class;
            }
            
            if (sensors.noise !== undefined && sensors.noise !== null) {
                $('#noiseValue').textContent = parseInt(sensors.noise);
            }
            
            updateSensorCharts(sensors);
            
            // Phase 11.3: Update monitor data with sensor values for active device
            const activeQp = $('#qpSerial').value;
            if (activeQp && monitorDeviceData[activeQp]) {
                if (sensors.temperature !== undefined) monitorDeviceData[activeQp].temp = parseFloat(sensors.temperature);
                if (sensors.humidity !== undefined) monitorDeviceData[activeQp].humidity = parseFloat(sensors.humidity);
            }
        }
        
        // Air Quality Helper Functions
        function getPM25Quality(value) {
            if (value <= 12) return { label: 'GOOD', class: 'good' };
            if (value <= 35) return { label: 'MOD', class: 'moderate' };
            return { label: 'BAD', class: 'unhealthy' };
        }
        
        function getCO2Quality(value) {
            if (value <= 800) return { label: 'GOOD', class: 'good' };
            if (value <= 1000) return { label: 'MOD', class: 'moderate' };
            return { label: 'HIGH', class: 'unhealthy' };
        }
        
        function getPM10Quality(value) {
            if (value <= 54) return { label: 'GOOD', class: 'good' };
            if (value <= 154) return { label: 'MOD', class: 'moderate' };
            return { label: 'BAD', class: 'unhealthy' };
        }
        
        function getTVOCQuality(value) {
            if (value <= 100) return { label: 'GOOD', class: 'good' };
            if (value <= 200) return { label: 'MOD', class: 'moderate' };
            return { label: 'HIGH', class: 'unhealthy' };
        }
        
        function getTempComfort(value) {
            if (value >= 20 && value <= 26) return { label: 'COMFY', class: 'good' };
            if (value >= 18 && value <= 28) return { label: 'OK', class: 'moderate' };
            return { label: value < 18 ? 'COLD' : 'HOT', class: 'unhealthy' };
        }
        
        function getHumidityComfort(value) {
            if (value >= 40 && value <= 60) return { label: 'IDEAL', class: 'good' };
            if (value >= 30 && value <= 70) return { label: 'OK', class: 'moderate' };
            return { label: value < 30 ? 'DRY' : 'HUMID', class: 'unhealthy' };
        }
        
        /* ============================================
           CHART FUNCTIONS
           ============================================ */
        function initCharts() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#A0A0B0' : '#4A4A5A';
            const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
            const bgColor = isDark ? '#1A1A25' : '#FFFFFF';
            
            const pm25Color = '#00C8FF';
            const co2Color = '#64DC64';
            const tempColor = '#FF9632';
            const humColor = '#3296FF';
            
            const commonOpts = {
                grid: { top: 10, right: 10, bottom: 25, left: 45 },
                tooltip: { 
                    trigger: 'axis', 
                    backgroundColor: bgColor, 
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    textStyle: { color: textColor, fontSize: 12 },
                    axisPointer: { type: 'cross', crossStyle: { color: textColor } }
                },
                xAxis: { type: 'category', data: [], boundaryGap: false, axisLine: { lineStyle: { color: gridColor } }, axisLabel: { color: textColor, fontSize: 10 }, splitLine: { show: false } },
                yAxis: { type: 'value', axisLine: { show: false }, axisLabel: { color: textColor, fontSize: 10 }, splitLine: { lineStyle: { color: gridColor } } }
            };
            
            chartPm25 = echarts.init($('#chartPm25'));
            const pm25EmaColor = '#FF6B9D';  // Color for EMA line
            chartPm25.setOption({
                ...commonOpts,
                grid: { top: 25, right: 10, bottom: 25, left: 45 },
                legend: {
                    data: [
                        { name: 'PM2.5', icon: 'circle', itemStyle: { color: pm25Color } },
                        { name: 'EMA', icon: 'circle', itemStyle: { color: pm25EmaColor } }
                    ],
                    textStyle: { color: textColor, fontSize: 10 },
                    top: 0,
                    right: 0
                },
                tooltip: {
                    ...commonOpts.tooltip,
                    formatter: function(params) {
                        let html = `<div style="font-weight:600;margin-bottom:4px">${params[0].axisValue}</div>`;
                        params.forEach(p => {
                            const color = p.seriesName === 'PM2.5' ? pm25Color : pm25EmaColor;
                            const val = p.value !== null && p.value !== undefined ? Number(p.value).toFixed(1) : '--';
                            html += `<div style="display:flex;align-items:center;gap:8px">
                                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color}"></span>
                                        <span>${p.seriesName}: <b>${val}</b> ug/m\u00B3</span>
                                     </div>`;
                        });
                        return html;
                    }
                },
                // Phase 6.2: Add min/max to new grid lines display
                yAxis: { 
                    ...commonOpts.yAxis, 
                    name: 'ug/m\u00B3', 
                    nameTextStyle: { color: textColor, fontSize: 10 },
                    min: 0,
                    max: 100,
                    splitNumber: 5
                },
                // Phase 6.2: Add min/max to new grid lines display
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'Waiting for data...',
                        fontSize: 14,
                        fontFamily: 'JetBrains Mono, monospace',
                        fill: textColor,
                        opacity: 0.5
                    },
                    z: 100
                },
                series: [
                    {
                        name: 'PM2.5',
                        type: 'line',
                        smooth: true,
                        symbol: 'none',
                        data: [],
                        lineStyle: { color: pm25Color, width: 2 },
                        areaStyle: { color: { type: 'linear', x: 0, y: 0, x2: 0, y2: 1, colorStops: [{ offset: 0, color: 'rgba(0,200,255,0.3)' }, { offset: 1, color: 'rgba(0,200,255,0.05)' }] } }
                    },
                    {
                        name: 'EMA',
                        type: 'line',
                        smooth: true,
                        symbol: 'none',
                        data: [],
                        lineStyle: { color: pm25EmaColor, width: 2, type: 'dashed' }
                    }
                ]
            });
            
            chartCo2 = echarts.init($('#chartCo2'));
            const co2EmaColor = '#FFB347';  // Color for EMA line
            chartCo2.setOption({
                ...commonOpts,
                grid: { top: 25, right: 10, bottom: 25, left: 50 },
                legend: {
                    data: [
                        { name: 'CO2', icon: 'circle', itemStyle: { color: co2Color } },
                        { name: 'EMA', icon: 'circle', itemStyle: { color: co2EmaColor } }
                    ],
                    textStyle: { color: textColor, fontSize: 10 },
                    top: 0,
                    right: 0
                },
                tooltip: {
                    ...commonOpts.tooltip,
                    formatter: function(params) {
                        let html = `<div style="font-weight:600;margin-bottom:4px">${params[0].axisValue}</div>`;
                        params.forEach(p => {
                            const color = p.seriesName === 'CO2' ? co2Color : co2EmaColor;
                            const val = p.value !== null && p.value !== undefined ? Math.round(Number(p.value)) : '--';
                            html += `<div style="display:flex;align-items:center;gap:8px">
                                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color}"></span>
                                        <span>${p.seriesName}: <b>${val}</b> ppm</span>
                                     </div>`;
                        });
                        return html;
                    }
                },
                // Phase 6.2: Add min/max to new grid lines display
                yAxis: { 
                    ...commonOpts.yAxis, 
                    name: 'ppm', 
                    nameTextStyle: { color: textColor, fontSize: 10 }, 
                    min: 400,
                    max: 2000,
                    splitNumber: 4
                },
                // Phase 6.2: Add min/max to new grid lines display
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'Waiting for data...',
                        fontSize: 14,
                        fontFamily: 'JetBrains Mono, monospace',
                        fill: textColor,
                        opacity: 0.5
                    },
                    z: 100
                },
                series: [
                    {
                        name: 'CO2',
                        type: 'line',
                        smooth: true,
                        symbol: 'none',
                        data: [],
                        lineStyle: { color: co2Color, width: 2 },
                        areaStyle: { color: { type: 'linear', x: 0, y: 0, x2: 0, y2: 1, colorStops: [{ offset: 0, color: 'rgba(100,220,100,0.3)' }, { offset: 1, color: 'rgba(100,220,100,0.05)' }] } }
                    },
                    {
                        name: 'EMA',
                        type: 'line',
                        smooth: true,
                        symbol: 'none',
                        data: [],
                        lineStyle: { color: co2EmaColor, width: 2, type: 'dashed' }
                    }
                ]
            });
            
            chartTempHum = echarts.init($('#chartTempHum'));
            chartTempHum.setOption({
                ...commonOpts,
                legend: { 
                    data: [
                        { name: 'Temperature', icon: 'circle', itemStyle: { color: tempColor } },
                        { name: 'Humidity', icon: 'circle', itemStyle: { color: humColor } }
                    ], 
                    textStyle: { color: textColor, fontSize: 10 }, 
                    top: 0, 
                    right: 0 
                },
                tooltip: {
                    ...commonOpts.tooltip,
                    formatter: function(params) {
                        let html = `<div style="font-weight:600;margin-bottom:4px">${params[0].axisValue}</div>`;
                        params.forEach(p => {
                            const color = p.seriesName === 'Temperature' ? tempColor : humColor;
                            const unit = p.seriesName === 'Temperature' ? '\u00B0C' : '%';
                            const val = p.value !== null && p.value !== undefined ? Number(p.value).toFixed(1) : '--';
                            html += `<div style="display:flex;align-items:center;gap:8px">
                                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color}"></span>
                                        <span>${p.seriesName}: <b>${val}</b> ${unit}</span>
                                     </div>`;
                        });
                        return html;
                    }
                },
                grid: { top: 25, right: 45, bottom: 25, left: 45 },
                // Phase 6.2: Add min/max to new grid lines display
                yAxis: [
                    { type: 'value', name: String.fromCharCode(176) + 'C', nameTextStyle: { color: tempColor, fontSize: 10 }, axisLine: { show: false }, axisLabel: { color: tempColor, fontSize: 10 }, splitLine: { lineStyle: { color: gridColor } }, min: 15, max: 40, splitNumber: 5 },
                    { type: 'value', name: '%', nameTextStyle: { color: humColor, fontSize: 10 }, axisLine: { show: false }, axisLabel: { color: humColor, fontSize: 10 }, splitLine: { show: false }, position: 'right', min: 20, max: 100, splitNumber: 4 }
                ],
                // Phase 6.2: Add min/max to new grid lines display
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'Waiting for data...',
                        fontSize: 14,
                        fontFamily: 'JetBrains Mono, monospace',
                        fill: textColor,
                        opacity: 0.5
                    },
                    z: 100
                },
                series: [
                    { name: 'Temperature', type: 'line', smooth: true, symbol: 'none', data: [], lineStyle: { color: tempColor, width: 2 } },
                    { name: 'Humidity', type: 'line', smooth: true, symbol: 'none', data: [], yAxisIndex: 1, lineStyle: { color: humColor, width: 2 } }
                ]
            });
            
            // Phase 6: Fan Speed Chart
            const fanSpeedColor = '#B026FF';  // Neon purple color
            chartFanSpeed = echarts.init($('#chartFanSpeed'));
            chartFanSpeed.setOption({
                ...commonOpts,
                grid: { top: 10, right: 10, bottom: 25, left: 45 },
                tooltip: {
                    ...commonOpts.tooltip,
                    formatter: function(params) {
                        const p = params[0];
                        const val = p.value !== null && p.value !== undefined ? Math.round(Number(p.value)) : '--';
                        return `<div style="font-weight:600;margin-bottom:4px">${p.axisValue}</div>
                                <div style="display:flex;align-items:center;gap:8px">
                                    <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${fanSpeedColor}"></span>
                                    <span>Fan Speed: <b>${val}</b>%</span>
                                </div>`;
                    }
                },
                // Phase 6.2: Add min/max to new grid lines display
                yAxis: { ...commonOpts.yAxis, name: '%', nameTextStyle: { color: textColor, fontSize: 10 }, min: 0, max: 100, splitNumber: 5 },
                // Phase 6.2: Add min/max to new grid lines display
                graphic: {
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: 'Waiting for data...',
                        fontSize: 14,
                        fontFamily: 'JetBrains Mono, monospace',
                        fill: textColor,
                        opacity: 0.5
                    },
                    z: 100
                },
                series: [{
                    name: 'Fan Speed',
                    type: 'line',
                    smooth: true,
                    symbol: 'none',
                    data: [],
                    lineStyle: { color: fanSpeedColor, width: 2 },
                    areaStyle: { color: { type: 'linear', x: 0, y: 0, x2: 0, y2: 1, colorStops: [{ offset: 0, color: 'rgba(176,38,255,0.3)' }, { offset: 1, color: 'rgba(176,38,255,0.05)' }] } }
                }]
            });
            
            const resizeCharts = () => {
                if (resizeTimeout) clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (chartPm25) chartPm25.resize();
                    if (chartCo2) chartCo2.resize();
                    if (chartTempHum) chartTempHum.resize();
                    if (chartFanSpeed) chartFanSpeed.resize();
                }, 100);
            };
            
            window.addEventListener('resize', resizeCharts);
            
            const chartContainers = [$('#chartPm25'), $('#chartCo2'), $('#chartTempHum'), $('#chartFanSpeed')];
            const resizeObserver = new ResizeObserver(() => resizeCharts());
            chartContainers.forEach(container => {
                if (container) resizeObserver.observe(container);
            });
            
            const mainContent = $('.main');
            if (mainContent) resizeObserver.observe(mainContent);
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) setTimeout(resizeCharts, 100);
            });
            
            window.resizeAllCharts = resizeCharts;
        }
        
        // Phase 6.1: updateSensorCharts() for /sensors message
        function updateSensorCharts(sensors) {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // Push raw data to sensor charts
            chartDataSensors.time.push(time);
            chartDataSensors.pm25.push(sensors.pm25 ?? null);
            chartDataSensors.co2.push(sensors.co2 ?? null);
            chartDataSensors.temp.push(sensors.temperature ?? null);
            chartDataSensors.humidity.push(sensors.humidity ?? null);
            
            // Phase 9.3: Use EMA from firmware (if available) instead of calculating
            // Fallback: Calculate if firmware does not provide EMA
            const alpha = CONFIG.EMA_ALPHA;
            const calcEma = (dataArray, emaArray, newValue) => {
                if (newValue === null || newValue === undefined) {
                    return emaArray.length > 0 ? emaArray[emaArray.length - 1] : null;
                }
                if (emaArray.length === 0 || emaArray[emaArray.length - 1] === null) {
                    return newValue;
                }
                return alpha * newValue + (1 - alpha) * emaArray[emaArray.length - 1];
            };
            
            // Use EMA from firmware if available, otherwise calculate
            const pm25EmaValue = lastFirmwarePm25Ema !== null 
                ? lastFirmwarePm25Ema 
                : calcEma(chartDataSensors.pm25, chartDataSensors.pm25Ema, sensors.pm25);
            const co2EmaValue = lastFirmwareCo2Ema !== null 
                ? lastFirmwareCo2Ema 
                : calcEma(chartDataSensors.co2, chartDataSensors.co2Ema, sensors.co2);
            
            chartDataSensors.pm25Ema.push(pm25EmaValue);
            chartDataSensors.co2Ema.push(co2EmaValue);
            
            // Trim data to max points
            const maxPoints = CONFIG.MAX_SENSOR_POINTS;
            if (chartDataSensors.time.length > maxPoints) {
                chartDataSensors.time.shift();
                chartDataSensors.pm25.shift();
                chartDataSensors.co2.shift();
                chartDataSensors.temp.shift();
                chartDataSensors.humidity.shift();
                chartDataSensors.pm25Ema.shift();
                chartDataSensors.co2Ema.shift();
            }
            
            // Update sensor charts + hide "Waiting for data..." graphic
            chartPm25.setOption({ 
                xAxis: { data: chartDataSensors.time }, 
                series: [{ data: chartDataSensors.pm25 }, { data: chartDataSensors.pm25Ema }],
                graphic: { invisible: true }
            });
            chartCo2.setOption({ 
                xAxis: { data: chartDataSensors.time }, 
                series: [{ data: chartDataSensors.co2 }, { data: chartDataSensors.co2Ema }],
                graphic: { invisible: true }
            });
            chartTempHum.setOption({ 
                xAxis: { data: chartDataSensors.time }, 
                series: [{ data: chartDataSensors.temp }, { data: chartDataSensors.humidity }],
                graphic: { invisible: true }
            });
            
            // Update badges
            if (sensors.pm25 !== undefined) $('#pm25ChartBadge').textContent = sensors.pm25.toFixed(1);
            if (sensors.co2 !== undefined) $('#co2ChartBadge').textContent = Math.round(sensors.co2);
            // Phase 8: format pts/max
            $('#sensorDataPoints').textContent = `Sensors: ${chartDataSensors.time.length}/${CONFIG.MAX_SENSOR_POINTS}`;
        }
        
        // Phase 6.1: updateFanChart() for /fan/status message
        function updateFanChart(fanSpeed) {
            if (fanSpeed === null || fanSpeed === undefined) return;
            
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // Push data to fan chart
            chartDataFan.time.push(time);
            chartDataFan.fanSpeed.push(fanSpeed);
            
            // Trim data to max points
            const maxPoints = CONFIG.MAX_FAN_POINTS;
            if (chartDataFan.time.length > maxPoints) {
                chartDataFan.time.shift();
                chartDataFan.fanSpeed.shift();
            }
            
            // Update fan speed chart + hide "Waiting for data..." graphic
            chartFanSpeed.setOption({ 
                xAxis: { data: chartDataFan.time }, 
                series: [{ data: chartDataFan.fanSpeed }],
                graphic: { invisible: true }
            });
            
            // Update badge + pts counter
            $('#fanSpeedChartBadge').textContent = fanSpeed + '%';
            // Phase 8: format pts/max
            $('#fanDataPoints').textContent = `Fan: ${chartDataFan.time.length}/${CONFIG.MAX_FAN_POINTS}`;
        }
        
        function updateChartsTheme() {
            if (chartPm25) chartPm25.dispose();
            if (chartCo2) chartCo2.dispose();
            if (chartTempHum) chartTempHum.dispose();
            if (chartFanSpeed) chartFanSpeed.dispose();
            
            initCharts();
            
            // Restore sensor charts data + hide NO DATA if has data
            if (chartDataSensors.time.length > 0) {
                chartPm25.setOption({ 
                    xAxis: { data: chartDataSensors.time }, 
                    series: [{ data: chartDataSensors.pm25 }, { data: chartDataSensors.pm25Ema }],
                    graphic: { invisible: true }
                });
                chartCo2.setOption({ 
                    xAxis: { data: chartDataSensors.time }, 
                    series: [{ data: chartDataSensors.co2 }, { data: chartDataSensors.co2Ema }],
                    graphic: { invisible: true }
                });
                chartTempHum.setOption({ 
                    xAxis: { data: chartDataSensors.time }, 
                    series: [{ data: chartDataSensors.temp }, { data: chartDataSensors.humidity }],
                    graphic: { invisible: true }
                });
            }
            
            // Restore fan chart data + hide NO DATA if has data
            if (chartDataFan.time.length > 0) {
                chartFanSpeed.setOption({ 
                    xAxis: { data: chartDataFan.time }, 
                    series: [{ data: chartDataFan.fanSpeed }],
                    graphic: { invisible: true }
                });
            }
        }
        
        // Commands
        function sendMode(mode) {
            if (!mqttClient || !mqttClient.connected) { 
                showToast('warning', 'Not Connected', 'Please connect to MQTT first'); 
                return; 
            }
            const topic = getTopics().mode;
            mqttClient.publish(topic, mode);
            addLog('command', 'Mode -> ' + mode);
            showToast('info', 'Command Sent', `Mode set to ${mode}`);
        }
        
        function sendSpeed(speed) {
            if (!mqttClient || !mqttClient.connected) { 
                showToast('warning', 'Not Connected', 'Please connect to MQTT first'); 
                return; 
            }
            const topic = getTopics().speed;
            mqttClient.publish(topic, String(speed));
            addLog('command', 'Speed -> ' + speed);
            showToast('info', 'Command Sent', `Speed set to ${speed}`);
        }
        
        function sendReboot() {
            if (!mqttClient || !mqttClient.connected) { 
                showToast('warning', 'Not Connected', 'Please connect to MQTT first'); 
                return; 
            }
            
            // Double-click prevention
            lockButton('#btnReboot');
            
            const topic = getTopics().config;
            mqttClient.publish(topic, JSON.stringify({ cmd: 'reboot' }));
            addLog('command', 'Reboot command sent');
            showToast('warning', 'Reboot', 'Device reboot command sent');
        }
        
        /* ============================================
           Phase 9.4: Diagnostic Panel Functions
           ============================================ */
        
        // Diagnostic state
        let diagPendingCommand = null;
        let diagPingStartTime = 0;
        let diagTimeout = null;
        let diagConfigData = null;
        const DIAG_TIMEOUT_MS = 5000;
        
        // Send diagnostic command
        function sendDiagCommand(cmd) {
            if (!mqttClient || !mqttClient.connected) { 
                showToast('warning', 'Not Connected', 'Please connect to MQTT first'); 
                return false; 
            }
            
            const topic = getTopics().diagCmd;
            mqttClient.publish(topic, JSON.stringify({ cmd: cmd }));
            addLog('command', `Diag command: ${cmd}`);
            
            // Set pending command for response handling
            diagPendingCommand = cmd;
            
            // Start timeout
            clearTimeout(diagTimeout);
            diagTimeout = setTimeout(() => {
                if (diagPendingCommand) {
                    diagPendingCommand = null;
                    showToast('error', 'Timeout', 'No response from device');
                    $('#diagLastPing').textContent = 'Timeout';
                    $('#diagLastPing').className = 'diag-result-value error';
                }
            }, DIAG_TIMEOUT_MS);
            
            return true;
        }
        
        // Ping command
        function sendDiagPing() {
            lockButton('#btnDiagPing');
            diagPingStartTime = Date.now();
            $('#diagLastPing').textContent = 'Pinging...';
            $('#diagLastPing').className = 'diag-result-value pending';
            sendDiagCommand('ping');
        }
        
        // Get Status command
        function sendDiagStatus() {
            lockButton('#btnDiagStatus');
            $('#diagModalTitle').textContent = 'Diagnostic Status';
            $('#diagJsonContent').textContent = 'Waiting for response...';
            $('#applyConfigFromDiag').style.display = 'none';
            $('#diagStatusModal').classList.add('active');
            sendDiagCommand('status');
        }
        
        // Get Config command
        function sendDiagConfig() {
            lockButton('#btnDiagConfig');
            $('#diagModalTitle').textContent = 'Device Configuration';
            $('#diagJsonContent').textContent = 'Waiting for response...';
            $('#applyConfigFromDiag').style.display = 'none';
            $('#diagStatusModal').classList.add('active');
            sendDiagCommand('config');
        }
        
        // Factory Reset - show confirm modal
        function showFactoryResetModal() {
            $('#factoryResetModal').classList.add('active');
        }
        
        // Factory Reset - execute
        function executeFactoryReset() {
            $('#factoryResetModal').classList.remove('active');
            lockButton('#btnFactoryReset');
            sendDiagCommand('factory_reset');
            showToast('warning', 'Factory Reset', 'Command sent. Device will reboot...');
        }
        
        // Handle diagnostic response
        function handleDiagResponse(payload) {
            clearTimeout(diagTimeout);
            const cmd = diagPendingCommand;
            diagPendingCommand = null;
            
            if (payload.ack === 'pong') {
                // Ping response
                const latency = Date.now() - diagPingStartTime;
                $('#diagLastPing').textContent = `${latency}ms`;
                $('#diagLastPing').className = 'diag-result-value success';
                showToast('success', 'Ping OK', `Latency: ${latency}ms`);
                addLog('diag', `Ping response: ${latency}ms`);
            } else if (payload.ack === 'factory_reset_ok') {
                // Factory reset acknowledged
                showToast('warning', 'Factory Reset', 'Device is resetting...');
                addLog('diag', 'Factory reset acknowledged');
            } else if (cmd === 'status' || cmd === 'config') {
                // Status or Config response - show in modal
                const formattedJson = formatJsonForDisplay(payload);
                $('#diagJsonContent').innerHTML = formattedJson;
                
                // Show "Apply to Config Form" button only for config response
                if (cmd === 'config') {
                    diagConfigData = payload;
                    $('#applyConfigFromDiag').style.display = 'block';
                }
                
                addLog('diag', `${cmd} response received`);
            } else {
                // Unknown response
                const formattedJson = formatJsonForDisplay(payload);
                $('#diagJsonContent').innerHTML = formattedJson;
                addLog('diag', JSON.stringify(payload));
            }
        }
        
        // Format JSON for display with syntax highlighting
        function formatJsonForDisplay(obj, indent = 0) {
            const spaces = '  '.repeat(indent);
            let result = '';
            
            if (Array.isArray(obj)) {
                if (obj.length === 0) return '[]';
                result += '[\n';
                obj.forEach((item, i) => {
                    result += spaces + '  ' + formatJsonForDisplay(item, indent + 1);
                    if (i < obj.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + ']';
            } else if (obj !== null && typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '{}';
                result += '{\n';
                keys.forEach((key, i) => {
                    result += spaces + '  <span class="diag-json-key">"' + escapeHtml(key) + '"</span>: ';
                    result += formatJsonForDisplay(obj[key], indent + 1);
                    if (i < keys.length - 1) result += ',';
                    result += '\n';
                });
                result += spaces + '}';
            } else if (typeof obj === 'string') {
                result += '<span class="diag-json-string">"' + escapeHtml(obj) + '"</span>';
            } else if (typeof obj === 'number') {
                result += '<span class="diag-json-number">' + obj + '</span>';
            } else if (typeof obj === 'boolean') {
                result += '<span class="diag-json-boolean">' + obj + '</span>';
            } else if (obj === null) {
                result += '<span class="diag-json-boolean">null</span>';
            }
            
            return result;
        }
        
        // HTML escape helper
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Apply config from diagnostic response to Config Tab form
        function applyConfigToForm() {
            if (!diagConfigData) {
                showToast('error', 'Error', 'No config data available');
                return;
            }
            
            // Apply speed_map
            if (diagConfigData.speed_map || diagConfigData.speedMap) {
                const speedMap = diagConfigData.speed_map || diagConfigData.speedMap;
                for (let i = 0; i < 6 && i < speedMap.length; i++) {
                    const input = $(`#speedMap${i}`);
                    if (input) input.value = speedMap[i];
                }
            }
            
            // Apply steady_levels
            if (diagConfigData.steady_levels || diagConfigData.steadyLevels) {
                const steadyLevels = diagConfigData.steady_levels || diagConfigData.steadyLevels;
                for (let i = 0; i < steadyLevels.length; i++) {
                    const input = $(`#steadyLevel${i}`);
                    if (input) input.value = steadyLevels[i];
                }
            }
            
            // Apply ema_alpha
            if (diagConfigData.ema_alpha !== undefined || diagConfigData.emaAlpha !== undefined) {
                const emaAlpha = diagConfigData.ema_alpha ?? diagConfigData.emaAlpha;
                const input = $('#emaAlpha');
                if (input) input.value = emaAlpha;
            }
            
            // Apply steady_index
            if (diagConfigData.steady_index !== undefined || diagConfigData.steadyIndex !== undefined) {
                const steadyIndex = diagConfigData.steady_index ?? diagConfigData.steadyIndex;
                const input = $('#steadyIndex');
                if (input) input.value = steadyIndex;
            }
            
            // Close modal and switch to Config tab
            $('#diagStatusModal').classList.remove('active');
            
            // Switch to Config tab
            $$('.nav-item').forEach(item => item.classList.remove('active'));
            $$('.tab-panel').forEach(panel => panel.classList.remove('active'));
            const configNavItem = document.querySelector('[data-tab="tab-config"]');
            if (configNavItem) configNavItem.classList.add('active');
            $('#tab-config').classList.add('active');
            $('#pageTitle').textContent = 'Config';
            
            showToast('success', 'Config Applied', 'Device config loaded to form');
        }
        
        
        // Send config_update command
        function sendConfigCommand(configData, successMsg) {
            if (!mqttClient || !mqttClient.connected) { 
                showToast('warning', 'Not Connected', 'Please connect to MQTT first'); 
                return false; 
            }
            const topic = getTopics().config;
            const payload = { cmd: 'config_update', ...configData };
            mqttClient.publish(topic, JSON.stringify(payload));
            addLog('command', 'Config update: ' + JSON.stringify(configData));
            showToast('success', 'Config Sent', successMsg || 'Configuration sent to device');
            return true;
        }
        
        // Send Fan Settings
        function sendFanConfig() {
            const speedMap = [
                parseInt($('#speedMap0').value) || 0,
                parseInt($('#speedMap1').value) || 20,
                parseInt($('#speedMap2').value) || 40,
                parseInt($('#speedMap3').value) || 60,
                parseInt($('#speedMap4').value) || 80,
                parseInt($('#speedMap5').value) || 100
            ];
            
            const steadyLevels = [
                parseInt($('#steadyLevel0').value) || 20,
                parseInt($('#steadyLevel1').value) || 40,
                parseInt($('#steadyLevel2').value) || 60
            ];
            
            const emaAlpha = parseFloat($('#cfgEmaAlpha').value) || 0.2;
            const pubint = parseInt($('#cfgPubInterval').value) || 30000;
            
            // Validation: Speed Map 0-100
            for (let i = 0; i < speedMap.length; i++) {
                if (speedMap[i] < 0 || speedMap[i] > 100) {
                    showToast('error', 'Invalid Speed Map', `Level ${i} must be between 0 and 100`);
                    return;
                }
            }
            
            // Validation: Steady Levels 0-100
            for (let i = 0; i < steadyLevels.length; i++) {
                const labels = ['Low', 'Mid', 'High'];
                if (steadyLevels[i] < 0 || steadyLevels[i] > 100) {
                    showToast('error', 'Invalid Steady Level', `${labels[i]} must be between 0 and 100`);
                    return;
                }
            }
            
            // Validation: EMA Alpha
            if (emaAlpha < 0.01 || emaAlpha > 0.50) {
                showToast('error', 'Invalid Value', 'EMA Alpha must be between 0.01 and 0.50');
                return;
            }
            
            // Validation: Publish Interval
            if (pubint < 5000 || pubint > 300000) {
                showToast('error', 'Invalid Value', 'Publish Interval must be between 5000 and 300000 ms');
                return;
            }
            
            // Warning: Speed Map values not in ascending order
            let speedMapAscending = true;
            for (let i = 1; i < speedMap.length; i++) {
                if (speedMap[i] < speedMap[i-1]) {
                    speedMapAscending = false;
                    break;
                }
            }
            if (!speedMapAscending) {
                if (!confirm('WARNING: Speed Map values are not in ascending order (L0 < L1 < ... < L5).\n\nThis may cause unexpected fan behavior.\n\nContinue anyway?')) {
                    return;
                }
            }
            
            // Warning: Steady Levels not in ascending order
            let steadyAscending = true;
            for (let i = 1; i < steadyLevels.length; i++) {
                if (steadyLevels[i] < steadyLevels[i-1]) {
                    steadyAscending = false;
                    break;
                }
            }
            if (!steadyAscending) {
                if (!confirm('WARNING: Steady Levels are not in ascending order (Low < Mid < High).\n\nThis may cause unexpected auto-mode behavior.\n\nContinue anyway?')) {
                    return;
                }
            }
            
            // Confirm before sending
            if (!confirm('Apply new fan settings to device?\n\nThis will change fan behavior immediately.')) {
                return;
            }
            
            // Double-click prevention
            lockButton('#btnApplyFanSettings');
            
            sendConfigCommand({
                speed_map: speedMap,
                steady_levels: steadyLevels,
                ema_alpha: emaAlpha,
                pubint: pubint
            }, 'Fan settings sent to device');
        }
        
        // Send Device Identity (will reboot)
        function sendDeviceIdentity() {
            const deviceSerial = $('#cfgDeviceSerial').value.trim();
            const qpSerial = $('#cfgQpSerial').value.trim();
            
            if (!deviceSerial && !qpSerial) {
                showToast('error', 'Missing Data', 'Please enter at least one serial');
                return;
            }
            
            if (!confirm('Device will reboot after applying identity changes. Continue?')) {
                return;
            }
            
            // Double-click prevention
            lockButton('#btnApplyIdentity');
            
            const config = {};
            if (deviceSerial) config.device_serial = deviceSerial;
            if (qpSerial) config.qpser = qpSerial;
            
            sendConfigCommand(config, 'Device identity sent. Device will reboot.');
        }
        
        // Send MQTT Settings (will reboot)
        function sendMqttConfig() {
            const host = $('#cfgMqttHost').value.trim();
            const port = parseInt($('#cfgMqttPort').value) || 8883;
            const tls = $('#cfgMqttTls').checked;
            const user = $('#cfgMqttUser').value.trim();
            const pass = $('#cfgMqttPass').value;
            
            if (!host) {
                showToast('error', 'Missing Data', 'MQTT Host is required');
                return;
            }
            
            if (!confirm('Device will reboot after applying MQTT changes. Continue?')) {
                return;
            }
            
            // Double-click prevention
            lockButton('#btnApplyMqtt');
            
            const config = {
                host: host,
                port: port,
                tls: tls
            };
            if (user) config.user = user;
            if (pass) config.pass = pass;
            
            sendConfigCommand(config, 'MQTT settings sent. Device will reboot.');
        }
        
        // Send OTA Update Command
        function sendOtaUpdate() {
            const url = $('#cfgOtaUrl').value.trim();
            
            if (!url) {
                showToast('error', 'Missing URL', 'Please enter firmware URL');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showToast('error', 'Invalid URL', 'URL must start with http:// or https://');
                return;
            }
            
            if (!url.endsWith('.bin')) {
                showToast('warning', 'URL Warning', 'URL should end with .bin for firmware files');
            }
            
            if (!confirm('Device will download and install new firmware, then reboot. Continue?')) {
                return;
            }
            
            if (!mqttClient || !mqttClient.connected) { 
                showToast('warning', 'Not Connected', 'Please connect to MQTT first'); 
                return; 
            }
            
            // Double-click prevention
            lockButton('#btnStartOta');
            
            const topic = getTopics().config;
            const payload = { cmd: 'ota_update', url: url };
            mqttClient.publish(topic, JSON.stringify(payload));
            addLog('command', 'OTA Update: ' + url);
            showToast('warning', 'OTA Started', 'Firmware download initiated. Device will reboot after update.');
        }
        
        // Export Config to JSON file
        function exportConfig() {
            const config = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                fanSettings: {
                    speedMap: [
                        parseInt($('#speedMap0').value) || 0,
                        parseInt($('#speedMap1').value) || 20,
                        parseInt($('#speedMap2').value) || 40,
                        parseInt($('#speedMap3').value) || 60,
                        parseInt($('#speedMap4').value) || 80,
                        parseInt($('#speedMap5').value) || 100
                    ],
                    steadyLevels: [
                        parseInt($('#steadyLevel0').value) || 20,
                        parseInt($('#steadyLevel1').value) || 40,
                        parseInt($('#steadyLevel2').value) || 60
                    ],
                    emaAlpha: parseFloat($('#cfgEmaAlpha').value) || 0.2,
                    pubInterval: parseInt($('#cfgPubInterval').value) || 30000
                },
                deviceIdentity: {
                    deviceSerial: $('#cfgDeviceSerial').value.trim(),
                    qpSerial: $('#cfgQpSerial').value.trim()
                },
                mqttSettings: {
                    host: $('#cfgMqttHost').value.trim(),
                    port: parseInt($('#cfgMqttPort').value) || 8883,
                    tls: $('#cfgMqttTls').checked,
                    user: $('#cfgMqttUser').value.trim()
                    // Note: Don't export password for security
                }
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `betpp-config-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('success', 'Config Exported', 'Configuration saved to JSON file');
            addLog('system', 'Config exported to JSON');
        }
        
        // Import Config from JSON file
        function importConfig(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Validate version
                    if (!config.version) {
                        showToast('error', 'Invalid File', 'Config file missing version');
                        return;
                    }
                    
                    // Send Fan Settings
                    if (config.fanSettings) {
                        const fs = config.fanSettings;
                        if (fs.speedMap && Array.isArray(fs.speedMap) && fs.speedMap.length === 6) {
                            $('#speedMap0').value = fs.speedMap[0];
                            $('#speedMap1').value = fs.speedMap[1];
                            $('#speedMap2').value = fs.speedMap[2];
                            $('#speedMap3').value = fs.speedMap[3];
                            $('#speedMap4').value = fs.speedMap[4];
                            $('#speedMap5').value = fs.speedMap[5];
                        }
                        if (fs.steadyLevels && Array.isArray(fs.steadyLevels) && fs.steadyLevels.length === 3) {
                            $('#steadyLevel0').value = fs.steadyLevels[0];
                            $('#steadyLevel1').value = fs.steadyLevels[1];
                            $('#steadyLevel2').value = fs.steadyLevels[2];
                        }
                        if (fs.emaAlpha !== undefined) $('#cfgEmaAlpha').value = fs.emaAlpha;
                        if (fs.pubInterval !== undefined) $('#cfgPubInterval').value = fs.pubInterval;
                    }
                    
                    // Populate Device Identity
                    if (config.deviceIdentity) {
                        const di = config.deviceIdentity;
                        if (di.deviceSerial) $('#cfgDeviceSerial').value = di.deviceSerial;
                        if (di.qpSerial) $('#cfgQpSerial').value = di.qpSerial;
                    }
                    
                    // Populate MQTT Settings
                    if (config.mqttSettings) {
                        const ms = config.mqttSettings;
                        if (ms.host) $('#cfgMqttHost').value = ms.host;
                        if (ms.port !== undefined) $('#cfgMqttPort').value = ms.port;
                        if (ms.tls !== undefined) $('#cfgMqttTls').checked = ms.tls;
                        if (ms.user) $('#cfgMqttUser').value = ms.user;
                        // Password not imported for security
                    }
                    
                    showToast('success', 'Config Imported', 'Configuration loaded from file');
                    addLog('system', 'Config imported from JSON');
                    
                } catch (err) {
                    showToast('error', 'Parse Error', 'Invalid JSON file: ' + err.message);
                    addLog('error', 'Config import failed: ' + err.message);
                }
            };
            reader.onerror = () => {
                showToast('error', 'Read Error', 'Failed to read file');
            };
            reader.readAsText(file);
        }
        
        // Populate Config fields from fan/status message
        function populateConfigFromStatus(status) {
            // Speed Map
            const speedMap = status.speed_map ?? status.speedMap;
            if (speedMap && Array.isArray(speedMap) && speedMap.length === 6) {
                $('#speedMap0').value = speedMap[0];
                $('#speedMap1').value = speedMap[1];
                $('#speedMap2').value = speedMap[2];
                $('#speedMap3').value = speedMap[3];
                $('#speedMap4').value = speedMap[4];
                $('#speedMap5').value = speedMap[5];
            }
            
            // Steady Levels
            const steadyLevels = status.steady_levels ?? status.steadyLevels;
            if (steadyLevels && Array.isArray(steadyLevels) && steadyLevels.length === 3) {
                $('#steadyLevel0').value = steadyLevels[0];
                $('#steadyLevel1').value = steadyLevels[1];
                $('#steadyLevel2').value = steadyLevels[2];
            }
            
            // EMA Alpha
            const emaAlpha = status.ema_alpha ?? status.emaAlpha;
            if (emaAlpha !== undefined) {
                $('#cfgEmaAlpha').value = emaAlpha;
            }
            
            // Firmware Version
            const firmware = status.fw_ver ?? status.firmware_version ?? status.firmwareVersion;
            if (firmware) {
                $('#cfgCurrentFirmware').textContent = firmware;
            }
            
            // Device Serial (from connection panel)
            const qpSerial = $('#qpSerial').value;
            if (qpSerial && !$('#cfgQpSerial').value) {
                $('#cfgQpSerial').value = qpSerial;
            }
            
            // Device Client ID
            const clientId = $('#deviceClientId').value;
            if (clientId && !$('#cfgDeviceSerial').value) {
                // Extract serial from client ID if possible (e.g., be-tpp-XXXXXXXXXXXX)
                const match = clientId.match(/be-tpp-([a-f0-9]+)/i);
                if (match) {
                    $('#cfgDeviceSerial').value = match[1];
                }
            }
        }
        
        // Log with color coding
        function addLog(type, message) {
            const viewer = $('#logViewer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const topic = type.toUpperCase();
            
            let topicClass = '';
            switch(type) {
                case 'sensors': topicClass = 'sensors'; break;
                case 'status': topicClass = 'status'; break;
                case 'command': topicClass = 'command'; break;
                case 'error': topicClass = 'error'; break;
                case 'system': topicClass = 'system'; break;
                case 'diag': topicClass = 'diag'; break;
            }
            
            entry.innerHTML = `<span class="log-time">${time}</span><span class="log-topic ${topicClass}">[${topic}]</span><span class="log-message">${message}</span>`;
            viewer.insertBefore(entry, viewer.firstChild);
            while (viewer.children.length > 100) viewer.removeChild(viewer.lastChild);
        }
        
        function saveConfig() { 
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({ 
                brokerUrl: $('#brokerUrl').value, 
                username: $('#mqttUsername').value, 
                qpSerial: $('#qpSerial').value, 
                deviceClientId: $('#deviceClientId').value
            })); 
        }
        
        function loadConfig() { 
            try { 
                const saved = localStorage.getItem(CONFIG.STORAGE_KEY); 
                if (saved) { 
                    const c = JSON.parse(saved); 
                    if (c.brokerUrl) $('#brokerUrl').value = c.brokerUrl; 
                    if (c.username) $('#mqttUsername').value = c.username; 
                    if (c.qpSerial) $('#qpSerial').value = c.qpSerial; 
                    if (c.deviceClientId) $('#deviceClientId').value = c.deviceClientId;
                } 
            } catch (e) {} 
        }
        
        function showToast(type, title, message) {
            const container = $('#toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { 
                success: '<polyline points="20 6 9 17 4 12"/>', 
                warning: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>', 
                error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>', 
                info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>' 
            };
            toast.innerHTML = `<svg class="toast-icon" viewBox="0 0 24 24">${icons[type]}</svg><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
            toast.querySelector('.toast-close').onclick = () => toast.remove();
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
        
        /* ============================================
           Phase B.2: Skeleton Loading Helper
           ============================================ */
        function setSkeletonLoading(isLoading) {
            // Stat value elements that need loading toggle
            const statValueIds = [
                'fanSpeedValue', 'fanModeValue', 'rssiValue', 'uptimeValue',
                'pm25Value', 'co2Value', 'tempValue', 'humidityValue', 
                'pm10Value', 'tvocValue', 'noiseValue'
            ];
            
            // Badge elements
            const badgeIds = ['deviceStatusBadge', 'fanModeBadge'];
            
            // Chart containers
            const chartIds = ['sensorChart', 'fanChart'];
            
            statValueIds.forEach(id => {
                const el = $(`#${id}`);
                if (el && el.parentElement) {
                    if (isLoading) {
                        el.parentElement.classList.add('loading');
                    } else {
                        el.parentElement.classList.remove('loading');
                    }
                }
            });
            
            badgeIds.forEach(id => {
                const el = $(`#${id}`);
                if (el) {
                    if (isLoading) {
                        el.classList.add('loading');
                    } else {
                        el.classList.remove('loading');
                    }
                }
            });
            
            chartIds.forEach(id => {
                const el = $(`#${id}`);
                if (el) {
                    if (isLoading) {
                        el.classList.add('loading');
                    } else {
                        el.classList.remove('loading');
                    }
                }
            });
        }
        
        /* ============================================
           DOM READY
           ============================================ */
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = $('#sidebar');
            const sidebarToggle = $('#sidebarToggle');
            const sidebarOverlay = $('#sidebarOverlay');
            const mobileMenuBtn = $('#mobileMenuBtn');
            
            const isMobile = () => window.innerWidth <= 1024;
            
            // ============================================
            // Landscape Mode Handler
            // Use class-based approach to prevent orientation change bug
            // ============================================
            const isLandscapeMode = () => {
                return window.innerHeight <= 500 && window.innerWidth > window.innerHeight;
            };
            
            let isUpdatingLandscape = false; // Prevent recursive call
            
            // [REMOVED] applyPortraitStyles - not used, clear inline styles instead
            // Let CSS rules work instead of setting inline styles
            
            const updateLandscapeMode = () => {
                if (isUpdatingLandscape) return;
                
                const body = document.body;
                const shouldBeLandscape = isLandscapeMode();
                const isCurrentlyLandscape = body.classList.contains('landscape-mode');
                
                console.log('[Landscape] Check: should=' + shouldBeLandscape + ', is=' + isCurrentlyLandscape);
                
                if (shouldBeLandscape && !isCurrentlyLandscape) {
                    // Enter Landscape Mode
                    body.classList.add('landscape-mode');
                    
                    // Clear inline styles (let CSS .landscape-mode work)
                    const elementsToReset = [
                        '.chart-container', '.bento-grid', '.card', '.bento-card',
                        '.stat-card', '.content', '.header-btn', '.theme-toggle', '.mobile-menu-btn'
                    ];
                    elementsToReset.forEach(selector => {
                        document.querySelectorAll(selector).forEach(el => {
                            el.style.cssText = '';
                        });
                    });
                    
                    console.log('[Landscape] Entered landscape mode');
                    
                } else if (!shouldBeLandscape && isCurrentlyLandscape) {
                    // Exit Landscape Mode
                    isUpdatingLandscape = true;
                    body.classList.remove('landscape-mode');
                    
                    // Clear inline styles (let CSS rules take over)
                    const elementsToReset = [
                        '.chart-container', '.bento-grid', '.card', '.bento-card',
                        '.stat-card', '.content', '.header-btn', '.theme-toggle', '.mobile-menu-btn'
                    ];
                    elementsToReset.forEach(selector => {
                        document.querySelectorAll(selector).forEach(el => {
                            el.style.cssText = '';
                        });
                    });
                    
                    // Disable transitions to prevent flash during theme toggle
                    document.documentElement.classList.add('no-transition');
                    
                    // Trigger actual theme toggle button click twice (toggle then restore)
                    const themeBtn = document.getElementById('themeToggle');
                    if (themeBtn) {
                        themeBtn.click(); // First click: change theme
                        
                        // Use requestAnimationFrame to ensure browser processes first change
                        requestAnimationFrame(() => {
                            themeBtn.click(); // Second click: restore theme
                            
                            // Re-enable transitions after a short delay
                            requestAnimationFrame(() => {
                                document.documentElement.classList.remove('no-transition');
                                
                                setTimeout(() => {
                                    if (window.resizeAllCharts) window.resizeAllCharts();
                                    isUpdatingLandscape = false;
                                    console.log('[Landscape] Exited - no flash');
                                }, 50);
                            });
                        });
                    } else {
                        document.documentElement.classList.remove('no-transition');
                        isUpdatingLandscape = false;
                    }
                }
                
                // Resize charts
                if (shouldBeLandscape !== isCurrentlyLandscape) {
                    setTimeout(() => {
                        if (window.resizeAllCharts) window.resizeAllCharts();
                    }, 200);
                }
            };
            
            // Initial check
            updateLandscapeMode();
            
            // Listen for resize events (includes rotation)
            let landscapeDebounce = null;
            window.addEventListener('resize', () => {
                if (landscapeDebounce) clearTimeout(landscapeDebounce);
                landscapeDebounce = setTimeout(updateLandscapeMode, 100);
            });
            
            // Listen for orientation change (backup)
            window.addEventListener('orientationchange', () => {
                // Delay to wait for dimensions update
                setTimeout(updateLandscapeMode, 150);
            });
            
            // Expose for debugging
            window.checkLandscapeMode = updateLandscapeMode;
            
            // Load collapsed state only for desktop
            if (!isMobile() && localStorage.getItem('betpp_sidebar_collapsed') === 'true') {
                sidebar.classList.add('collapsed');
            }
            
            // Sidebar toggle (desktop only)
            sidebarToggle.onclick = () => {
                sidebar.classList.toggle('collapsed');
                if (!isMobile()) {
                    localStorage.setItem('betpp_sidebar_collapsed', sidebar.classList.contains('collapsed'));
                }
                setTimeout(() => {
                    if (window.resizeAllCharts) window.resizeAllCharts();
                }, 300);
            };
            
            // Mobile menu
            mobileMenuBtn.onclick = () => {
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('active');
            };
            
            sidebarOverlay.onclick = () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            };
            
            // Handle window resize
            let lastWidth = window.innerWidth;
            window.addEventListener('resize', () => {
                const currentWidth = window.innerWidth;
                if (lastWidth <= 1024 && currentWidth > 1024) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                    if (localStorage.getItem('betpp_sidebar_collapsed') === 'true') {
                        sidebar.classList.add('collapsed');
                    }
                }
                if (lastWidth > 1024 && currentWidth <= 1024) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                }
                lastWidth = currentWidth;
            });
            
            // Tabs
            $$('.nav-item[data-tab]').forEach(item => {
                item.onclick = (e) => {
                    e.preventDefault();
                    const tabId = item.dataset.tab;
                    $$('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    $$('.tab-panel').forEach(p => p.classList.remove('active'));
                    $(`#tab-${tabId}`).classList.add('active');
                    $('#pageTitle').textContent = item.querySelector('.nav-label').textContent;
                    
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                    
                    if (tabId === 'overview') {
                        setTimeout(() => {
                            if (window.resizeAllCharts) window.resizeAllCharts();
                        }, 100);
                    }
                    
                    // Phase 11.3: Refresh Monitor grid when tab is opened
                    if (tabId === 'monitor') {
                        renderMonitorGrid();
                        updateMonitorSummary();
                    }
                };
            });
            
            // Theme toggle
            const savedTheme = localStorage.getItem('betpp_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            $('#themeToggle').onclick = () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('betpp_theme', next);
                updateChartsTheme();
            };
            
            loadConfig();
            updateTopicsDisplay();
            initCharts();
            initInternetStatus();  // Phase 7: Initialize internet status monitoring
            initDeviceRegistry();  // Phase 11.1: Initialize device registry
            
            // Phase 11.2: Initialize Device Switcher
            setupDeviceSwitcherEvents();
            updateDeviceSwitcherDisplay();
            updateActiveDeviceBars();
            
            // Phase 11.3: Initialize Monitor Tab
            initMonitorTab();
            
            // Phase 9.3: Sensor Age Badge click handler for tooltip
            const sensorAgeBadge = $('#sensorAgeBadge');
            if (sensorAgeBadge) {
                sensorAgeBadge.onclick = (e) => {
                    e.stopPropagation();
                    sensorAgeBadge.classList.toggle('show-tooltip');
                    updateSensorAgeTooltip();  // Update tooltip when status received
                };
                // Close tooltip when clicking elsewhere
                document.addEventListener('click', () => {
                    sensorAgeBadge.classList.remove('show-tooltip');
                });
            }
            
            // Button handlers
            $('#btnConnect').onclick = connect;
            $('#btnDisconnect').onclick = disconnect;
            
            // Phase 9: Mode Toggle handler
            $('#modeToggle').onclick = () => {
                const toggle = $('#modeToggle');
                const isCustom = toggle.classList.contains('custom');
                const newMode = isCustom ? 'automatic' : 'custom';
                sendMode(newMode);
            };
            
            // Speed buttons
            $$('.speed-btn').forEach(btn => { btn.onclick = () => sendSpeed(parseInt(btn.dataset.speed)); });
            
            // Phase 9: Quick Action handlers
            $$('.quick-action-btn').forEach(btn => {
                btn.onclick = () => {
                    const mode = btn.dataset.mode;
                    const speed = parseInt(btn.dataset.speed);
                    handleQuickAction(mode, speed);
                };
            });
            
            // System
            $('#btnReboot').onclick = () => { if (confirm('Reboot device?')) sendReboot(); };
            // Phase 11.4 UI Polish: Add confirm for Clear buttons
            $('#btnClearLogs').onclick = () => { 
                if (confirm('Clear all MQTT message logs?')) {
                    $('#logViewer').innerHTML = '<div class="log-entry"><span class="log-time">--:--:--</span><span class="log-message">Logs cleared</span></div>'; 
                    showToast('info', 'Cleared', 'MQTT message logs cleared');
                }
            };
            
            // Phase 11.4: Sound Toggle and Warning Log handlers
            $('#soundToggle').onclick = () => {
                initAudioContext(); // Initialize on first click (browser requirement)
                toggleSoundMute();
            };
            // Phase 11.4 UI Polish: Add confirm for Warning Log clear
            $('#btnClearWarningLogs').onclick = () => {
                if (confirm('Clear all warning history?')) {
                    clearWarningLog();
                }
            };
            
            // Initialize sound toggle button state
            const soundBtn = $('#soundToggle');
            if (soundBtn && warningSoundState.isMuted) {
                soundBtn.classList.add('muted');
                soundBtn.title = 'Click to unmute alerts';
            }
            
            // Phase 9.4: Diagnostic Panel buttons
            $('#btnDiagPing').onclick = sendDiagPing;
            $('#btnDiagStatus').onclick = sendDiagStatus;
            $('#btnDiagConfig').onclick = sendDiagConfig;
            $('#btnFactoryReset').onclick = showFactoryResetModal;
            
            // Phase 9.4: Diagnostic Modal buttons
            $('#closeDiagModal').onclick = () => $('#diagStatusModal').classList.remove('active');
            $('#applyConfigFromDiag').onclick = applyConfigToForm;
            
            // Phase 9.4: Factory Reset Modal buttons
            $('#cancelFactoryReset').onclick = () => $('#factoryResetModal').classList.remove('active');
            $('#confirmFactoryReset').onclick = executeFactoryReset;
            
            // Phase 11.2: Update handlers to sync with Device Switcher
            $('#qpSerial').onchange = () => {
                updateTopicsDisplay();
                updateDeviceSwitcherDisplay();
                updateActiveDeviceBars();
                // Save active device selection
                const { qpSerial, clientId } = getActiveDevice();
                localStorage.setItem(ACTIVE_DEVICE_KEY, JSON.stringify({ qpSerial, clientId }));
            };
            $('#deviceClientId').onchange = () => {
                updateTopicsDisplay();
                updateActiveDeviceBars();
                // Save active device selection
                const { qpSerial, clientId } = getActiveDevice();
                localStorage.setItem(ACTIVE_DEVICE_KEY, JSON.stringify({ qpSerial, clientId }));
            };
            
            // Phase 10.5: Config Tab button handlers
            $('#btnApplyFanSettings').onclick = sendFanConfig;
            $('#btnApplyIdentity').onclick = sendDeviceIdentity;
            $('#btnApplyMqtt').onclick = sendMqttConfig;
            $('#btnStartOta').onclick = sendOtaUpdate;
            $('#btnExportConfig').onclick = exportConfig;
            $('#btnImportConfig').onclick = () => $('#importConfigFile').click();
            $('#importConfigFile').onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    importConfig(e.target.files[0]);
                    e.target.value = ''; // Reset file input
                }
            };
            
            // Logout modal
            $('#logoutBtn').onclick = () => $('#logoutModal').classList.add('active');
            $('#cancelLogout').onclick = () => $('#logoutModal').classList.remove('active');
            $('#confirmLogout').onclick = () => { 
                disconnect(); 
                sessionStorage.removeItem('betpp_authenticated'); 
                window.location.href = CONFIG.LOGIN_URL; 
            };
            $('#logoutModal').onclick = (e) => { 
                if (e.target === $('#logoutModal')) $('#logoutModal').classList.remove('active'); 
            };
            
            addLog('system', 'BE-TPP Admin Dashboard initialized');
            showToast('success', 'System Ready', 'Connect to MQTT broker to start');
            
            // B.3: Show empty state on initial load (not connected)
            const emptyState = $('#overviewEmptyState');
            if (emptyState) emptyState.classList.add('show');
            
            // Sensor age update timer
            setInterval(() => {
                if (lastSensorTime) {
                    const age = Math.floor((Date.now() - lastSensorTime) / 1000);
                    $('#sensorAgeValue').textContent = age + 's';
                    if (age > 30) {
                        $('#dataStatusDot').className = 'status-dot';
                        $('#dataStatusText').textContent = 'Stale';
                        $('#sensorStatusBadge').textContent = 'STALE';
                        $('#sensorStatusBadge').className = 'stat-badge offline';
                    }
                }
                // Phase 9.3: Update tooltip values (dashboard age changes every second)
                if (typeof updateSensorAgeTooltip === 'function') {
                    updateSensorAgeTooltip();
                }
            }, 1000);
        });
        
        /* ============================================
           Phase 12: PWA Service Worker Registration
           ============================================ */
        
        // PWA Install Prompt
        let deferredPrompt = null;
        
        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67+ from auto-showing prompt
            e.preventDefault();
            // Stash the event for later
            deferredPrompt = e;
            // Show install button
            const installBtn = $('#pwaInstallBtn');
            if (installBtn) {
                installBtn.classList.add('show');
                console.log('[PWA] Install prompt ready');
            }
        });
        
        // Handle install button click
        document.addEventListener('DOMContentLoaded', () => {
            const installBtn = $('#pwaInstallBtn');
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) {
                        console.log('[PWA] No install prompt available');
                        return;
                    }
                    
                    // Show install prompt
                    deferredPrompt.prompt();
                    
                    // Wait for user choice
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('[PWA] User choice:', outcome);
                    
                    if (outcome === 'accepted') {
                        showToast('success', 'App Installed', 'BE-TPP has been added to your home screen');
                        addLog('system', 'PWA installed to home screen');
                    }
                    
                    // Clear the prompt
                    deferredPrompt = null;
                    installBtn.classList.remove('show');
                });
            }
        });
        
        // Listen for app installed event
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed');
            deferredPrompt = null;
            const installBtn = $('#pwaInstallBtn');
            if (installBtn) installBtn.classList.remove('show');
        });
        
        // PWA Offline Banner - extends existing Internet Status
        function updatePwaOfflineBanner(isOnline) {
            const banner = $('#pwaOfflineBanner');
            if (banner) {
                if (isOnline) {
                    banner.classList.remove('show');
                } else {
                    banner.classList.add('show');
                }
            }
        }
        
        // Hook into existing Internet status change
        const originalHandleInternetStateChange = typeof handleInternetStateChange === 'function' 
            ? handleInternetStateChange 
            : null;
        
        if (originalHandleInternetStateChange) {
            window.handleInternetStateChange = function(online) {
                originalHandleInternetStateChange(online);
                updatePwaOfflineBanner(online);
            };
        }
        
        // Initial offline check
        window.addEventListener('load', () => {
            updatePwaOfflineBanner(navigator.onLine);
        });
        
        // PWA Update Functions
        function showUpdateBanner() {
            const banner = $('#pwaUpdateBanner');
            if (banner) banner.classList.add('show');
        }
        
        function reloadForUpdate() {
            if (navigator.serviceWorker.controller) {
                // Tell SW to skip waiting
                navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
            }
            window.location.reload();
        }
        
        function dismissUpdate() {
            const banner = $('#pwaUpdateBanner');
            if (banner) banner.classList.remove('show');
        }
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('[PWA] New Service Worker installing...');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available - show update banner
                                    console.log('[PWA] New version available');
                                    showUpdateBanner();
                                }
                            });
                        });
                        
                        // Check for updates periodically (every 1 hour)
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                    })
                    .catch(error => {
                        console.log('[PWA] Service Worker registration failed:', error);
                    });
            });
            
            // Handle controller change (new SW activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('[PWA] New Service Worker activated');
            });
        }
    </script>
    
    <!-- Phase 12: PWA Offline Banner -->
    <div class="pwa-offline-banner" id="pwaOfflineBanner">
        <svg viewBox="0 0 24 24">
            <line x1="1" y1="1" x2="23" y2="23"/>
            <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/>
            <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/>
            <path d="M10.71 5.05A16 16 0 0 1 22.58 9"/>
            <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/>
            <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
            <line x1="12" y1="20" x2="12.01" y2="20"/>
        </svg>
        <span>You are offline. Some features may be limited.</span>
    </div>
    
    <!-- Phase 12: PWA Update Banner -->
    <div class="pwa-update-banner" id="pwaUpdateBanner">
        <div class="pwa-update-banner-content">
            <div class="pwa-update-banner-title">Update Available</div>
            <div>A new version of BE-TPP is ready.</div>
            <div class="pwa-update-banner-actions">
                <button class="btn btn-primary" onclick="reloadForUpdate()">Update Now</button>
                <button class="btn btn-ghost" onclick="dismissUpdate()">Later</button>
            </div>
        </div>
    </div>
</body>
</html>
